<!DOCTYPE html>
<html lang="zh-CN">

<!-- Head tag -->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">

  <!--Description-->
  

  <!--Author-->
  
  <meta name="author" content="Icean L">
  

  <!--Open Graph Title-->
  
      <meta property="og:title" content="CentOS 6.x/7.x Strongswan 5.5.0编译安装 + Freeradius验证"/>
  
  <!--Open Graph Description-->
  
  <!--Open Graph Site Name-->
  <meta property="og:site_name" content="Kompass"/>
  <!--Type page-->
  
      <meta property="og:type" content="article" />
  
  <!--Page Cover-->
  

  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <!-- Title -->
  
  <title>CentOS 6.x/7.x Strongswan 5.5.0编译安装 + Freeradius验证 - Kompass</title>


  <link rel="shortcut icon" href="/">

  <!-- Custom CSS/Sass -->
  <link rel="stylesheet" href="/css/style.css">

  <!----------------------------
  https://github.com/GallenHu/hexo-theme-Daily

 _____            _   _
|  __ \          (_) | |
| |  | |   __ _   _  | |  _   _
| |  | |  / _` | | | | | | | | |
| |__| | | (_| | | | | | | |_| |
|_____/   \__,_| |_| |_|  \__, |
                          __/ |
                         |___/

    --------------------------->

</head>


<body>

  <!-- Nav -->
  <header class="site-header">
  <div class="header-inside">
    <div class="logo">
      <a href="/" rel="home">
        
        <img src="http://qingdao.icean.cc:11234/Imgbed/logo.png" alt="Kompass" height="60">
        
      </a>
    </div>
    <!-- Navigation -->
    <nav class="navbar">
      <!-- Collect the nav links, forms, and other content for toggling -->
      <div class="collapse">
        <ul class="navbar-nav">
          
          
            <li>
              <a href="/.">
                
                  主页
                
              </a>
            </li>
          
            <li>
              <a href="/archives">
                
                  归档
                
              </a>
            </li>
          
            <li>
              <a href="/about">
                
                  关于
                
              </a>
            </li>
          
        </ul>
      </div>
      <!-- /.navbar-collapse -->
    </nav>
    <div class="button-wrap">
      <button class="menu-toggle">Primary Menu</button>
    </div>
  </div>
</header>


  <!-- Main Content -->
  <div class="content-area">
  <div class="post">
    <!-- Post Content -->
    <div class="container">
      <article>
        <!-- Title date & tags -->
        <div class="post-header">
          <h1 class="entry-title">
            CentOS 6.x/7.x Strongswan 5.5.0编译安装 + Freeradius验证
            
          </h1>
          <p class="posted-on">
          2017-01-26
          </p>
          <div class="tags-links">
            
              
                <a href="/tags/linux/" rel="tag">
                  linux
                </a>
              
                <a href="/tags/Strongswan/" rel="tag">
                  Strongswan
                </a>
              
                <a href="/tags/VPN/" rel="tag">
                  VPN
                </a>
              
            
          </div>
        </div>
        <!-- Post Main Content -->
        <div class="entry-content">
          <h3 id="1-编译安装Strongswan"><a href="#1-编译安装Strongswan" class="headerlink" title="1. 编译安装Strongswan"></a>1. 编译安装Strongswan</h3><h4 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h4><p>需要安装如下依赖<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">yum -y install pam-devel</div></pre></td></tr></table></figure></p>
<p>可能还需要安装如下依赖</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">yum install -y openssl-devel make gcc curl wget</div></pre></td></tr></table></figure>
<h4 id="下载源码"><a href="#下载源码" class="headerlink" title="下载源码"></a>下载源码</h4><p>从<a href="https://www.strongswan.org/" target="_blank" rel="external">Strongswan</a>官网下载最新Strongswan 5.5.1源码到并解压</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">wget https://download.strongswan.org/strongswan-5.5.1.tar.gz</div><div class="line">tar xvf strongswan-5.5.1.tar.gz</div></pre></td></tr></table></figure>
<h4 id="编译安装"><a href="#编译安装" class="headerlink" title="编译安装"></a>编译安装</h4><p>切换到Strongswan源码解压的目录，执行配置与编译安装<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">cd</span> strongswan-5.5.1</div><div class="line">./configure  --enable-eap-identity --enable-eap-md5 --enable-eap-mschapv2 --enable-eap-tls \</div><div class="line">--enable-eap-ttls --enable-eap-peap --enable-eap-tnc --enable-eap-dynamic --enable-eap-radius \</div><div class="line">--enable-xauth-eap --enable-xauth-pam  --enable-dhcp  --enable-openssl  --enable-addrblock --enable-unity  \</div><div class="line">--enable-certexpire --enable-radattr --enable-swanctl --enable-openssl --disable-gmp --enable-farp \</div><div class="line">--enable-kernel-libipsec  <span class="comment">#如果主机为OpenVZ则需要添加这个模块</span></div><div class="line">make &amp;&amp; make install</div></pre></td></tr></table></figure></p>
<p>根据主机性能，完成上述编译安装需要的时间不同。安装完成后，可执行文件的路径为/usr/local/sbin, 配置文件路径为/usr/local/etc，配置文件以及文件夹主要如下</p>
<ul>
<li>ipsec.conf              </li>
<li>ipsec.secrets</li>
<li><strong>ipsec.d</strong></li>
<li>strongswan.conf</li>
<li><strong>strongswan.d</strong></li>
<li><strong>swanctl</strong></li>
</ul>
<hr>
<h3 id="2-证书配置"><a href="#2-证书配置" class="headerlink" title="2. 证书配置"></a>2. 证书配置</h3><h4 id="Let’s-Encrypt免费服务器证书"><a href="#Let’s-Encrypt免费服务器证书" class="headerlink" title="Let’s Encrypt免费服务器证书"></a>Let’s Encrypt免费服务器证书</h4><p>Let’s Encrypt是免费、自动化、开放的证书签发服务。它由 ISRG（Internet Security Research Group，互联网安全研究小组）提供服务，而 ISRG 是来自于美国加利福尼亚州的一个公益组织。Let’s Encrypt 得到了 Mozilla、Cisco、Akamai、Electronic Frontier Foundation 和 Chrome 等众多公司和机构的支持。申请 Let’s Encrypt 证书免费，每次只有 90 天的有效期，但可以通过脚本定期更新。</p>
<h5 id="生成证书"><a href="#生成证书" class="headerlink" title="生成证书"></a>生成证书</h5><p>下载Let’s Encrypt并执行生成证书。在执行过程中，会下载一些依赖，同时在提示输入域名的时候，要和主机的域名一致。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">git <span class="built_in">clone</span> https://github.com/letsencrypt/letsencrypt</div><div class="line"><span class="built_in">cd</span> letsencrypt</div><div class="line">./letsencrypt-auto certonly --standalone</div></pre></td></tr></table></figure></p>
<h5 id="安装证书"><a href="#安装证书" class="headerlink" title="安装证书"></a>安装证书</h5><p>生成的证书和证书私钥位于 <code>/etc/letsencrypt/live/your.domain/</code> 目录下，如下所示，所有文件均是软链接，其原始文件后的数字为证书生成的次数，首次生成为1，每续期一次，数字加一，下面的为续期了两次的证书。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">lrwxrwxrwx 1 root root 36 Dec  3 09:30 cert.pem -&gt; ../../archive/[域名]/cert3.pem</div><div class="line">lrwxrwxrwx 1 root root 37 Dec  3 09:30 chain.pem -&gt; ../../archive/[域名]/chain3.pem</div><div class="line">lrwxrwxrwx 1 root root 41 Dec  3 09:30 fullchain.pem -&gt; ../../archive/[域名]/fullchain3.pem</div><div class="line">lrwxrwxrwx 1 root root 39 Dec  3 09:30 privkey.pem -&gt; ../../archive/[域名]/privkey3.pem</div></pre></td></tr></table></figure>
<p>建立软链到 strongSwan 配置目录下，这样是为了方便证书续期也不用修改配置文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">ln <span class="_">-s</span> /etc/letsencrypt/live/your.domain/fullchain.pem /etc/ipsec.d/certs/server.cert.pem</div><div class="line">ln <span class="_">-s</span> /etc/letsencrypt/live/your.domain/privkey.pem /etc/ipsec.d/private/server.key.pem</div></pre></td></tr></table></figure>
<h5 id="证书自动续期"><a href="#证书自动续期" class="headerlink" title="证书自动续期"></a>证书自动续期</h5><p>letsencrypt证书需要每三个月进行续期一次证书，续期命令如下，每隔两个月的4号进行一次证书续期</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">crontab <span class="_">-e</span></div><div class="line"> * * 4 */2 * /root/letsencrypt/letsencrypt-auto  --renew-by-default  certonly --standalone <span class="_">-d</span> [域名] --email [邮箱]  --agree-tos</div></pre></td></tr></table></figure>
<h4 id="自签名CA颁发服务器证书"><a href="#自签名CA颁发服务器证书" class="headerlink" title="自签名CA颁发服务器证书"></a>自签名CA颁发服务器证书</h4><h5 id="CA证书"><a href="#CA证书" class="headerlink" title="CA证书"></a>CA证书</h5><p>生成一个CA私钥</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ipsec pki --gen --outform pem &gt; ca.key.pem</div></pre></td></tr></table></figure>
<p>基于私钥生成一个CA证书<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ipsec pki --self --in ca.key.pem --dn <span class="string">"C=CN, O=Strongswan, CN=Strongswan CA"</span> --ca --lifetime 3650 --outform pem &gt; ca.cert.pem</div></pre></td></tr></table></figure></p>
<ul>
<li>–self 表示自签证书</li>
<li>–in 是输入的私钥</li>
<li>–dn 是判别名</li>
<li>C 表示国家名，同样还有 ST 州/省名，L 地区名，STREET（全大写） 街道名</li>
<li>O 组织名称</li>
<li>CN 友好显示的通用名</li>
<li>–ca 表示生成 CA 根证书</li>
<li>–lifetime 为有效期, 单位是天</li>
</ul>
<h5 id="服务器证书"><a href="#服务器证书" class="headerlink" title="服务器证书"></a>服务器证书</h5><p>生成服务器证书的私钥<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ipsec pki --gen --outform pem &gt; server.key.pem</div></pre></td></tr></table></figure></p>
<p>用自签的 CA 证书签发一个服务器证书<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">ipsec pki --pub --in server.key.pem --outform pem &gt; server.pub.pem</div><div class="line">ipsec pki --issue --lifetime 1200 --cacert ca.cert.pem --cakey ca.key.pem --in server.pub.pem \</div><div class="line">--dn <span class="string">"C=CN, O=Strongswan, CN=vpn.strongswan.org"</span> --san=<span class="string">"vpn.strongswan.org"</span> --flag serverAuth \</div><div class="line">--flag ikeIntermediate --outform pem &gt; server.cert.pem</div></pre></td></tr></table></figure></p>
<p>–issue, –cacert 和–cakey 就是表明要用刚才自签的 CA 证书来签这个服务器证书，–dn, –san，–flag 是一些客户端方面的特殊要求：</p>
<ul>
<li>iOS 客户端要求 CN 也就是通用名必须是服务器的 URL 或 IP 地址;</li>
<li>Windows 7 或者更高版本不但要求了上面，还要求必须显式说明这个服务器证书的用途（用于与服务器进行认证），–flag serverAuth;</li>
<li>非 iOS 的 Mac OS X 要求了“IP 安全网络密钥互换居间（IP Security IKE Intermediate）”这种增强型密钥用法（EKU），–flag ikdeIntermediate;</li>
<li>Android 和 iOS 都要求服务器别名（serverAltName）就是服务器的 URL 或 IP 地址，即是–san，同时Windows 7不能添加额外的服务器别名，Windows 10可以添加</li>
</ul>
<p><span style="color:red"><strong>*</strong></span>为了兼容Windows 7，只添加一个服务器别名（serverAltName）</p>
<h5 id="客户端证书（可选）"><a href="#客户端证书（可选）" class="headerlink" title="客户端证书（可选）"></a>客户端证书（可选）</h5><p>生成客户端私钥<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ipsec pki --gen --outform pem &gt; client.key.pem</div></pre></td></tr></table></figure></p>
<p>用自签的CA证书来签发客户端证书<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">ipsec pki --pub --in client.key.pem --outform pem &gt; client.pub.pem</div><div class="line">ipsec pki --issue --lifetime 1200 --cacert ca.cert.pem --cakey ca.key.pem --in client.pub.pem \</div><div class="line">--dn <span class="string">"C=CN, O=Strongswan, CN=vpn.strongswan.org"</span> --outform pem &gt; client.cert.pem</div></pre></td></tr></table></figure></p>
<p>打包证书为 p12，生成 p12 证书可以设置密码，<span style="color:red"><strong>*</strong></span>OS X 无法导入密码为空的 p12 证书<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">openssl pkcs12 -export -inkey client.key.pem -in client.cert.pem -name <span class="string">"Strongswan Client Cert"</span> \</div><div class="line">-certfile ca.cert.pem -caname <span class="string">"Strongswan CA"</span> -out client.cert.p12</div></pre></td></tr></table></figure></p>
<h5 id="安装证书-1"><a href="#安装证书-1" class="headerlink" title="安装证书"></a>安装证书</h5><p>复制证书到指定的路径<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">cp ca.key.pem /usr/<span class="built_in">local</span>/etc/ipsec.d/private/</div><div class="line">cp client.key.pem /usr/<span class="built_in">local</span>/etc/ipsec.d/private/</div><div class="line">cp server.key.pem /usr/<span class="built_in">local</span>/etc/ipsec.d/private/</div><div class="line">cp server.cert.pem /usr/<span class="built_in">local</span>/etc/ipsec.d/certs/</div><div class="line">cp client.cert.pem /usr/<span class="built_in">local</span>/etc/ipsec.d/certs/</div><div class="line">cp ca.cert.pem /usr/<span class="built_in">local</span>/etc/ipsec.d/cacerts/</div></pre></td></tr></table></figure></p>
<hr>
<h3 id="3-Strongswan配置"><a href="#3-Strongswan配置" class="headerlink" title="3. Strongswan配置"></a>3. Strongswan配置</h3><h4 id="ipsec-conf配置"><a href="#ipsec-conf配置" class="headerlink" title="ipsec.conf配置"></a>ipsec.conf配置</h4><p>支持IPsec和ikev2的配置如下所示， 常用设置如下<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">cachecrls = yes					<span class="comment">#是否缓存证书吊销列表</span></div><div class="line">strictcrlpolicy=yes				    <span class="comment">#是否严格执行证书吊销规则</span></div><div class="line">uniqueids=no				    <span class="comment">#如果同一个用户在不同的设备上重复登录,yes 断开旧连接,创建新连接;no 保持旧</span></div><div class="line">  							   <span class="comment">#连接,并发送通知; never 同 no, 但不发送通知.</span></div><div class="line">ca %default					     <span class="comment">#配置根证书, 如果不使用证书吊销列表, 可以不用这段. 命名为 %default 所有配置</span></div><div class="line">  							   <span class="comment">#节都会继承它</span></div><div class="line">crl =						    <span class="comment">#证书吊销列表URL,可以是 LDAP, http, 或文件路径</span></div><div class="line">conn %default				     <span class="comment">#定义连接项, 命名为 %default 所有连接都会继承它</span></div><div class="line">compress = yes				     <span class="comment">#是否启用压缩, yes 表示如果支持压缩会启用.</span></div><div class="line">dpdaction = hold			       <span class="comment">#当意外断开后尝试的操作, hold, 保持并重连直到超时.</span></div><div class="line">dpddelay = 30s				      <span class="comment">#意外断开后尝试重连时长</span></div><div class="line">dpdtimeout = 60s			      <span class="comment">#意外断开后超时时长, 只对 IKEv1 起作用</span></div><div class="line">inactivity = 300s				   <span class="comment">#闲置时长,超过后断开连接.</span></div><div class="line">esp = aes256-sha256,aes256-sha1,3des-sha1!	</div><div class="line">  							   <span class="comment">#数据传输协议加密算法列表</span></div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">ike = aes256-sha1-modp1024,aes128-sha1-modp1024,3des-sha1-modp1024!</div><div class="line">  							   <span class="comment">#密钥交换协议加密算法列表</span></div><div class="line">							 <span class="comment">#iOS支持的IKE加密方式为aes256-sha256-modp1024</span></div><div class="line">  							   <span class="comment">#OS X为3des-sha1-modp1024</span></div><div class="line">  							   <span class="comment">#Win7为aes256-sha1-modp1024，</span></div><div class="line">keyexchange = ike			       <span class="comment">#默认的密钥交换算法, ike 为自动, 优先使用 IKEv2</span></div><div class="line">left = %any					      <span class="comment">#服务端公网IP, 可以是魔术字 %any，表示从本地IP地址表中取.</span></div><div class="line">right = %any				      <span class="comment">#客户端IP, 同上</span></div><div class="line">leftdns = 8.8.8.8,8.8.4.4			<span class="comment">#指定服务端与客户端的dns, 多个用","分隔</span></div><div class="line">rightdns = 8.8.8.8,8.8.4.4			<span class="comment">#指定服务端与客户端的dns, 多个用","分隔</span></div><div class="line">leftikeport = &lt;port&gt;			  <span class="comment">#服务端用于ike认证时使用的端口, 默认为500,如果使用了nat 转发, 则使用4500</span></div><div class="line">leftsourceip = %config			   <span class="comment">#服务器端虚拟IP地址</span></div><div class="line">rightsourceip = 10.0.0.0/24		       <span class="comment">#客户端虚拟IP段</span></div><div class="line">leftsubnet = 0.0.0.0/0		              <span class="comment">#服务器端子网, 魔术字 0.0.0.0/0. 如果为客户端分配虚拟 IP 地址的话，那表示之</span></div><div class="line">  							    <span class="comment">#后要做 iptables 转发，那么服务器端就必须是用魔术字</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">leftca = ca.cert.pem 			    <span class="comment">#服务器端根证书</span></div><div class="line">leftcert = server.cert.pem		       <span class="comment">#服务器证书, 可以是 PEM 或 DER 格式</span></div><div class="line">rightcert = &lt;path&gt;				<span class="comment">#不指定客户端证书路径</span></div><div class="line">leftsigkey = server.pub.pem		     <span class="comment">#指定服务器证书的公钥</span></div><div class="line">leftsendcert = always			   <span class="comment">#是否发送服务器证书到客户端</span></div><div class="line">rightsendcert = never			  <span class="comment">#客户端不发送证书</span></div><div class="line">leftauth = pubkey	                         <span class="comment">#服务端认证方法,使用证书</span></div><div class="line">rightauth = eap-mschapv2	         <span class="comment">#客户端认证使用 EAP 扩展认证 , 貌似 eap-mschapv2 比较通用</span></div><div class="line">leftid = vpn.strongswan.com	            <span class="comment">#服务端id, 可以任意指定, 默认为服务器证书的 subject, 还可以是魔术字 %any，</span></div><div class="line">  							  <span class="comment">#表示什么都行.</span></div><div class="line">rightid = %any				      <span class="comment">#客户端id, 任意</span></div><div class="line">eap_identity = %any		                <span class="comment">#指定客户端eap id</span></div><div class="line">rekey = no					    <span class="comment">#不自动重置密钥</span></div><div class="line">fragmentation = yes		        	<span class="comment">#开启IKE 消息分片</span></div><div class="line">auto = add					   <span class="comment">#当服务启动时, 应该如何处理这个连接项. add 添加到连接表中.</span></div></pre></td></tr></table></figure>
<p>本文使用的配置<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">config setup</div><div class="line">    uniqueids = no</div><div class="line">    </div><div class="line">conn %default</div><div class="line">    compress = yes</div><div class="line">    keyingtries = 1</div><div class="line">    keyexchange = ike</div></pre></td></tr></table></figure></p>
<p>IKE基础配置</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">conn IKE-BASE</div><div class="line">    <span class="comment">#leftca = ca.cert.pem                      #使用Let's Encript免费证书的时候注释这句</span></div><div class="line">    leftcert = server.cert.pem                   </div><div class="line">    left = %defaultroute                        <span class="comment">#可以将所有流量都发送到VPN网关</span></div><div class="line">    leftsubnet = 0.0.0.0/0</div><div class="line">    right = %any</div><div class="line">    rightsourceip = 192.168.90.0/24   <span class="comment">#客户端接入分配的私有IP地址空间</span></div></pre></td></tr></table></figure>
<p>IKEv1配置<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">conn IPSec-IKEv1-PSK</div><div class="line">    also = IKE-BASE</div><div class="line">    keyexchange = ikev1</div><div class="line">    fragmentation = yes</div><div class="line">    leftauth = psk</div><div class="line">    rightauth = psk</div><div class="line">    rightauth2 = xauth-radius</div><div class="line">    auto = add</div><div class="line">    </div><div class="line">conn IPSec-IKEv1</div><div class="line">    also = IKE-BASE</div><div class="line">    keyexchange = ikev1</div><div class="line">    fragmentation = yes</div><div class="line">    leftauth = pubkey</div><div class="line">    rightauth = pubkey</div><div class="line">    rightcert = client.cert.pem</div><div class="line">    auto = add</div></pre></td></tr></table></figure></p>
<p>IKEv2面向Linux、Android、Windows配置<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">conn IKEv2-LAW</div><div class="line">    also = IKE-BASE</div><div class="line">    keyexchange = ikev2</div><div class="line">    keyingtries = 1 </div><div class="line">    ike = aes256-sha1-modp1024</div><div class="line">    esp = aes256-sha1</div><div class="line">    leftauth = pubkey</div><div class="line">    leftsendcert = always</div><div class="line">    rightauth = eap-radius</div><div class="line">    rekey = no</div><div class="line">    eap_identity = %identity</div><div class="line">    auto = add</div></pre></td></tr></table></figure></p>
<p>IKEv2面向iOS、MAC OS X配置，<span style="color:red">*</span><code>leftid</code>需要和服务器URL或者IP地址一致，否则无法登录。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">conn IKEv2-Apple</div><div class="line">    also = IKE-BASE</div><div class="line">    keyexchange = ikev2</div><div class="line">    keyingtries = 1 </div><div class="line">    ike = aes256-sha256-modp1024</div><div class="line">    esp = aes256-sha256</div><div class="line">    leftid =  vpn.strongswan.com </div><div class="line">    leftauth = pubkey</div><div class="line">    leftsendcert = always</div><div class="line">    rightauth = eap-radius</div><div class="line">    rightsendcert = never</div><div class="line">    fragmentation = yes </div><div class="line">    rekey = yes</div><div class="line">    eap_identity = %identity</div><div class="line">    auto = add</div></pre></td></tr></table></figure></p>
<h4 id="日志配置"><a href="#日志配置" class="headerlink" title="日志配置"></a>日志配置</h4><p>修改/usr/local/etc/strongswan.conf，修改为如下，其中filelog选项可以调节等级</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">charon &#123;</div><div class="line">    load_modular = yes </div><div class="line">    filelog &#123;</div><div class="line">        /var/<span class="built_in">log</span>/charon.log &#123;</div><div class="line">            time_format = %b %e %T</div><div class="line">            ike_name = yes </div><div class="line">            append = no</div><div class="line">            default = 2 </div><div class="line">            flush_line = yes </div><div class="line">        &#125;   </div><div class="line">        stderr &#123;</div><div class="line">            ike = 2 </div><div class="line">            knl = 3 </div><div class="line">        &#125;                                                                                                                                                            </div><div class="line">    &#125;   </div><div class="line">    syslog &#123;</div><div class="line">        identifier = charon-custom</div><div class="line">        daemon &#123;</div><div class="line">        &#125;   </div><div class="line">        auth &#123;</div><div class="line">            default = -1</div><div class="line">            ike = 0 </div><div class="line">        &#125;   </div><div class="line">    &#125;                                                                                                                                                </div><div class="line">    plugins &#123;</div><div class="line">        include strongswan.d/charon/*.conf</div><div class="line">    &#125;   </div><div class="line">&#125;</div><div class="line">include strongswan.d/*.conf</div></pre></td></tr></table></figure>
<h4 id="ipsec-secrets设置"><a href="#ipsec-secrets设置" class="headerlink" title="ipsec.secrets设置"></a>ipsec.secrets设置</h4><p>配置验证方式的用户名与密码，<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">: RSA server.key.pem 		<span class="comment">#使用证书验证时的服务器端私钥</span></div><div class="line">: PSK <span class="string">"pskkey"</span>                           <span class="comment">#使用预设加密密钥, 越长越好</span></div><div class="line">: XAUTH <span class="string">"pskkey"</span>		     <span class="comment">#使用XAUTH预设加密密钥, 越长越好</span></div><div class="line"><span class="built_in">test</span> : EAP <span class="string">"test"</span>		          <span class="comment">#验证的账户和密码，如果配置了RADIUS ，账户密码无法进行有效验证</span></div><div class="line"><span class="built_in">test</span>2 : XAUTH <span class="string">"test2"</span></div></pre></td></tr></table></figure></p>
<p><span style="color:red"><strong>*</strong></span>PSK和XAUTH可以设置一样，这样可以避免已配置的麻烦，同时共享密钥中不能有符号等，否则登录不成功。</p>
<h4 id="DNS设置"><a href="#DNS设置" class="headerlink" title="DNS设置"></a>DNS设置</h4><p>修改/usr/local/etc/strongswan.d/charon.conf，添加DNS服务器，修改其中的dns1=8.8.8.8。</p>
<h4 id="Freeradius-服务器设置"><a href="#Freeradius-服务器设置" class="headerlink" title="Freeradius 服务器设置"></a>Freeradius 服务器设置</h4><p>修改/usr/local/etc/strongswan.d/charon/eap-radius .conf，设置accounting改为yes，并添加servers中添加Freeradius 服务器。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">accounting = yes</div><div class="line">servers &#123;</div><div class="line">  RadiusServer &#123;</div><div class="line">       secret = testing1234        <span class="comment">#与Freeradius 服务器的暗码</span></div><div class="line">       address = 1.2.3.4              <span class="comment">#Freeradius 服务器IP地址</span></div><div class="line">       auth_port = 1812             <span class="comment">#验证端口</span></div><div class="line">       acct_port = 1813              <span class="comment">#记账端口</span></div><div class="line">               &#125;</div><div class="line">       &#125;</div></pre></td></tr></table></figure></p>
<h4 id="iptables设置"><a href="#iptables设置" class="headerlink" title="iptables设置"></a>iptables设置</h4><p>转发/usr/local/etc/ipsec.conf中设置的虚拟IP地址段，其中x.x.x.x为主机的公网IP地址<br>OpenVZ如下<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">iptables -t nat -A POSTROUTING <span class="_">-s</span> 192.168.90.0/24 -o venet0 -j SNAT --to-source x.x.x.x</div><div class="line">iptables -I FORWARD 4 <span class="_">-s</span> 192.168.90.0/24 -j ACCEPT</div></pre></td></tr></table></figure></p>
<p>KVM如下，eth0为公网IP所在的网卡。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">iptables -t nat -A POSTROUTING <span class="_">-s</span> 192.168.90.0/24 -o eth0 -j MASQUERADE</div></pre></td></tr></table></figure></p>
<p>开放UDP的500和4500端口，删除转发表所有拒绝的条目，保存并重启iptables服务<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">iptables -A INPUT -p udp -m udp --dport 4500 -j ACCEPT</div><div class="line">iptables -A INPUT -p udp -m udp --dport 500 -j ACCEPT  </div><div class="line">iptables -D FORWARD 1</div><div class="line">service iptables save</div><div class="line">service iptables restart</div></pre></td></tr></table></figure></p>
<hr>
<h3 id="4-服务启动"><a href="#4-服务启动" class="headerlink" title="4. 服务启动"></a>4. 服务启动</h3><p>启动Strongswan服务<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/usr/<span class="built_in">local</span>/ipsec start</div></pre></td></tr></table></figure></p>
<hr>
<h3 id="5-IKEv2-VPN配置"><a href="#5-IKEv2-VPN配置" class="headerlink" title="5. IKEv2 VPN配置"></a>5. IKEv2 VPN配置</h3><h4 id="iOS"><a href="#iOS" class="headerlink" title="iOS"></a>iOS</h4><h5 id="系统版本要求"><a href="#系统版本要求" class="headerlink" title="系统版本要求"></a>系统版本要求</h5><p><span style="color:red">iOS 9</span>或者更高版本</p>
<h5 id="证书导入"><a href="#证书导入" class="headerlink" title="证书导入"></a>证书导入</h5><ul>
<li>通过<strong>邮件</strong>发送或者<strong>Safari浏览器</strong><a href="https://letsencrypt.org/certs/lets-encrypt-x3-cross-signed.pem" target="_blank" rel="external">下载</a>CA证书到iOS设备</li>
<li>安装证书到设备</li>
<li>输入iOS密码</li>
</ul>
<h5 id="VPN设置"><a href="#VPN设置" class="headerlink" title="VPN设置"></a>VPN设置</h5><ul>
<li>配置位置: <strong>设置 -&gt; VPN -&gt; 添加配置</strong></li>
<li>类型: IKEv2</li>
<li>描述: 任意</li>
<li>用户鉴定: 用户名</li>
<li>服务器: VPN服务器URL或者IP地址</li>
<li>用户名: Freeradius服务器配置</li>
<li>密码: Freeradius服务器配置</li>
<li>远程ID: VPN远程ID</li>
<li>本地ID: 留空</li>
</ul>
<h4 id="OS-X"><a href="#OS-X" class="headerlink" title="OS X"></a>OS X</h4><h5 id="系统版本要求-1"><a href="#系统版本要求-1" class="headerlink" title="系统版本要求"></a>系统版本要求</h5><p><span style="color:red">OS X 10.11 (“El Capitan”)</span>或者更高版本</p>
<h5 id="证书导入-1"><a href="#证书导入-1" class="headerlink" title="证书导入"></a>证书导入</h5><ul>
<li>下载CA证书到本地</li>
<li>配置位置: <strong>钥匙串访问 -&gt; 钥匙串 -&gt; 系统</strong></li>
<li>选择要添加的证书文件</li>
<li>导入证书</li>
</ul>
<h5 id="VPN设置-1"><a href="#VPN设置-1" class="headerlink" title="VPN设置"></a>VPN设置</h5><ul>
<li>配置位置: <strong>系统偏好设置 -&gt; 网络 -&gt;添加网络连接</strong></li>
<li>接口: VPN</li>
<li>VPN类型: IKEv2</li>
<li>服务名称: 任意</li>
<li>服务器: VPN服务器URL或者IP地址</li>
<li>远程ID: VPN远程ID</li>
<li>本地ID: 留空</li>
<li>鉴定设置 -&gt; 用户名: Freeradius服务器配置</li>
<li>鉴定设置 -&gt; 密码: Freeradius服务器配置</li>
</ul>
<h4 id="Android"><a href="#Android" class="headerlink" title="Android"></a>Android</h4><h5 id="系统版本要求-2"><a href="#系统版本要求-2" class="headerlink" title="系统版本要求"></a>系统版本要求</h5><p><span style="color:red">Android 4</span>或者更高版本，需要安装<a href="http://pan.baidu.com/s/1gfkEXKB" target="_blank" rel="external">Strongswan客户端</a></p>
<h5 id="证书导入-2"><a href="#证书导入-2" class="headerlink" title="证书导入"></a>证书导入</h5><ul>
<li>下载CA证书到本地</li>
<li>配置位置：<strong>CA certificates -&gt; Import certificates</strong></li>
<li>从文件系统选择证书文件</li>
<li>确认导入证书</li>
</ul>
<h5 id="VPN设置-2"><a href="#VPN设置-2" class="headerlink" title="VPN设置"></a>VPN设置</h5><ul>
<li>配置位置：<strong>ADD VPN PROFILE</strong></li>
<li>服务器: VPN服务器URL或者IP地址</li>
<li>VPN类型: IKEv2 EAP</li>
<li>用户名: Freeradius服务器配置</li>
<li>密码: Freeradius服务器配置</li>
</ul>
<h4 id="Windows"><a href="#Windows" class="headerlink" title="Windows"></a>Windows</h4><h5 id="系统版本要求-3"><a href="#系统版本要求-3" class="headerlink" title="系统版本要求"></a>系统版本要求</h5><p><span style="color:red">Win 7</span>或者更高版本</p>
<h5 id="证书导入-3"><a href="#证书导入-3" class="headerlink" title="证书导入"></a>证书导入</h5><p>windows使用IKEv2 VPN需要导入服务器证书到<strong>信任根证书颁发机构。如果服务器使用的是</strong>自签名CA<strong>颁发的证书，需要导入的CA证书为之前创建的ca.cert.pem。若使用</strong>Let’s Encript**证书，需要导入需要在客户端中导入<a href="https://letsencrypt.org/certs/lets-encrypt-x3-cross-signed.pem" target="_blank" rel="external">Let’s Encrypt Authority X3</a>证书。</p>
<ul>
<li>下载CA证书到本地</li>
</ul>
<ul>
<li>开始菜单搜索<strong>cmd</strong>，打开后输入 <strong>mmc（Microsoft 管理控制台）</strong></li>
<li><strong>文件</strong> -&gt; <strong>添加/删除管理单元</strong>，添加<strong>证书</strong>单元</li>
<li>证书单元的弹出窗口中选<strong>计算机账户</strong>，之后选<strong>本地计算机</strong>，确定</li>
<li>在左边的<strong>控制台根节点</strong>下选择<strong>证书</strong> -&gt; <strong>受信任的根证书颁发机构</strong> -&gt; <strong>证书</strong>，右键 -&gt; <strong>所有任务</strong> -&gt; <strong>导入</strong>打开证书导入窗口。</li>
<li>选择证书文件导入即可</li>
</ul>
<h5 id="VPN设置-3"><a href="#VPN设置-3" class="headerlink" title="VPN设置"></a>VPN设置</h5><h6 id="Win10-Win8"><a href="#Win10-Win8" class="headerlink" title="Win10/Win8"></a>Win10/Win8</h6><ul>
<li>配置位置: <strong>设置 -&gt; 网络和Internet -&gt; VPN -&gt; 添加VPN</strong></li>
<li>VPN提供商: Windows（内置）</li>
<li>连接名称: 任意</li>
<li>服务器名称或地址: VPN服务器URL或者IP地址</li>
<li>VPN类型: IKEv2</li>
<li>登录信息类型: 用户名和密码</li>
<li>用户名: Freeradius服务器配置</li>
<li>密码: Freeradius服务器配置</li>
</ul>
<h6 id="Win7"><a href="#Win7" class="headerlink" title="Win7"></a>Win7</h6><ul>
<li>配置位置: <strong>控制面板 -&gt; 网络和 Internet -&gt; 网络和共享中心 -&gt; 连接新的网络或连接 -&gt; 连接到工作区 -&gt; 创建新连接 -&gt; 使用我的Internet连接(VPN)</strong></li>
<li>Internet 地址: VPN服务器URL或者IP地址</li>
<li>目标名称: 任意</li>
<li>用户名: Freeradius服务器配置</li>
<li>密码: Freeradius服务器配置</li>
</ul>
<p>设置完毕后，先不连接</p>
<ul>
<li>配置位置: <strong>控制面板 -&gt; 网络和 Internet -&gt; 网络和共享中心 -&gt; 更改适配器设置</strong></li>
<li>在新建的 VPN 连接上右键<strong>属性</strong></li>
<li>切换到<strong>安全</strong>选项卡<ul>
<li>VPN 类型: IKEv2</li>
<li>数据加密选: 需要加密</li>
<li>身份验证: EAP-MSCHAP v2</li>
</ul>
</li>
</ul>
<p>然后选择连接VPN，win7/8/10连接界面可能不同，但是大同小异。</p>
<h4 id="Linux"><a href="#Linux" class="headerlink" title="Linux"></a>Linux</h4><p>Linux 的版本众多，认证方法与协议支持也非常丰富，详细方法请根据 Linux 版本查询连接方法。一般而言，Linux 通过 NetworkManager-strongswan。</p>
<hr>
<h3 id="6-IPsec-VPN配置"><a href="#6-IPsec-VPN配置" class="headerlink" title="6. IPsec VPN配置"></a>6. IPsec VPN配置</h3><h4 id="iOS-1"><a href="#iOS-1" class="headerlink" title="iOS"></a>iOS</h4><ul>
<li>配置位置: <strong>设置 -&gt; VPN -&gt; 添加配置 -&gt; IPSec</strong></li>
<li>描述: 任意</li>
<li>用户鉴定: 用户名</li>
<li>服务器: VPN服务器URL或者IP地址</li>
<li>用户名: Freeradius服务器配置</li>
<li>密码: Freeradius服务器配置</li>
<li>密钥: ipsec.secrets 中设置的 XAUTH 预共享密码</li>
</ul>
<h4 id="OS-X-1"><a href="#OS-X-1" class="headerlink" title="OS X"></a>OS X</h4><ul>
<li>配置位置: <strong>系统偏好设置 -&gt; 网络 -&gt;添加网络连接</strong></li>
<li>接口: VPN</li>
<li>VPN类型: IPsec/Cisco</li>
<li>服务器地址: 服务器URL或者IP地址</li>
<li>账户名称: Freeradius服务器配置</li>
<li>密码: Freeradius服务器配置</li>
<li>鉴定设置 -&gt; 共享的密钥: ipsec.secrets 中设置的 EAP 预共享密码</li>
</ul>
<h4 id="Android-1"><a href="#Android-1" class="headerlink" title="Android"></a>Android</h4><ul>
<li>配置位置: <strong>设置 -&gt; 其它连接方式 -&gt; VPN -&gt; 添加 VPN</strong></li>
<li>名称: 任意</li>
<li>服务器地址: 服务器URL或者IP地址</li>
<li>类型: IPSec Xauth PSK</li>
<li>IPsec 标识符: 不更改</li>
<li>预共享密钥: ipsec.secrets 中设置的 EAP 预共享密码</li>
<li>连接时账户名密码: Freeradius服务器配置</li>
</ul>
<h4 id="Linux-1"><a href="#Linux-1" class="headerlink" title="Linux"></a>Linux</h4><p>Linux 的版本众多，认证方法与协议支持也非常丰富，详细方法请根据 Linux 版本查询连接方法。一般而言，Linux 通过 NetworkManager-strongswan。</p>
<hr>
<h3 id="7-参考-amp-问题"><a href="#7-参考-amp-问题" class="headerlink" title="7. 参考 &amp; 问题"></a>7. 参考 &amp; 问题</h3><p><a href="https://wiki.strongswan.org/projects/strongswan/wiki/ConnSection" target="_blank" rel="external">https://wiki.strongswan.org/projects/strongswan/wiki/ConnSection</a></p>
<p><a href="https://blog.itnmg.net/centos7-ipsec-vpn/" target="_blank" rel="external">https://blog.itnmg.net/centos7-ipsec-vpn/</a></p>

        </div>
      </article>
    </div>
    <!-- Comments -->
    <div class="container">
      
<section id="comment">
  <!-- <h1 class="title">留言</h1> -->

  
</section>


    </div>
    <!-- Pre or Next -->
    <div class="nav-links">
      
        <div class="nav-previous">
          <a href="/2017/01/28/hello-world/" rel="prev"><span class="meta-arraw meta-arraw-left"></span> 上一页</a>
        </div>
      
      
        <div class="nav-next">
          <a href="/2017/01/26/IKEv2服务器静态NAT + Freeradius验证 + 流量分离实验/" rel="prev">下一页 <span class="meta-arraw meta-arraw-right"></span></a>
        </div>
      
    </div>

  </div>
</div>


  <!-- Footer -->
  <!-- Footer-widgets -->
<div class="footer-widgets">
  <div class="row inside-wrapper">
    <div class="col-1-3">
      <aside>
        <h1 class="widget-title">关于本站</h1>
        <div class="custom-widget-content">
          
          <p>分享技术心得，笑谈樯橹灰飞烟灭</p>
        </div>
      </aside>
    </div>
    <div class="col-1-3">
      <aside>
        <h1 class="widget-title">与我联系</h1>
        <div class="widget-text">
          
            
              <a href="https://github.com/icean" class="icon icon-github" target="_blank">github</a>
            
              <a href="http://weibo.com/1509230644" class="icon icon-weibo" target="_blank">weibo</a>
            
              <a href="mailto:iceanness@gmail.com" class="icon icon-mail" target="_blank">mail</a>
            
              <a href="https://twitter.com/Iceanian" class="icon icon-twitter" target="_blank">twitter</a>
            
          
        </div>
      </aside>
    </div>
    <div class="col-1-3">
      <aside>
        <h1 class="widget-title">站内搜索</h1>
        <div class="widget-text">
          <form onSubmit="return appDaily.submitSearch('')">
            <p>
              <input type="text" placeholder="搜索..." id="homeSearchInput">
            </p>
            <!-- <input type="submit" value="GO"> -->
          </form>
        </div>
      </aside>
    </div>
  </div>
</div>
<!-- Footer -->
<footer class="site-info">
  <p>
    <span>Kompass &copy; 2017</span>
    
      <span class="split">|</span>
      <span>Powered by <a href="https://hexo.io/" target="_blank">Hexo</a> with Theme <a href="https://github.com/GallenHu/hexo-theme-Daily" target="_blank">Daily</a></span>
    
  </p>
</footer>


  <!-- After footer scripts -->
  <!-- scripts -->
<script src="/js/app.js"></script>



</body>

</html>