<!DOCTYPE html>
<html lang="zh-CN">

<!-- Head tag -->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">

  <!--Description-->
  

  <!--Author-->
  
  <meta name="author" content="Icean L">
  

  <!--Open Graph Title-->
  
      <meta property="og:title" content="CentOS 6.x PPTP + Radius + Mysql + Daloradius"/>
  
  <!--Open Graph Description-->
  
  <!--Open Graph Site Name-->
  <meta property="og:site_name" content="Kompass"/>
  <!--Type page-->
  
      <meta property="og:type" content="article" />
  
  <!--Page Cover-->
  

  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <!-- Title -->
  
  <title>CentOS 6.x PPTP + Radius + Mysql + Daloradius - Kompass</title>


  <link rel="shortcut icon" href="/">

  <!-- Custom CSS/Sass -->
  <link rel="stylesheet" href="/css/style.css">

  <!----------------------------
  https://github.com/GallenHu/hexo-theme-Daily

 _____            _   _
|  __ \          (_) | |
| |  | |   __ _   _  | |  _   _
| |  | |  / _` | | | | | | | | |
| |__| | | (_| | | | | | | |_| |
|_____/   \__,_| |_| |_|  \__, |
                          __/ |
                         |___/

    --------------------------->

</head>


<body>

  <!-- Nav -->
  <header class="site-header">
  <div class="header-inside">
    <div class="logo">
      <a href="/" rel="home">
        
        <img src="http://qingdao.icean.cc:11234/Imgbed/logo.png" alt="Kompass" height="60">
        
      </a>
    </div>
    <!-- Navigation -->
    <nav class="navbar">
      <!-- Collect the nav links, forms, and other content for toggling -->
      <div class="collapse">
        <ul class="navbar-nav">
          
          
            <li>
              <a href="/.">
                
                  主页
                
              </a>
            </li>
          
            <li>
              <a href="/archives">
                
                  归档
                
              </a>
            </li>
          
            <li>
              <a href="/about">
                
                  关于
                
              </a>
            </li>
          
        </ul>
      </div>
      <!-- /.navbar-collapse -->
    </nav>
    <div class="button-wrap">
      <button class="menu-toggle">Primary Menu</button>
    </div>
  </div>
</header>


  <!-- Main Content -->
  <div class="content-area">
  <div class="post">
    <!-- Post Content -->
    <div class="container">
      <article>
        <!-- Title date & tags -->
        <div class="post-header">
          <h1 class="entry-title">
            CentOS 6.x PPTP + Radius + Mysql + Daloradius
            
          </h1>
          <p class="posted-on">
          2016-09-29
          </p>
          <div class="tags-links">
            
              
                <a href="/tags/VPN/" rel="tag">
                  VPN
                </a>
              
                <a href="/tags/linux/" rel="tag">
                  linux
                </a>
              
            
          </div>
        </div>
        <!-- Post Main Content -->
        <div class="entry-content">
          <h3 id="1-radius服务器安装"><a href="#1-radius服务器安装" class="headerlink" title="1. radius服务器安装"></a>1. radius服务器安装</h3><h4 id="yum安装相关软件"><a href="#yum安装相关软件" class="headerlink" title="yum安装相关软件"></a>yum安装相关软件</h4><pre><code>yum install freeradius freeradius-mysql freeradius-utils mysql-server -y
</code></pre><h4 id="mysql设置"><a href="#mysql设置" class="headerlink" title="mysql设置"></a>mysql设置</h4><p>启动mysql</p>
<pre><code>service mysqld start
</code></pre><p>设置mysql密码和安全设置<br>    /usr/bin/mysql_secure_installation</p>
<p>创建数据库并授权</p>
<pre><code>mysql -uroot -p
mysql-&gt; CREATE DATABASE radius;
mysql-&gt; GRANT ALL PRIVILEGES ON radius.* TO radius@localhost IDENTIFIED BY &quot;radpass&quot;;
mysql-&gt; flush privileges;
</code></pre><p>导入数据表</p>
<pre><code>mysql&gt; use radius;
mysql&gt; SOURCE /etc/raddb/sql/mysql/schema.sql;
mysql&gt; exit；
</code></pre><h4 id="修改freeadius配置文件"><a href="#修改freeadius配置文件" class="headerlink" title="修改freeadius配置文件"></a>修改freeadius配置文件</h4><p>编辑freeradius配置文件，开启sql认证</p>
<p>文件1：/etc/raddb/sql.conf </p>
<pre><code># Connection info:
server = &quot;localhost&quot;
#port = 3306
login = &quot;radius&quot;  #mysql登录用户名
password = &quot;radpass&quot; #上述登录用户名的密码
# Database table configuration for everything except Oracle
radius_db = &quot;radius&quot;
</code></pre><p>文件2：/etc/raddb/radiusd.conf</p>
<pre><code>$INCLUDE  sql.conf   #去掉前面的注释
</code></pre><p>文件3： /etc/raddb/sites-available/default</p>
<pre><code>authorize{} accounting {} session {} 去掉里面sql前面的注释
</code></pre><p>文件4： /etc/raddb/sites-available/inner-tunnel </p>
<pre><code>authorize {} session {} 去掉里面sql前面的注释
</code></pre><p>文件5： /etc/raddb/clients.conf，修改本地客户端的共享key</p>
<pre><code>secret = testing123 这个key太简单，可以为一个随机字符串。例如：
secret = 3c23498n349c3yt290y93b4t3
</code></pre><p>可以在这个文件中添加其他客户端。</p>
<h4 id="iptables端口开放"><a href="#iptables端口开放" class="headerlink" title="iptables端口开放"></a>iptables端口开放</h4><p>需要在iptables上开放1812到1814之间，以及18120的udp端口</p>
<pre><code>iptables -A INPUT -p udp --dport 1812:1814 -j ACCEPT
iptables -A INPUT -p udp --dport 18120 -j ACCEPT
</code></pre><h4 id="启动测试radius服务"><a href="#启动测试radius服务" class="headerlink" title="启动测试radius服务"></a>启动测试radius服务</h4><p>启动freeradius服务</p>
<pre><code>service radiusd restart
</code></pre><p>添加用户信息</p>
<pre><code>mysql -uroot -p
use radius;
insert into radcheck (username,attribute,op,value) values (&apos;test&apos;,&apos;User-Password&apos;,&apos;:=&apos;,&apos;test&apos;);
exit；
radtest test test 127.0.0.1 0 3c23498n349c3yt290y93b4t3
</code></pre><p>看到“rad_recv: Access-Accept” 则本地客户端认证成功。</p>
<blockquote>
<p><span style="color:red"><strong>提示：</strong></span>若出现radtest测试出现radclient:: Failed to find IP address for servername，修改  /etc/hosts 添加：127.0.0.1 servername</p>
</blockquote>
<hr>
<h3 id="2-pptp服务器设置"><a href="#2-pptp服务器设置" class="headerlink" title="2.pptp服务器设置"></a>2.pptp服务器设置</h3><h4 id="配置文件修改"><a href="#配置文件修改" class="headerlink" title="配置文件修改"></a>配置文件修改</h4><p>修改/etc/ppp/option.pptpd,添加如下</p>
<pre><code>plugin /usr/lib64/pppd/2.4.5/radius.so
plugin /usr/lib64/pppd/2.4.5/radattr.so
radius-config-file /etc/radiusclient/radiusclient.conf
</code></pre><p>去掉/etc/pptpd.conf中的logwtmp字段</p>
<blockquote>
<p><span style="color:red"><strong>提示：</strong></span>pptp需要在iptables上开放gre协议，如果没有开放该端口，则无法进行验证，即无法登陆成功。这个问题在公网vps还没遇到，但是在同一个局域网内的pptp服务器则有这个问题。</p>
<pre><code>iptables -A INPUT -p gre -j ACCEPT
</code></pre></blockquote>
<h4 id="freeradius客户端安装设置"><a href="#freeradius客户端安装设置" class="headerlink" title="freeradius客户端安装设置"></a>freeradius客户端安装设置</h4><p>安装freeadius客户端，没有安装epel源的需要yum安装epel源，freeradius-utils为测试工具，radtest为freeradius-utils命令。</p>
<pre><code>yum install epel-release
yum install freeradius-client freeradius-utils -y
</code></pre><h4 id="freearadius配置"><a href="#freearadius配置" class="headerlink" title="freearadius配置"></a>freearadius配置</h4><p><strong>radius客户端</strong>修改/etc/radiusclient/servers，添加条目，若是本地radius服务器，添加如下，rootroot为共享密钥，需要和服务器配置文件/etc/raddb/clients.conf中localhost中的secret一样。</p>
<pre><code>localhost/localhost rootroot
</code></pre><p>若要使用远程服务器，<strong>radius客户端</strong>需要在/etc/radiusclient/servers中添加如下，centos2为服务器主机名，需要在hosts文件中添加相应解析条目。</p>
<pre><code>centos2/centos2 rootroot
</code></pre><p><strong>radius客户端</strong>也需要在/etc/radiusclient/radiusclient.conf中修改配置，修改</p>
<pre><code>authserver  centos2
acctserver  centos2
</code></pre><p><strong>radius服务器</strong>端的/etc/raddb/clients.conf添加如下配置，架设客户端为centos1，ip地址为192.168.86.101，secret为rootroot。在服务器端的hosts中也需要添加关于centos1的地址解析条目。</p>
<pre><code>client centos1 {
    ipaddr = 192.168.86.101
    secret= rootroot
    require_message_authenticator = no
    nastype = other 
}  
</code></pre><h4 id="freeadius测试"><a href="#freeadius测试" class="headerlink" title="freeadius测试"></a>freeadius测试</h4><p>客户端可以使用radtest测试远端radius服务器命令，若不成功，可以在服务器端查看/var/log/radius/radius.log来进行debug</p>
<h4 id="字典添加设置"><a href="#字典添加设置" class="headerlink" title="字典添加设置"></a>字典添加设置</h4><p>修改/etc/radiusclient/radiusclient.conf中的<code>/usr/share/radiusclient/dictionary</code>，将其修改为<code>/etc/radiusclient/dictionary</code>。注释掉84行的<code>radius_deadtime    0</code> 和87行<code>bindaddr *</code></p>
<p>下载微软字典</p>
<pre><code>wget http://qingdao.icean.cc:11234/dictionary.microsoft
</code></pre><p>修改/etc/radiusclient/dictionary字典文件，在文件末尾添加如下</p>
<pre><code>INCLUDE /etc/radiusclient/dictionary.microsoft
INCLUDE /etc/radiusclient/dictionary.merit 
</code></pre><p>需要将<code>dictionary.microsoft, dictionary.merit</code>放在<code>/etc/radiusclient</code>目录下,dictionary.merit在<code>/usr/share/radiusclient/</code>目录下。</p>
<blockquote>
<p><span style="color:red"><strong>修订：</strong></span>需要将dictionary中所有关于IPv6的选项全部注释掉，否则无法鉴定成功。若出现鉴定失败字样，请使用tail -f /var/log/message来动态查看信息。</p>
</blockquote>
<hr>
<h3 id="3-Daloradius安装"><a href="#3-Daloradius安装" class="headerlink" title="3.Daloradius安装"></a>3.Daloradius安装</h3><h4 id="LAMP环境搭建"><a href="#LAMP环境搭建" class="headerlink" title="LAMP环境搭建"></a>LAMP环境搭建</h4><p>Daloradius是基于LAMP环境的，所以首先需要搭建LAMP环境</p>
<h4 id="下载安装"><a href="#下载安装" class="headerlink" title="下载安装"></a>下载安装</h4><p>下载daloradius源码</p>
<pre><code>cd usr/share
wget http://downloads.sourceforge.net/project/daloradius/daloradius/daloradius0.9-9/daloradius-0.9-9.tar.gz
tar -xvzf daloradius-0.9-9.tar.gz
mv daloradius-0.9-9 daloradius
</code></pre><h4 id="编辑daloradius配置文件"><a href="#编辑daloradius配置文件" class="headerlink" title="编辑daloradius配置文件"></a>编辑daloradius配置文件</h4><p>修改/usr/share/daloradius/library/daloradius.conf.php</p>
<pre><code>$configValues[&apos;CONFIG_DB_HOST&apos;] = &apos;localhost&apos;;
$configValues[&apos;CONFIG_DB_USER&apos;] = &apos;radius&apos;;
$configValues[&apos;CONFIG_DB_PASS&apos;] = &apos;***&apos;;  // 设为自己的密码
$configValues[&apos;CONFIG_DB_NAME&apos;] = &apos;radius&apos;;
</code></pre><p>修改daloRadius路径</p>
<pre><code>$configValues[&apos;CONFIG_PATH_DALO_VARIABLE_DATA&apos;] = &apos;/usr/share/daloradius/var&apos;
</code></pre><h4 id="mysql导入表格数据"><a href="#mysql导入表格数据" class="headerlink" title="mysql导入表格数据"></a>mysql导入表格数据</h4><p>导入daloradius数据</p>
<pre><code>mysql -uroot -p radius &lt; /usr/share/daloradius/contrib/db/fr2-mysql-daloradius-and-freeradius.sql
</code></pre><h4 id="添加Apache虚拟主机"><a href="#添加Apache虚拟主机" class="headerlink" title="添加Apache虚拟主机"></a>添加Apache虚拟主机</h4><p>在/etc/httpd/conf/httpd.conf中加入</p>
<pre><code>Alias /daloradius &quot;/usr/share/daloradius/&quot;
&lt;Directory &quot;/usr/share/daloradius&quot;&gt;
&lt;/Directory&gt;
</code></pre><h4 id="php-pear-DB安装"><a href="#php-pear-DB安装" class="headerlink" title="php-pear-DB安装"></a>php-pear-DB安装</h4><p>安装该软件，否则在浏览器下可以登录daloradius，但是出现http 500错误。</p>
<h4 id="重启服务并网页访问"><a href="#重启服务并网页访问" class="headerlink" title="重启服务并网页访问"></a>重启服务并网页访问</h4><p>重启httpd，mysqld服务并在浏览器下输入<a href="http://[ip" target="_blank" rel="external">http://[ip</a> address]/daloradius，默认账户为administrator，密码为radius</p>

        </div>
      </article>
    </div>
    <!-- Comments -->
    <div class="container">
      
<section id="comment">
  <!-- <h1 class="title">留言</h1> -->

  
</section>


    </div>
    <!-- Pre or Next -->
    <div class="nav-links">
      
        <div class="nav-previous">
          <a href="/2016/09/29/CentOS 6.x ocserv IPv6 实验/" rel="prev"><span class="meta-arraw meta-arraw-left"></span> 上一页</a>
        </div>
      
      
        <div class="nav-next">
          <a href="/2016/09/09/CentOS 批量添加SFTP用户/" rel="prev">下一页 <span class="meta-arraw meta-arraw-right"></span></a>
        </div>
      
    </div>

  </div>
</div>


  <!-- Footer -->
  <!-- Footer-widgets -->
<div class="footer-widgets">
  <div class="row inside-wrapper">
    <div class="col-1-3">
      <aside>
        <h1 class="widget-title">关于本站</h1>
        <div class="custom-widget-content">
          
          <p>分享技术心得，笑谈樯橹灰飞烟灭</p>
        </div>
      </aside>
    </div>
    <div class="col-1-3">
      <aside>
        <h1 class="widget-title">与我联系</h1>
        <div class="widget-text">
          
            
              <a href="https://github.com/icean" class="icon icon-github" target="_blank">github</a>
            
              <a href="http://weibo.com/1509230644" class="icon icon-weibo" target="_blank">weibo</a>
            
              <a href="mailto:iceanness@gmail.com" class="icon icon-mail" target="_blank">mail</a>
            
              <a href="https://twitter.com/Iceanian" class="icon icon-twitter" target="_blank">twitter</a>
            
          
        </div>
      </aside>
    </div>
    <div class="col-1-3">
      <aside>
        <h1 class="widget-title">站内搜索</h1>
        <div class="widget-text">
          <form onSubmit="return appDaily.submitSearch('')">
            <p>
              <input type="text" placeholder="搜索..." id="homeSearchInput">
            </p>
            <!-- <input type="submit" value="GO"> -->
          </form>
        </div>
      </aside>
    </div>
  </div>
</div>
<!-- Footer -->
<footer class="site-info">
  <p>
    <span>Kompass &copy; 2017</span>
    
      <span class="split">|</span>
      <span>Powered by <a href="https://hexo.io/" target="_blank">Hexo</a> with Theme <a href="https://github.com/GallenHu/hexo-theme-Daily" target="_blank">Daily</a></span>
    
  </p>
</footer>


  <!-- After footer scripts -->
  <!-- scripts -->
<script src="/js/app.js"></script>



</body>

</html>