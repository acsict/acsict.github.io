<!DOCTYPE html>
<html lang="">
  <head>
    <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>


<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />









  <link rel="alternate" href="/atom.xml" title="Kompass">




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=2.1.x" />



<link rel="canonical" href="http://yoursite.com/page/2/"/>


<meta property="og:type" content="website">
<meta property="og:title" content="Kompass">
<meta property="og:url" content="http://yoursite.com/page/2/index.html">
<meta property="og:site_name" content="Kompass">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Kompass">


<link rel="stylesheet" type="text/css" href="/css/style.css?v=2.1.x" />



  <link rel="stylesheet" type="text/css" href="/lib/fancybox/jquery.fancybox.css" />




  


<!-- <link href="/plugins/prettify/prettify.css" rel="stylesheet"> -->

    <title> Kompass </title>
  </head>

  <body>
    <div class="container">
      <header id="header" class="header"><div class="logo-wrapper">
  <a href="/." class="logo"><img src="http://qingdao.icean.cc:11234/Imgbed/logo.png" height="58" width="58">  Kompass</a>
  
</div>

<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        <li class="menu-item">
          <a class="menu-item-link" href="/">
            
            
              主页
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/archives/">
            
            
              归档
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/tags">
            
            
              标签
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/about">
            
            
              关于
            
          </a>
        </li>
      
      
    </ul>
  
</nav>

<div class="mobile-navbar">
  <div class="mobile-header">
    <div class="mobile-header-logo">
      <a href="/." class="logo">Kompass</a>
    </div>

    <div class="mobile-header-icon">
      <span></span>
      <span></span>
      <span></span>
    </div>
  </div>
  <nav class="mobile-menu">
    
      <a class="mobile-menu-item" href="/">
        
        
          主页
        
      </a>
    
      <a class="mobile-menu-item" href="/archives/">
        
        
          归档
        
      </a>
    
      <a class="mobile-menu-item" href="/tags">
        
        
          标签
        
      </a>
    
      <a class="mobile-menu-item" href="/about">
        
        
          关于
        
      </a>
    
  </nav>
</div>
      </header>

      <main id="main" class="main">
        <div class="content-wrapper">
          <div id="content" class="content">
            
  <section id="posts" class="posts">
    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2017/01/18/CentOS 6.x ocserv安装/">CentOS 6.x ocserv 安装</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2017年1月18日
        </span>
      </div>
    </header>

    

    <div class="post-content">
      
        

        
          <h3 id="1-ocserv"><a href="#1-ocserv" class="headerlink" title="1. ocserv"></a>1. ocserv</h3><h4 id="1-1-介绍"><a href="#1-1-介绍" class="headerlink" title="1.1 介绍"></a>1.1 介绍</h4><p>OpenConnect server (ocserv)以一款SSL VPN服务。它的目的是构建安全、小巧、快速以及容易配置的VPN服务器。它实现了OpenConnect SSL VPN协议，并且也兼容AnyConnect SSL VPN协议客户端。OpenConnect协议提供了基于TCP/UDP的双重VPN隧道，使用标准的IETF加密协议。该服务主要面向GNU/Linux平台。</p>
<h4 id="1-2-yum安装ocserv"><a href="#1-2-yum安装ocserv" class="headerlink" title="1.2 yum安装ocserv"></a>1.2 yum安装ocserv</h4><p>现在可以使用yum安装ocserv</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">yum install -y epel-release</div><div class="line">yum install -y ocserv</div></pre></td></tr></table></figure>
<hr>
<h3 id="2-证书安装"><a href="#2-证书安装" class="headerlink" title="2. 证书安装"></a>2. 证书安装</h3><h4 id="2-1-配置文件夹创建"><a href="#2-1-配置文件夹创建" class="headerlink" title="2.1 配置文件夹创建"></a>2.1 配置文件夹创建</h4><p>ocserv服务的启动需要相关证书，为了方便管理，首先在配置文件夹中创建一些文件夹</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">mkdir -p /etc/ocserv/ssl/private          <span class="comment">#保存服务器私钥</span></div><div class="line">mkdir -p /etc/ocserv/ssl/ca                 <span class="comment">#保存CA</span></div><div class="line">mkdir -p /etc/ocserv/ssl/server           <span class="comment">#保存服务器证书</span></div><div class="line">mkdir -p /etc/ocserv/ssl/user              <span class="comment">#保存用户证书</span></div><div class="line">mkdir -p /etc/ocserv/ssl/crl                 <span class="comment">#保存用户吊销证书链</span></div></pre></td></tr></table></figure>
<h4 id="2-2-使用自签证书"><a href="#2-2-使用自签证书" class="headerlink" title="2.2 使用自签证书"></a>2.2 使用自签证书</h4><h5 id="2-2-1-CA证书生成"><a href="#2-2-1-CA证书生成" class="headerlink" title="2.2.1 CA证书生成"></a>2.2.1 CA证书生成</h5><p>生成CA私钥</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">cd</span> /etc/ocserv/ssl/private</div><div class="line">certtool --generate-privkey --outfile ca-key.pem</div></pre></td></tr></table></figure>
<p>生成CA模板，cn和o选项填入任意域名，本文以test.com代替。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">cd</span> /etc/ocserv/ssl/ca</div><div class="line">cat &lt;&lt; EOF &gt; ca.tmpl</div><div class="line">cn = <span class="string">"test.com"</span></div><div class="line">organization = <span class="string">"test.com"</span></div><div class="line">serial = 1</div><div class="line">expiration_days = 3650</div><div class="line">ca</div><div class="line">signing_key</div><div class="line">cert_signing_key</div><div class="line">crl_signing_key</div><div class="line">EOF</div></pre></td></tr></table></figure>
<p>CA证书生成</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">certtool --generate-self-signed --load-privkey ../private/ca-key.pem --template \</div><div class="line">ca.tmpl --outfile ca-cert.pem</div></pre></td></tr></table></figure>
<h5 id="2-2-2-Server证书生成"><a href="#2-2-2-Server证书生成" class="headerlink" title="2.2.2 Server证书生成"></a>2.2.2 Server证书生成</h5><p>生成Server私钥</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">cd</span> /etc/ocserv/ssl/private</div><div class="line">certtool --generate-privkey --outfile server-key.pem</div></pre></td></tr></table></figure>
<p>生成Server证书模板，cn和o选项填入ocserv服务器的域名，本文以test.com代替。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">cd</span> /etc/ocserv/ssl/server</div><div class="line">cat &lt;&lt; EOF &gt; server.tmpl</div><div class="line">cn = <span class="string">"test.com"</span></div><div class="line">organization = <span class="string">"test.com"</span></div><div class="line">expiration_days = 3650</div><div class="line">signing_key</div><div class="line">encryption_key </div><div class="line">tls_www_server</div><div class="line">EOF</div></pre></td></tr></table></figure>
<p>生成Server证书：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">certtool --generate-certificate --load-privkey ../private/server-key.pem  \</div><div class="line">--load-ca-certificate ../ca/ca-cert.pem --load-ca-privkey ../private/ca-key.pem \</div><div class="line">--template server.tmpl --outfile server-cert.pem</div></pre></td></tr></table></figure>
<h4 id="2-3-使用授权证书"><a href="#2-3-使用授权证书" class="headerlink" title="2.3 使用授权证书"></a>2.3 使用授权证书</h4><h5 id="2-3-1-申请证书"><a href="#2-3-1-申请证书" class="headerlink" title="2.3.1 申请证书"></a>2.3.1 申请证书</h5><p>授权证书可以从<a href="https://buy.wosign.com/" target="_blank" rel="external">沃通</a>或者<a href="https://startssl.com" target="_blank" rel="external">startssl</a>、<a href="https://letsencrypt.org/" target="_blank" rel="external">Let’s Encrypt</a>等申请免费的ssl证书。申请证书的大概流程为：</p>
<ul>
<li>CSR文件为请求证书的文件，会产生一对公私钥，公钥（pub-key）需要上传给证书颁发结构，私钥（private-key）则要自己保留不能泄露。</li>
<li>证书颁发结构需要要验证申请人的域名拥有权，证明域名拥有权之后，使用其私钥（signature private-key）申请人上传的pub-lkey进行签名，并把域名等证书信息追加到其中，产生一个证书，例如<code>2_dovzinp3.icean.me.crt</code></li>
<li>终端用户并不信任这个证书，鉴于这个证书不是权威机构颁发，所以需要证书链，来证明颁发该证书的结构是权威机构认证的。</li>
<li>证书链为颁发<code>2_dovzinp3.icean.me.crt</code>证书的结构，其上级机构对其公钥进行签名，逐级进行签名，直到顶级CA。</li>
</ul>
<h5 id="2-3-2-安装证书"><a href="#2-3-2-安装证书" class="headerlink" title="2.3.2 安装证书"></a>2.3.2 安装证书</h5><p>下载证书的压缩文件包中，解压OtherServer，以startssl为例子，解压出如下图所示。</p>
<center><img src="http://i.imgur.com/aUSEeOG.png" alt=""></center>

<center style="color:purple"><strong>图2-1 授权证书</strong></center>

<p>服务器私钥为生成CSR文件所用的私钥</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">mv xxx.key server-key.pem</div><div class="line">mv server-key.pem /etc/ocserv/ssl/private</div></pre></td></tr></table></figure>
<p>创建服务器证书，根据证书链的顺序，首先追加服务器证书，然后追加中间证书，最后追加CA证书。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">cat 2_dovzinp3.icean.me.crt &gt;&gt; server-cert.pem</div><div class="line">cat 1_Intermediate.crt &gt;&gt; server-cert.pem</div><div class="line">cat root.crt &gt;&gt; server-cert.pem</div><div class="line">mv server-cert.pem /etc/ocserv/ssl/server</div></pre></td></tr></table></figure>
<hr>
<h3 id="3-主要配置"><a href="#3-主要配置" class="headerlink" title="3. 主要配置"></a>3. 主要配置</h3><h4 id="3-1-配置文件备份-amp-修改"><a href="#3-1-配置文件备份-amp-修改" class="headerlink" title="3.1 配置文件备份&amp;修改"></a>3.1 配置文件备份&amp;修改</h4><p>备份原配置文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">cd</span> /etc/ocserv</div><div class="line">mv ocserv.conf ocserv.conf.bak</div></pre></td></tr></table></figure>
<p>创建新的配置文件<code>ocserv.conf</code>，内容如下，缺省验证方式为账户密码验证</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">auth = <span class="string">"plain[/etc/ocserv/passwd]"</span>                                            <span class="comment">#本地账户密码验证      </span></div><div class="line"><span class="comment">#auth = "certificate"                                                                    #证书验证</span></div><div class="line"><span class="comment">#auth = "radius[config=/etc/radcli/radiusclient.conf,groupconfig=true]"  </span></div><div class="line">                                                                                                     <span class="comment">#radius验证</span></div><div class="line"><span class="comment">#acct = "radius[config=/etc/radcli/radiusclient.conf]"                #radius审计</span></div><div class="line"></div><div class="line">stats-report-time = 360                                                               <span class="comment">#发送审计报告时间间隔</span></div><div class="line">max-clients = 16</div><div class="line">max-same-clients = 1</div><div class="line">tcp-port = 443                                                                            <span class="comment">#连接端口号，可以修改为其他端口</span></div><div class="line">udp-port = 443                                                                           <span class="comment">#连接端口号，可以修改为其他端口</span></div><div class="line">keepalive = 32400</div><div class="line">dpd = 90</div><div class="line">mobile-dpd = 1800</div><div class="line">try-mtu-discovery = <span class="literal">true</span></div><div class="line">cisco-client-compat = <span class="literal">true</span></div><div class="line"><span class="comment">#ca-cert /etc/ocserv/ssl/ca/ca-cert.pem                                      #CA证书路径</span></div><div class="line">server-cert = /etc/ocserv/ssl/server/server-cert.pem                  <span class="comment">#服务器证书存储路径</span></div><div class="line">server-key = /etc/ocserv/ssl/private/server-key.pem                  <span class="comment">#服务器私钥存储路径</span></div><div class="line"><span class="comment">#crl = /etc/ocserv/ssl/crl/crl.pem                                                 #吊销证书链</span></div><div class="line">auth-timeout = 40</div><div class="line">pid-file = /var/run/ocserv.pid</div><div class="line">socket-file = /var/run/ocserv-socket</div><div class="line">run-as-user = nobody</div><div class="line">run-as-group = daemon</div><div class="line">device = vpns</div><div class="line">ipv4-network = 192.168.80.0                                                       <span class="comment">#虚拟IP地址段，分配给VPN客户端</span></div><div class="line">ipv4-netmask = 255.255.255.0                                                    <span class="comment">#虚拟IP掩码</span></div><div class="line">dns = 8.8.8.8                                                                                <span class="comment">#DNS地址</span></div><div class="line">dns = 8.8.4.4</div><div class="line"></div><div class="line"><span class="comment">#no-route = 1.0.0.0/255.192.0.0                                                   #不路由某些地址</span></div><div class="line"><span class="comment">#route = 1.64.0.0/255.224.0.0                                                      #只路由某些地址，no-route和route不可同时用</span></div></pre></td></tr></table></figure>
<h4 id="3-2-route-amp-no-route"><a href="#3-2-route-amp-no-route" class="headerlink" title="3.2 route &amp; no-route"></a>3.2 route &amp; no-route</h4><p>如果需要指定客户端只能路由到某些地址，则需要在配置文件<code>ocserv.conf</code>中添加如下样例</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">route = 192.168.1.0/255.255.255.0</div></pre></td></tr></table></figure>
<p>如果需要指定客户端不需要路由到某些地址，则需要在配置文件<code>ocserv.conf</code>中添加如下样例</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">no-route = 192.168.1.0/255.255.255.0</div></pre></td></tr></table></figure>
<p>两者不可同时使用</p>
<h4 id="3-3-账户密码验证"><a href="#3-3-账户密码验证" class="headerlink" title="3.3 账户密码验证"></a>3.3 账户密码验证</h4><p>在配置文件<code>ocserv.conf</code>中修改，如下所示</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">auth = <span class="string">"plain[/etc/ocserv/passwd]"</span>  </div><div class="line"><span class="comment">#auth = "certificate" </span></div><div class="line"><span class="comment">#auth = "radius[config=/etc/radcli/radiusclient.conf,groupconfig=true]"  </span></div><div class="line"><span class="comment">#acct = "radius[config=/etc/radcli/radiusclient.conf]"   </span></div><div class="line">.......</div></pre></td></tr></table></figure>
<p>创建登录用户以及密码，每次创建用户，都需要参数c</p>
<pre><code>ocpasswd -c /etc/ocserv/passwd username
</code></pre><h4 id="3-4-radius验证"><a href="#3-4-radius验证" class="headerlink" title="3.4 radius验证"></a>3.4 radius验证</h4><p>在配置文件中<code>ocserv.conf</code>修改如下, 其中radius客户端配置路径为<code>/etc/radcli</code>，在安装ocserv时候，radcli作为依赖被安装</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#auth = "plain[/etc/ocserv/passwd]"  </span></div><div class="line"><span class="comment">#auth = "certificate" </span></div><div class="line">auth = <span class="string">"radius[config=/etc/radcli/radiusclient.conf,groupconfig=true]"</span>  </div><div class="line">acct = <span class="string">"radius[config=/etc/radcli/radiusclient.conf]"</span>   </div><div class="line">.......</div></pre></td></tr></table></figure>
<p>添加radius服务器，修改<code>/etc/radcli/servers</code>，例如添加本机作为radius服务器，如下所示。也可以按照格式添加其他的radius服务器</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">localhost/localhost  testing123   <span class="comment">#验证服务器/审计服务器  服务器暗码</span></div></pre></td></tr></table></figure>
<p>修改配置文件<code>/etc/radcli/radiusclient.conf</code>，选择要使用的验证服务器以及审计服务器，如下为使用localhost作为验证和审计服务器，其他选项不需要修改。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">authserver  localhost</div><div class="line">acctserver  localhost</div></pre></td></tr></table></figure>
<h4 id="3-5-证书验证"><a href="#3-5-证书验证" class="headerlink" title="3.5 证书验证"></a>3.5 证书验证</h4><h5 id="3-5-1-用户证书生成"><a href="#3-5-1-用户证书生成" class="headerlink" title="3.5.1 用户证书生成"></a>3.5.1 用户证书生成</h5><p>使用账户密码以及radius验证，接入的客户端需要每次输入账户名和密码，而证书验证则不需要每次输入账户名和密码。第一次在客户端导入证书即可。</p>
<p>使用certtool生成用户私钥</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">cd</span> /etc/ocserv/ssl/private</div><div class="line">certtool --generate-privkey --outfile user-key.pem</div></pre></td></tr></table></figure>
<p>创建用户模板</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">cat &lt;&lt; EOF &gt; user.tmpl</div><div class="line">cn = <span class="string">"example-cn"</span></div><div class="line">unit = <span class="string">"example-unit"</span></div><div class="line">expiration_days = 365</div><div class="line">signing_key</div><div class="line">tls_www_client</div><div class="line">EOF</div></pre></td></tr></table></figure>
<p>生成用户证书</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#生成用户证书</span></div><div class="line"><span class="built_in">cd</span>  /etc/ocserv/ssl/user</div><div class="line">certtool --generate-certificate --load-privkey ../private/user-key.pem \</div><div class="line">--load-ca-certificate ca-cert.pem --load-ca-privkey ../private/ca-key.pem \</div><div class="line">--template user.tmpl --outfile user-cert.pem</div><div class="line"></div><div class="line"><span class="comment">#将用户证书和密钥打包为p12格式，在此过程中，需要输入名称和密码，在安装证书时，需要输入该密码进行验证。</span></div><div class="line">certtool --to-p12 --load-privkey ../private/user-key.pem --pkcs-cipher \ </div><div class="line">3des-pkcs12 --load-certificate user-cert.pem --outfile user-cert.p12 --outder</div></pre></td></tr></table></figure>
<p>自动生成证书脚本，运行下面脚本之前，请确认当前目录下有<code>user.tmpl</code>，<code>ca-key.pem</code>，<code>ca-cert.pem</code>三个文件，或者自己命令中的路径参数。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#!/bin/bash</span></div><div class="line"></div><div class="line"><span class="comment">#定义变量</span></div><div class="line">id=<span class="built_in">test</span></div><div class="line">day=365</div><div class="line"></div><div class="line"><span class="built_in">cd</span>  /etc/ocserv/ssl/user</div><div class="line">cp user.tmpl <span class="variable">$id</span>.tmpl</div><div class="line">sed -i <span class="string">"s/example-cn/<span class="variable">$id</span>/g"</span> <span class="variable">$id</span>.tmpl</div><div class="line">sed -i <span class="string">"s/example-unit/<span class="variable">$id</span>/g"</span> <span class="variable">$id</span>.tmpl</div><div class="line">sed -i <span class="string">"s/365/<span class="variable">$day</span>/g"</span> <span class="variable">$id</span>.tmpl</div><div class="line">certtool --generate-privkey --outfile <span class="variable">$id</span>-key.pem</div><div class="line">certtool --generate-certificate --load-privkey <span class="variable">$id</span>-key.pem \</div><div class="line">--load-ca-certificate ca-cert.pem --load-ca-privkey ca-key.pem \</div><div class="line">--template <span class="variable">$id</span>.tmpl --outfile <span class="variable">$id</span>-cert.pem</div><div class="line">certtool --to-p12 --load-privkey <span class="variable">$id</span>-key.pem --pkcs-cipher 3des-pkcs12 \</div><div class="line">--load-certificate <span class="variable">$id</span>-cert.pem --outfile <span class="variable">$id</span>-cert.p12 --outder</div><div class="line"></div><div class="line"><span class="comment">#最后所有相关的文件放入名字为$id的文件夹中</span></div><div class="line">mkdir <span class="variable">$id</span></div><div class="line">mv <span class="variable">$id</span>* <span class="variable">$id</span></div></pre></td></tr></table></figure>
<h5 id="3-5-2-用户证书吊销"><a href="#3-5-2-用户证书吊销" class="headerlink" title="3.5.2 用户证书吊销"></a>3.5.2 用户证书吊销</h5><p>创建空吊销列表文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">cd</span> /etc/ocserv/ssl/crl</div><div class="line">touch revoked.pem</div></pre></td></tr></table></figure>
<p>创建吊销证书模板</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">cat &lt;&lt; EOF &gt; crl.tmpl</div><div class="line">crl_next_update = 9999</div><div class="line">crl_number = 1</div><div class="line">EOF</div></pre></td></tr></table></figure>
<p>创建空的吊销列表，当<code>revoked.pem</code>为空时，执行如下命令生成吊销证书链文件<code>crl.pem</code>。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">certtool --generate-crl --load-ca-privkey ../private/ca-key.pem \</div><div class="line">--load-ca-certificate ../ca/ca-cert.pem --template crl.tmpl --outfile crl.pem</div></pre></td></tr></table></figure>
<p>吊销一个用户，假设要吊销用户证书为user1，首先将其用户证书追加到<code>revoked.pem</code>，然后生成新的吊销证书链文件<code>crl.pem</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">cd</span> /etc/ocserv/ssl/crl</div><div class="line">cat ../user/user1/user1-cert.pem &gt;&gt; revoked.pem</div><div class="line">certtool --generate-crl --load-ca-privkey ../private/ca-key.pem \</div><div class="line">--load-ca-certificate ../ca/ca-cert.pem --load-certificate revoked.pem \</div><div class="line">--template crl.tmpl --outfile crl.pem</div></pre></td></tr></table></figure>
<p>若想重新启用一个被吊销的用户，则需要删除<code>revoked.pem</code>其中对应用户证书的密钥，然后重新生成吊销证书链文件<code>crl.pem</code>，若revoke.pem被清空，则生成的时候不添加<code>--load-certificate</code>参数</p>
<p>完整CA添加/吊销/重新启用脚本请点击<a href="http://pan.baidu.com/s/1o7Z55Om" target="_blank" rel="external">这里</a></p>
<hr>
<h3 id="4-ocserv服务启动"><a href="#4-ocserv服务启动" class="headerlink" title="4. ocserv服务启动"></a>4. ocserv服务启动</h3><h4 id="4-1-开启系统转发"><a href="#4-1-开启系统转发" class="headerlink" title="4.1 开启系统转发"></a>4.1 开启系统转发</h4><p>编译/etc/sysctl.conf，开启IPv4转发，启用此项</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">net.ipv4.ip_forward=1</div></pre></td></tr></table></figure>
<p>并刷新配置</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sysctl -p /etc/sysctl.conf</div></pre></td></tr></table></figure>
<h4 id="4-2-iptables配置"><a href="#4-2-iptables配置" class="headerlink" title="4.2 iptables配置"></a>4.2 iptables配置</h4><p>添加条目到iptables，端口号为配置文件定义的，下面以443为例，同时添加转发表条目</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">iptables -I INPUT 1 -p tcp --dport 443 -j ACCEPT</div><div class="line">iptables -I INPUT 1 -p udp --dport 443 -j ACCEPT</div><div class="line">iptables -I FORWARD 1  -j ACCEPT</div></pre></td></tr></table></figure>
<p>根据需要，设定要访问的网络，例如如果要VPN终端用户要访问服务器eth0网段的网卡，则添加如下条目，访问eth1的添加规则类似</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">iptables -t nat -A POSTROUTING <span class="_">-s</span>  192.168.80.0/24 -o eth0 -j MASQUERADE</div></pre></td></tr></table></figure>
<p>保存并重启iptables</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">service iptables save</div><div class="line">service iptables restart</div></pre></td></tr></table></figure>
<h4 id="4-3-ocserv服务启动"><a href="#4-3-ocserv服务启动" class="headerlink" title="4.3 ocserv服务启动"></a>4.3 ocserv服务启动</h4><p>启动ocserv服务，然后终端用户可以通过思科Anyconnect客户端进行连接。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">service ocserv start</div></pre></td></tr></table></figure>

        
      
    </div>

    
  </article>

    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2017/01/16/Linux重定向/">Linux Shell 标准输入、输出和错误重定向</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2017年1月16日
        </span>
      </div>
    </header>

    

    <div class="post-content">
      
        

        
          <h3 id="1-文件描述符"><a href="#1-文件描述符" class="headerlink" title="1. 文件描述符"></a>1. 文件描述符</h3><p>文件描述符是与文件相关联的一些整数，他们保持与已打开文件的关联。众所周知的文件描述符是标准输入stdin、标准输出stdout、标准错误stderr，我们可以重定位这些文件描述符关联文件的内容到另外一个文件文件描述符。</p>
<table>
<thead>
<tr>
<th>文件描述符</th>
<th>文件</th>
<th>缺省</th>
</tr>
</thead>
<tbody>
<tr>
<td>0(文件)</td>
<td>标准输入</td>
<td>键盘</td>
</tr>
<tr>
<td>1(文件)</td>
<td>标准输出</td>
<td>屏幕</td>
</tr>
<tr>
<td>2(文件)</td>
<td>标准错误</td>
<td>屏幕</td>
</tr>
</tbody>
</table>
<p>系统有12个文件描述符，可以任意使用的文件描述符是3到9</p>
<hr>
<h3 id="2-重定向命令"><a href="#2-重定向命令" class="headerlink" title="2. 重定向命令"></a>2. 重定向命令</h3><h4 id="2-1-输出重定向"><a href="#2-1-输出重定向" class="headerlink" title="2.1 输出重定向"></a>2.1 输出重定向</h4><table>
<thead>
<tr>
<th>命令</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>Command &gt; filename</td>
<td>把<strong>标准输出</strong>重定向到一个新的文件中</td>
</tr>
<tr>
<td>Command &gt;&gt; filename</td>
<td>把<strong>标准输出</strong>重定向到一个文件中<strong>(追加)</strong></td>
</tr>
<tr>
<td>Command &gt; filename 2&gt;&amp;1</td>
<td>把<strong>标准输出</strong>和<strong>标准错误</strong>重定向到一个新的文件中</td>
</tr>
<tr>
<td>Command &amp;&gt; filename</td>
<td>同上</td>
</tr>
<tr>
<td>Command &gt;&gt; filename 2&gt;&amp;1</td>
<td>把<strong>标准输出</strong>和<strong>标准错误</strong>重定向到一个文件中<strong>(追加)</strong></td>
</tr>
<tr>
<td>Command &amp;&gt;&gt; filename</td>
<td>同上</td>
</tr>
<tr>
<td>Command 2 &gt; filename</td>
<td>把<strong>标准错误</strong>重定向到一个新的文件中</td>
</tr>
<tr>
<td>Command 2 &gt;&gt; filename</td>
<td>把<strong>标准错误</strong>重定向到一个文件中<strong>(追加)</strong></td>
</tr>
<tr>
<td>Command 1 &gt; filename 2 &gt; filename</td>
<td>把<strong>标准输出</strong>和<strong>标准错误</strong>分别重定向到两个不同新的文件中</td>
</tr>
<tr>
<td>Command 1 &gt;&gt; filename1  2 &gt;&gt; filename2</td>
<td>把<strong>标准输出</strong>和<strong>标准错误</strong>分别重定向到两个不同的文件中<strong>(追加)</strong></td>
</tr>
<tr>
<td>Command  tee filename</td>
<td>让<strong>标准输出</strong>在屏幕显示，同时重定向一个新的文件</td>
</tr>
<tr>
<td>Command I tee -i filename</td>
<td>同上，但是不接受中断信号，只能<strong>Ctrl+D</strong>结束，不能用<strong>Ctrl+C</strong></td>
</tr>
<tr>
<td>Command I tee -a filename</td>
<td>让<strong>标准输出</strong>在屏幕显示，同时重定向一个文件<strong>(追加)</strong></td>
</tr>
<tr>
<td>Command 2&gt;&amp;1 I tee filename</td>
<td>让<strong>标准输出</strong>和<strong>标准错误</strong>在屏幕显示，重定向到一个新的文件中</td>
</tr>
<tr>
<td>Command 2&gt;&amp;1 I tee -a filename</td>
<td>让<strong>标准输出</strong>和<strong>标准错误</strong>在屏幕显示，重定向到一个文件中<strong>(追加)</strong></td>
</tr>
</tbody>
</table>
<ul>
<li>由于网页支持问题，上述表格内容中的I代表|</li>
<li><strong>2&gt;&amp;1</strong>为<strong>标准错误</strong>重定向到<strong>标准输出</strong></li>
<li>重定向运算符 ‘<strong>&gt;</strong>‘  ‘<strong>&gt;&gt;</strong>‘的默认参数为标准输出，为1。所以:<ul>
<li>‘<strong>&gt;</strong>‘ 等价于’<strong>1&gt;</strong>‘</li>
<li>‘<strong>&gt;&gt;</strong>‘等价于’<strong>1&gt;&gt;</strong>‘</li>
</ul>
</li>
</ul>
<h4 id="2-2-输入重定向"><a href="#2-2-输入重定向" class="headerlink" title="2.2 输入重定向"></a>2.2 输入重定向</h4><table>
<thead>
<tr>
<th>命令</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>Command &lt; filename1 &gt;filename2</td>
<td>Command命令以 filename1 文件作为<strong>标准输入</strong>，以filename2文件作为<strong>标准输出</strong></td>
</tr>
<tr>
<td>Command &lt; filename</td>
<td>Command命令以 filename 文件作为<strong>标准输入</strong></td>
</tr>
<tr>
<td>Command &lt;&lt; delimiter</td>
<td>从<strong>标准输入</strong>中读入，直到遇到 delimiter 分界符</td>
</tr>
</tbody>
</table>
<h4 id="2-3-绑定重定向"><a href="#2-3-绑定重定向" class="headerlink" title="2.3 绑定重定向"></a>2.3 绑定重定向</h4><table>
<thead>
<tr>
<th>命令</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>Command &gt;&amp;m</td>
<td>把<strong>标准输出</strong>重定向到文件描述符m中</td>
</tr>
<tr>
<td>Command &lt;&amp;m</td>
<td>读取文件描述符m的<strong>标准输入</strong></td>
</tr>
</tbody>
</table>
<hr>
<h3 id="3-重定向例子"><a href="#3-重定向例子" class="headerlink" title="3.重定向例子"></a>3.重定向例子</h3><h4 id="3-1-错误信息重定向空设备"><a href="#3-1-错误信息重定向空设备" class="headerlink" title="3.1 错误信息重定向空设备"></a>3.1 错误信息重定向空设备</h4><p>若Command出错，将错误信息重定向到空设备</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Command 2 &gt; /dev/null</div></pre></td></tr></table></figure>
<h4 id="3-2-文本块重定向作为标注输入"><a href="#3-2-文本块重定向作为标注输入" class="headerlink" title="3.2 文本块重定向作为标注输入"></a>3.2 文本块重定向作为标注输入</h4><p>将文本块重定向到test.txt</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">cat &lt;&lt;EOF &gt;&gt;test.txt</div><div class="line">hello</div><div class="line">EOF</div></pre></td></tr></table></figure>
<h4 id="3-3-用户自定义文件描述符"><a href="#3-3-用户自定义文件描述符" class="headerlink" title="3.3 用户自定义文件描述符"></a>3.3 用户自定义文件描述符</h4><p>0、1、2为shell保留文件描述符，可以自定义文件描述符，对其进行读写，用户自定义文件描述符用<code>exec</code>命令进行创建，创建的文件描述符有三种形式</p>
<h5 id="3-3-1-只读方式"><a href="#3-3-1-只读方式" class="headerlink" title="3.3.1 只读方式"></a>3.3.1 只读方式</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">exec</span> descriptor&lt;filename</div></pre></td></tr></table></figure>
<p>只读方式的文件描述符只能读取一次，要再次读取，需要对文件描述符重新打开赋值，以文件描述符3为例</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">exec</span> 3&lt;test.txt</div><div class="line">cat &lt;&amp;3</div></pre></td></tr></table></figure>
<p>如果在读取一次之后，再次执行<code>cat &lt;&amp;3</code>，不输入任何内容</p>
<h5 id="3-3-2-截断模式写方式"><a href="#3-3-2-截断模式写方式" class="headerlink" title="3.3.2 截断模式写方式"></a>3.3.2 截断模式写方式</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">exec descriptor&gt;filename</div></pre></td></tr></table></figure>
<p>截断模式相当于重新创建文件，文件之前的内容会被清空，以文件描述符4为例，</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">exec</span> 4&gt;test.txt</div><div class="line"><span class="built_in">echo</span> <span class="string">"1"</span> &gt;&amp;4</div><div class="line"><span class="built_in">echo</span> <span class="string">"2"</span> &gt;&amp;4</div><div class="line"><span class="built_in">exec</span> 4&gt;test.txt</div><div class="line"><span class="built_in">echo</span> <span class="string">"3"</span> &gt;&amp;4</div></pre></td></tr></table></figure>
<p>最终test.txt的内容为3</p>
<h5 id="3-3-3-追加模式写方式"><a href="#3-3-3-追加模式写方式" class="headerlink" title="3.3.3 追加模式写方式"></a>3.3.3 追加模式写方式</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">exec descriptor&gt;&gt;filename</div></pre></td></tr></table></figure>
<p>写方式的文件描述符只要一次打开便可多次写入，并且后续的写入操作会一直追加到文件的结尾，以文件描述符5为例</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">exec</span> 5&gt;&gt;test.txt</div><div class="line"><span class="built_in">echo</span> <span class="string">"1"</span> &gt;&amp;5</div><div class="line"><span class="built_in">echo</span> <span class="string">"2"</span> &gt;&amp;5</div><div class="line"><span class="built_in">exec</span> 5&gt;&gt;test.txt</div><div class="line"><span class="built_in">echo</span> <span class="string">"3"</span> &gt;&amp;5</div></pre></td></tr></table></figure>
<p>最后test.txt的结果为 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td></tr></table></figure>
<h4 id="3-4-重定向读取文件"><a href="#3-4-重定向读取文件" class="headerlink" title="3.4  重定向读取文件"></a>3.4  重定向读取文件</h4><p>逐行读取一个文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">while</span> <span class="built_in">read</span> LINE</div><div class="line"><span class="keyword">do</span></div><div class="line"><span class="built_in">echo</span> <span class="variable">$LINE</span></div><div class="line"><span class="keyword">done</span> &lt; <span class="variable">$FILENAME</span></div></pre></td></tr></table></figure>
<hr>
<h3 id="4-参考"><a href="#4-参考" class="headerlink" title="4. 参考"></a>4. 参考</h3><ul>
<li><a href="http://blog.csdn.net/cjfeii/article/details/10084343" target="_blank" rel="external">http://blog.csdn.net/cjfeii/article/details/10084343</a></li>
<li><a href="http://blog.chinaunix.net/uid-20671208-id-3588619.html" target="_blank" rel="external">http://blog.chinaunix.net/uid-20671208-id-3588619.html</a></li>
</ul>

        
      
    </div>

    
  </article>

    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2017/01/16/AWK学习/">AWK 学习</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2017年1月16日
        </span>
      </div>
    </header>

    

    <div class="post-content">
      
        

        
          <h3 id="1-示例文件"><a href="#1-示例文件" class="headerlink" title="1. 示例文件"></a>1. 示例文件</h3><p>示例文件内容如下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">$ cat file</div><div class="line">Unix,10,A</div><div class="line">Linux,30,B</div><div class="line">Solaris,40,C</div><div class="line">Fedora,20,D</div><div class="line">Ubuntu,50,E</div></pre></td></tr></table></figure>
<hr>
<h3 id="2-操作"><a href="#2-操作" class="headerlink" title="2. 操作"></a>2. 操作</h3><h4 id="在原第一列前处添加新的一列"><a href="#在原第一列前处添加新的一列" class="headerlink" title="在原第一列前处添加新的一列"></a>在原第一列前处添加新的一列</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">$ awk -F, <span class="string">'&#123;$1=++i FS $1;&#125;1'</span> OFS=, file</div><div class="line">1,Unix,10,A</div><div class="line">2,Linux,30,B</div><div class="line">3,Solaris,40,C</div><div class="line">4,Fedora,20,D</div><div class="line">5,Ubuntu,50,E</div></pre></td></tr></table></figure>
<p><strong>F</strong>代表分隔符，使用的分割符为 <strong>,</strong> ，将<strong>\$1</strong>替换为<strong>++i</strong> 的结果 加<strong>FS</strong>（分隔符）加原<strong>\$1</strong>，可以理解为<code>\$1=(++i) + FS + $1</code>。后面的<strong>1</strong>代表打印全部。可以通过下面方式设置<strong>i</strong>的初始值。<strong>OFS</strong>代表输出的分隔符，也为 <strong>,</strong> </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ awk -F,  -v=10 <span class="string">'&#123;$1=++i FS $1;&#125;1'</span> OFS=, file</div><div class="line">$ awk -F,   <span class="string">'&#123;$1=++i FS $1;&#125;1'</span> i=10 OFS=, file</div></pre></td></tr></table></figure>
<p>如果不只是添加数字，还要添加个前缀，如下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ awk -F, <span class="string">'&#123;$1="VM"++i FS $1;&#125;1'</span> OFS=, file</div></pre></td></tr></table></figure>
<h4 id="在原最后一列后添加一列"><a href="#在原最后一列后添加一列" class="headerlink" title="在原最后一列后添加一列"></a>在原最后一列后添加一列</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">$ awk -F, <span class="string">'&#123;$(NF+1)=++i;&#125;1'</span> OFS=, file</div><div class="line">Unix,10,A,1</div><div class="line">Linux,30,B,2</div><div class="line">Solaris,40,C,3</div><div class="line">Fedora,20,D,4</div><div class="line">Ubuntu,50,E,5</div></pre></td></tr></table></figure>
<p><strong>NF</strong>代表一行的列数，<strong>NF+1</strong>列为循环产生的数字，然后打印出来</p>
<h4 id="在原最后一列后添加两列"><a href="#在原最后一列后添加两列" class="headerlink" title="在原最后一列后添加两列"></a>在原最后一列后添加两列</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">$ awk -F, <span class="string">'&#123;$(NF+1)=++i FS "X";&#125;1'</span> OFS=, file</div><div class="line">Unix,10,A,1,X</div><div class="line">Linux,30,B,2,X</div><div class="line">Solaris,40,C,3,X</div><div class="line">Fedora,20,D,4,X</div><div class="line">Ubuntu,50,E,5,X</div></pre></td></tr></table></figure>
<h4 id="在原倒数第二列前添加一列"><a href="#在原倒数第二列前添加一列" class="headerlink" title="在原倒数第二列前添加一列"></a>在原倒数第二列前添加一列</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">$ awk -F, <span class="string">'&#123;$(NF-1)=++i FS $(NF-1);&#125;1'</span> OFS=, file</div><div class="line">Unix,1,10,A</div><div class="line">Linux,2,30,B</div><div class="line">Solaris,3,40,C</div><div class="line">Fedora,4,20,D</div><div class="line">Ubuntu,5,50,E</div></pre></td></tr></table></figure>
<p><strong>NF-1</strong>指倒数第二列</p>
<h4 id="更新一列的内容"><a href="#更新一列的内容" class="headerlink" title="更新一列的内容"></a>更新一列的内容</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">$ awk -F, <span class="string">'&#123;$2+=10;&#125;1'</span> OFS=, file</div><div class="line">Unix,20,A</div><div class="line">Linux,40,B</div><div class="line">Solaris,50,C</div><div class="line">Fedora,30,D</div><div class="line">Ubuntu,60,E</div></pre></td></tr></table></figure>
<h4 id="大小写转化"><a href="#大小写转化" class="headerlink" title="大小写转化"></a>大小写转化</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">$ awk -F, <span class="string">'&#123;$1=toupper($1)&#125;1'</span> OFS=, file</div><div class="line">UNIX,10,A</div><div class="line">LINUX,30,B</div><div class="line">SOLARIS,40,C</div><div class="line">FEDORA,20,D</div><div class="line">UBUNTU,50,E</div></pre></td></tr></table></figure>
<h4 id="字符串截取"><a href="#字符串截取" class="headerlink" title="字符串截取"></a>字符串截取</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">$ awk -F, <span class="string">'&#123;$1=substr($1,0,3)&#125;1'</span> OFS=, file</div><div class="line">Uni,10,A</div><div class="line">L<span class="keyword">in</span>,30,B</div><div class="line">Sol,40,C</div><div class="line">Fed,20,D</div><div class="line">Ubu,50,E</div></pre></td></tr></table></figure>
<h4 id="清空某一列"><a href="#清空某一列" class="headerlink" title="清空某一列"></a>清空某一列</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">$ awk -F, <span class="string">'&#123;$2="";&#125;1'</span> OFS=, file</div><div class="line">Unix,,A</div><div class="line">Linux,,B</div><div class="line">Solaris,,C</div><div class="line">Fedora,,D</div><div class="line">Ubuntu,,E</div></pre></td></tr></table></figure>
<h4 id="删除某一列"><a href="#删除某一列" class="headerlink" title="删除某一列"></a>删除某一列</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">$ awk -F, <span class="string">'&#123;for(i=1;i&lt;=NF;i++) if(i!=x) f=f?f FS $i:$i; print f; f=""&#125;'</span> x=2 file</div><div class="line">Unix,A</div><div class="line">Linux,B</div><div class="line">Solaris,C</div><div class="line">Fedora,D</div><div class="line">Ubuntu,E</div></pre></td></tr></table></figure>
<p><strong>for(i=1;i&lt;=NF;i++)</strong>处理每一行的每一列， <strong>if(i!=x)</strong>判断当前列号是否要删除，如果要删除的，不执行下面的步骤。 <strong>f=f?f FS \$i:\$i</strong>，如果f没被赋值，则是<strong>$i</strong>，如果已经赋值了，则为<strong>f FS \$i</strong></p>
<h4 id="修改分隔符"><a href="#修改分隔符" class="headerlink" title="修改分隔符"></a>修改分隔符</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">$ awk -F, <span class="string">'&#123;$2=$2":"$x; for(i=1;i&lt;=NF;i++) if(i!=x) f=f?f FS $i:$i; print f;f=""&#125;'</span> x=3 file</div><div class="line">Unix,10:A</div><div class="line">Linux,30:B</div><div class="line">Solaris,40:C</div><div class="line">Fedora,20:D</div><div class="line">Ubuntu,50:E</div></pre></td></tr></table></figure>
<hr>
<h3 id="3-拓展"><a href="#3-拓展" class="headerlink" title="3. 拓展"></a>3. 拓展</h3><ul>
<li>head和tail如果选择多个范围</li>
</ul>
<hr>
<h3 id="4-例子"><a href="#4-例子" class="headerlink" title="4. 例子"></a>4. 例子</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">awk  <span class="string">'&#123;$(NF+1)="z52-vm"++i; $(NF+1)="130.5.70."++j;print&#125;'</span> j=131 floating_ip_disassociate.sh</div></pre></td></tr></table></figure>

        
      
    </div>

    
  </article>

    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2016/11/14/NetGear 刷 OpenWrt/">NetGear 刷OpenWRT</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2016年11月14日
        </span>
      </div>
    </header>

    

    <div class="post-content">
      
        

        
          <h3 id="1-准备工作"><a href="#1-准备工作" class="headerlink" title="1. 准备工作"></a>1. 准备工作</h3><p>正式开始刷机之前，需要准备一些软件和工具。</p>
<ul>
<li>Xshell</li>
<li>WinSCP</li>
<li>TFTP客户端</li>
<li>网线</li>
</ul>
<hr>
<h3 id="2-OpenWRT"><a href="#2-OpenWRT" class="headerlink" title="2. OpenWRT"></a>2. OpenWRT</h3><h4 id="NetGear路由器固件初始化"><a href="#NetGear路由器固件初始化" class="headerlink" title="NetGear路由器固件初始化"></a>NetGear路由器固件初始化</h4><p>根据NetGear路由器说明书，将路由器的WAN接口（黄色）连接到上级ISP提供的网络接口，再将任意LAN接口（蓝色）连接到PC，确认PC正常连接到路由器之后，则可以对路由器进行初始化了，初始化步骤请参考说明书，登录路由器管理界面的默认帐号是admin，密码是password，管理IP是192.168.1.1。</p>
<h4 id="下载OpenWRT固件"><a href="#下载OpenWRT固件" class="headerlink" title="下载OpenWRT固件"></a>下载OpenWRT固件</h4><p>首先下载对应NetGear硬件型号的OpenWRT固件，下载地址请点击<a href="http://downloads.OpenWRT.org" target="_blank" rel="external">这里</a>，可以下载最新版本或者历史版本，以现在最新版本15.05.1 Chaos Calmer 版本为例，需要下载两个文件，根据不同的硬件，其文件命名方式也不同，主要有CPU架构、闪存和路由器硬件型号的区别：</p>
<ul>
<li>OpenWRT-15.05.1-[架构]-[闪存类型]-[路由器硬件型号]-ubi-factory.img，从Netgear固件升级到OpenWRT。</li>
<li>OpenWRT-15.05.1-[架构]-[闪存类型]-[路由器硬件型号]-squashfs-sysupgrade.tar, 从其他OpenWRT版本升级或者降级到当前版本。</li>
</ul>
<h4 id="刷入OpenWRT"><a href="#刷入OpenWRT" class="headerlink" title="刷入OpenWRT"></a>刷入OpenWRT</h4><p>进入Netgear官方固件的网页管理页面</p>
<ul>
<li>配置位置：高级管理 → 固件升级</li>
<li>OpenWRT-15.05.1-[架构]-[闪存类型]-[路由器硬件型号]-ubi-factory.img固件文件</li>
<li>点击固件升级，确认升级</li>
</ul>
<p>等待几分钟，完成OpenWRT的刷入。</p>
<h4 id="OpenWRT固件升级"><a href="#OpenWRT固件升级" class="headerlink" title="OpenWRT固件升级"></a>OpenWRT固件升级</h4><p>在刷完OpenWRT之后，登录<a href="http://192.168.1.1" target="_blank" rel="external">http://192.168.1.1</a>进行偏好设置等，账户为root，缺省密码为空。这时先不要着急进行偏好设置，首先进行系统升级，刷入最新的固件</p>
<ul>
<li>配置位置：System → Backup/Flash Firmware → Flash new firmware image</li>
<li>上传OpenWRT-15.05.1-[架构]-[闪存类型]-[路由器硬件型号]-squashfs-sysupgrade.tar</li>
<li>点击Flash image，确认升级</li>
</ul>
<p>过几分钟后，升级到最新固件，这时候可以进行偏好设置</p>
<hr>
<h3 id="3-OpenWRT网络基本讲解"><a href="#3-OpenWRT网络基本讲解" class="headerlink" title="3. OpenWRT网络基本讲解"></a>3. OpenWRT网络基本讲解</h3><h4 id="网卡介绍"><a href="#网卡介绍" class="headerlink" title="网卡介绍"></a>网卡介绍</h4><ul>
<li><a href="http://wiki.openwrt.org/zh-cn/doc/uci/network/switch" target="_blank" rel="external">交换机手册</a></li>
<li><a href="http://wiki.openwrt.org/zh-cn/doc/networking/network.interfaces" target="_blank" rel="external">Linux 网络接口</a><h4 id="Interface"><a href="#Interface" class="headerlink" title="Interface"></a>Interface</h4></li>
<li>LAN：缺省的IPv4网络虚拟适配器，用户本地局域网，缺省IP地址192.168.1.1/24，默认开启了IPv4 DHCP服务器，也开启了IPv6 DHCP服务器，防火墙区域为lan。</li>
<li>WAN：缺省的IPv4网络虚拟适配器，DHCP客户端模式，用于从上级ISP获取IP地址，防火前区域位于wan</li>
<li>WAN6：缺省的IPv6网络虚拟适配器，DHCPv6客户端模式，可以从上级ISP获取IPv6地址，防火墙区域位于wan<h4 id="WiFi"><a href="#WiFi" class="headerlink" title="WiFi"></a>WiFi</h4>一般拥有双频的设备会有两个SSID，两个无线信号，都桥接到eth0.1<h4 id="Firewall"><a href="#Firewall" class="headerlink" title="Firewall"></a>Firewall</h4></li>
<li>lan： LAN接口所在的网络，转发wan。</li>
<li>wan：WAN、WAN6接口所在网络，转发到ISP，具有NAT功能。<h4 id="Switch"><a href="#Switch" class="headerlink" title="Switch"></a>Switch</h4>每个端口在分组中有三个选项： </li>
<li>off：这一分组中不使用这个接口 </li>
<li>untagged：这个接口将被直接桥接到这个分组 </li>
<li>tagged：这个接口需要通过VLAN ID来访问这一分组</li>
</ul>
<p>以个人购买的Netgear WNDR3700V1为例，LAN接口映射：</p>
<table>
<thead>
<tr>
<th style="text-align:center">路由器端口物理标识</th>
<th style="text-align:center">OpenWRT端口管理标识</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">1</td>
<td style="text-align:center">port 3</td>
</tr>
<tr>
<td style="text-align:center">2</td>
<td style="text-align:center">port 2</td>
</tr>
<tr>
<td style="text-align:center">3</td>
<td style="text-align:center">port 1</td>
</tr>
<tr>
<td style="text-align:center">4</td>
<td style="text-align:center">port 0</td>
</tr>
</tbody>
</table>
<h3 id="4-OpenWRT网络设置"><a href="#4-OpenWRT网络设置" class="headerlink" title="4. OpenWRT网络设置"></a>4. OpenWRT网络设置</h3><h4 id="IPv4-设置"><a href="#IPv4-设置" class="headerlink" title="IPv4 设置"></a>IPv4 设置</h4><p>系统缺省已经有了IPv4的NAT设置。如果想折腾，自行研究。</p>
<blockquote>
<p><span style="color:red">提示：</span>在进行修改任何文件之前，一定要做好备份，方便修改造成任何问题之后恢复。</p>
</blockquote>
<h4 id="IPv6-设置"><a href="#IPv6-设置" class="headerlink" title="IPv6 设置"></a>IPv6 设置</h4><p>修改/etc/config/dhcp文件，添加如下部分</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">config dhcp &apos;lan&apos;</div><div class="line">	option dhcpv6 &apos;relay&apos;</div><div class="line">	option ra &apos;relay&apos;</div><div class="line">	option ndp &apos;relay&apos;</div><div class="line"></div><div class="line">config dhcp &apos;wan6&apos;</div><div class="line">	option interfere &apos;wan&apos;</div><div class="line">	option dhcpv6 &apos;relay&apos;</div><div class="line">	option ra &apos;relay&apos;</div><div class="line">	option ndp &apos;relay&apos;</div><div class="line">	option master &apos;1&apos;</div></pre></td></tr></table></figure>
<p>设置好上面的两个文件之后，重启odhcpd服务，否则接入设备无法获取IPv6地址</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/etc/init.d/odhcpd restart</div></pre></td></tr></table></figure>
<p>这种方式可以获取原生的IPv6地址，需要注意的是每次路由器重启上述配置并不会生效，需要重启下odhcpd服务接入的终端设备方可获取IPv6地址。可以在开机启动脚本<code>/etc/rc.local</code>中添加如下脚本，每次开机后系统启动60秒后重启odhcpd服务。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">sleep 30</div><div class="line">/etc/init.d/odhcpd restart</div></pre></td></tr></table></figure>
<hr>
<h3 id="5-USB磁盘挂载"><a href="#5-USB磁盘挂载" class="headerlink" title="5. USB磁盘挂载"></a>5. USB磁盘挂载</h3><h4 id="磁盘设置"><a href="#磁盘设置" class="headerlink" title="磁盘设置"></a>磁盘设置</h4><p>在任意linux系统上，使用fdisk工具，对整块磁盘进行如下分区</p>
<ul>
<li>第一个分区512MB，将来作为路由器的交换空间</li>
<li>第二个分区为剩下的空间，格式为ext4文件系统，作为存储空间</li>
</ul>
<h4 id="应用安装"><a href="#应用安装" class="headerlink" title="应用安装"></a>应用安装</h4><p>安装应用前进行源更新<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">opkg update</div></pre></td></tr></table></figure></p>
<p>需要安装的程序<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">opkg install block-mount</div><div class="line">opkg install kmod-usb-storage</div><div class="line">opkg install kmod-usb-storage-extras</div><div class="line">opkg install kmod-fs-ext4</div><div class="line">opkg install fdisk</div></pre></td></tr></table></figure></p>
<p>安装格式化工具<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">e2fsprogs</div></pre></td></tr></table></figure></p>
<p>最好使用ext4文件格式的文件系统，这样效率最高，不建议使用ntfs或者vfat，磁盘可以在其他Linux系统上格式化</p>
<h4 id="应用设置"><a href="#应用设置" class="headerlink" title="应用设置"></a>应用设置</h4><p>安装上述程序后，虽然设置网页Luci管理端出现了<strong>System → Mount Points</strong>，但是无法访问，需要如下设置：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">block detect &gt; /etc/config/fstab</div></pre></td></tr></table></figure></p>
<p>设置开机启动并启动<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">/etc/init.d/fstab enable</div><div class="line">block mount</div></pre></td></tr></table></figure></p>
<h4 id="网页管理设置"><a href="#网页管理设置" class="headerlink" title="网页管理设置"></a>网页管理设置</h4><ul>
<li>配置位置：System → Mount Points</li>
<li>Mount Points：选择第二分区挂载</li>
<li>SWAP：选择第一个分区挂载</li>
</ul>
<p>也可以在命令下进行设置挂载，但是在网页端就不会显示了，只会显示挂载的结果。</p>
<h3 id="6-Transmission"><a href="#6-Transmission" class="headerlink" title="6. Transmission"></a>6. Transmission</h3><h4 id="应用安装-1"><a href="#应用安装-1" class="headerlink" title="应用安装"></a>应用安装</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">opkg update</div><div class="line">opkg install transmission-daemon    </div><div class="line">opkg install transmission-cli 		     </div><div class="line">opkg install transmission-web</div><div class="line">opkg install transmission-remote</div><div class="line">opkg install luci-app-transmission</div></pre></td></tr></table></figure>
<h4 id="应用设置-1"><a href="#应用设置-1" class="headerlink" title="应用设置"></a>应用设置</h4><p>设置开机启动并启动transmission<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">/etc/init.d/transmission enable</div><div class="line">/etc/init.d/transmission start</div></pre></td></tr></table></figure></p>
<p>执行如下命令，启动一下 transmission-daemon<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">transmission-daemon</div></pre></td></tr></table></figure></p>
<p>关闭transmission-daemon<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">killall transmission-daemon</div></pre></td></tr></table></figure></p>
<p>编辑/root/.config/transmission-daemon/settings.json文件<br>改”rpc-whitelist”: “127.0.0.1”, 为 “0.0.0.0”，或者将”rpc-whitelist-enabled”: true改成false</p>
<p>再执行 <code>transmission-daemon</code>，就可以启动了在浏览器地址栏输入：<code>http://[管理地址]:9091</code>，添加种子就可以开始BT下载了。</p>
<p>在防火墙里打开TCP 51413端口，可提高下载速度。</p>
<h3 id="7-Samba共享设置"><a href="#7-Samba共享设置" class="headerlink" title="7. Samba共享设置"></a>7. Samba共享设置</h3><h4 id="应用安装-2"><a href="#应用安装-2" class="headerlink" title="应用安装"></a>应用安装</h4><p>可以在OpenWRT下设置Samba文件共享服务器，这样可以通过其他设备访问共享服务器上的资源，首先执行如下命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">opkg update</div><div class="line">opkg install samba36-server</div><div class="line">opkg install luci-app-samba</div></pre></td></tr></table></figure>
<h4 id="应用设置-2"><a href="#应用设置-2" class="headerlink" title="应用设置"></a>应用设置</h4><p>在命令行下启动samba服务并开机启动<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">/etc/init.d/samba start</div><div class="line">/etc/init.d/samba enable</div></pre></td></tr></table></figure></p>
<h4 id="权限设置"><a href="#权限设置" class="headerlink" title="权限设置"></a>权限设置</h4><ul>
<li>配置位置：Services → Network Shares</li>
<li>General Settings<ul>
<li>Path：为共享路径</li>
<li>Allowed users： 允许访问用户，默认不允许root</li>
</ul>
</li>
<li>Edit Template： 注释掉 <code>invalid users = root</code></li>
<li>添加新用户: 在/etc/passwd最后一行添加<code>garlic:*:1000:1000:garlic:/var:/bin/false</code></li>
<li>创建用户密码：命令行执行 <code>smbpasswd -a garlic</code>，设置密码</li>
<li>root用户通过<code>smbpasswd -a root</code>设置密码，root用户有创建文件夹，删除文件等权限，其他用户没有</li>
</ul>
<h3 id="8-问题"><a href="#8-问题" class="headerlink" title="8. 问题"></a>8. 问题</h3><p>如果局域网中有两台OpenWRT路由器，都是用IPv6 Relay模式，有路由器Onion和Garlic</p>
<ul>
<li>Onion WAN IPv6地址：2001:cc0:2026:400:e6f4:c6ff:fee9:d5b</li>
<li>Garlic WAN IPv6地址：2001:cc0:2026:400:2ac6:8eff:fe0f:823f</li>
</ul>
<p>正常使用情况下，连接到Onion的设备路由表为<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">Internet6:</div><div class="line">Destination                             Gateway                         Flags         Netif Expire</div><div class="line">default                                 fe80::e6f4:c6ff:fee9:d5a%en0    UGc             en0</div><div class="line">::1                                     ::1                             UHL             lo0</div><div class="line">2001:cc0:2026:400::/64                  link#4                          UC              en0</div><div class="line">2001:cc0:2026:400:3a22:d6ff:febf:1b00   e4:f4:c6:e9:d:5a                UHLWIi          en0</div><div class="line">2001:cc0:2026:400:717e:7352:6a24:9ca5   ac:bc:32:af:7e:8b               UHL             lo0</div><div class="line">2001:cc0:2026:400:aebc:32ff:feaf:7e8b   ac:bc:32:af:7e:8b               UHL             lo0</div><div class="line">2001:cc0:2026:400:e6f4:c6ff:fee9:d5b    e4:f4:c6:e9:d:5a                UHLWIi          en0</div><div class="line">fe80::%lo0/64                           fe80::1%lo0                     UcI             lo0</div><div class="line">fe80::1%lo0                             link#1                          UHLI            lo0</div><div class="line">fe80::%en0/64                           link#4                          UCI             en0</div><div class="line">fe80::20c:29ff:fe40:7252%en0            link#4                          UHLWIi          en0</div><div class="line">fe80::2ac6:8eff:fe0f:823e%en0           28:c6:8e:f:82:3e                UHLWIi          en0</div><div class="line">fe80::3a22:d6ff:febf:1b00%en0           link#4                          UHLWIi          en0</div><div class="line">fe80::aebc:32ff:feaf:7e8b%en0           ac:bc:32:af:7e:8b               UHLI            lo0</div><div class="line">fe80::e6f4:c6ff:fee9:d5a%en0            e4:f4:c6:e9:d:5a                UHLWIir         en0</div><div class="line">fe80::%awdl0/64                         link#8                          UCI           awdl0</div><div class="line">fe80::5c4e:77ff:fe44:279a%awdl0         5e:4e:77:44:27:9a               UHLI            lo0</div><div class="line">ff01::%lo0/32                           ::1                             UmCI            lo0</div><div class="line">ff01::%en0/32                           link#4                          UmCI            en0</div><div class="line">ff01::%awdl0/32                         link#8                          UmCI          awdl0</div><div class="line">ff02::%lo0/32                           ::1                             UmCI            lo0</div><div class="line">ff02::%en0/32                           link#4                          UmCI            en0</div><div class="line">ff02::%awdl0/32                         link#8                          UmCI          awdl0</div></pre></td></tr></table></figure></p>
<p>在使用过IPv6一段时间后，连接到Onion的设备路由表发生了变化，其默认路由地址变成了fe80::2ac6:8eff:fe0f:823e<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">Internet6:</div><div class="line">Destination                             Gateway                         Flags         Netif Expire</div><div class="line">default                                 fe80::e6f4:c6ff:fee9:d5a%en0    UGc             en0</div><div class="line">::1                                     ::1                             UHL             lo0</div><div class="line">2001:cc0:2026:400::/64                  link#4                          UC              en0</div><div class="line">2001:cc0:2026:400:2ac6:8eff:fe0f:823f   e4:f4:c6:e9:d:5a                UHLWIi          en0</div><div class="line">2001:cc0:2026:400:aebc:32ff:feaf:7e8b   ac:bc:32:af:7e:8b               UHL             lo0</div><div class="line">2001:cc0:2026:400:e6f4:c6ff:fee9:d5b    e4:f4:c6:e9:d:5a                UHLWIi          en0</div><div class="line">fe80::%lo0/64                           fe80::1%lo0                     UcI             lo0</div><div class="line">fe80::1%lo0                             link#1                          UHLI            lo0</div><div class="line">fe80::%en0/64                           link#4                          UCI             en0</div><div class="line">fe80::2ac6:8eff:fe0f:823e%en0           28:c6:8e:f:82:3e                UHLWIi          en0</div><div class="line">fe80::aebc:32ff:feaf:7e8b%en0           ac:bc:32:af:7e:8b               UHLI            lo0</div><div class="line">fe80::e6f4:c6ff:fee9:d5a%en0            e4:f4:c6:e9:d:5a                UHLWIir         en0</div><div class="line">fe80::%awdl0/64                         link#8                          UCI           awdl0</div><div class="line">fe80::5c4e:77ff:fe44:279a%awdl0         5e:4e:77:44:27:9a               UHLI            lo0</div><div class="line">ff01::%lo0/32                           ::1                             UmCI            lo0</div><div class="line">ff01::%en0/32                           link#4                          UmCI            en0</div><div class="line">ff01::%awdl0/32                         link#8                          UmCI          awdl0</div><div class="line">ff02::%lo0/32                           ::1                             UmCI            lo0</div><div class="line">ff02::%en0/32                           link#4                          UmCI            en0</div><div class="line">ff02::%awdl0/32                         link#8                          UmCI          awdl0</div></pre></td></tr></table></figure></p>
<p>推测Onion接收到了Garlic的某些IPv6广播包，所以在Onion的防火墙上配置禁止接收Garlic所有IPv6的数据包，同时禁用Linklocal和Global地址。</p>

        
      
    </div>

    
  </article>

    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2016/10/29/OpenWRT 无线中继/">OpenWRT 无线中继</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2016年10月29日
        </span>
      </div>
    </header>

    

    <div class="post-content">
      
        

        
          <h3 id="1-前言"><a href="#1-前言" class="headerlink" title="1. 前言"></a>1. 前言</h3><h4 id="起因"><a href="#起因" class="headerlink" title="起因"></a>起因</h4><ul>
<li>主路由器Netgear位置远，影响网络体验</li>
<li>设想过在单独置办一个路由器，但是希望两个路由器的局域网之间可以进行通信。</li>
<li>构思通过中继路由器对主路由器的SSID进行中继</li>
</ul>
<h4 id="WDS"><a href="#WDS" class="headerlink" title="WDS"></a>WDS</h4><p>WDS连接，再购买一个Netgear路由器，使得主从路由器通过WDS连接，实现无缝漫游。查阅了NetGear的<a href="http://club.netgear.cn/Knowledgebase/Document.aspx?Did=234" target="_blank" rel="external">官方资料</a>之后，再综合其他资料，如下理由放弃该方案：</p>
<ul>
<li>WDS是非标准协议，不同厂商很可能不兼容，而且芯片、固件版本最好一致。</li>
<li>Netgear官方支持的WDS协议，路由器的加密只支持WEP方式，不支持WPA2。</li>
</ul>
<h4 id="OpenWRT"><a href="#OpenWRT" class="headerlink" title="OpenWRT"></a>OpenWRT</h4><ul>
<li><p>Routed Client Mode， 拓展的路由器网络还有经过一个NAT到上级网络</p>
<center><img src="http://i.imgur.com/OA0NKDF.png" alt=""></center><center style="color:purple"><strong>图1-2 路由客户端模式</strong></center>
</li>
<li><p>Bridged Client Mode (brcm-2.4 only)，拓展的路由器可以和原来的路由器位于同一个网络，后来买路由器网卡不支持，放弃。</p>
<center><img src="http://i.imgur.com/IoXvhfk.png" alt=""></center><center style="color:purple"><strong>图1-3 桥接客户端模式(仅仅brcm-2.4)</strong></center>
</li>
<li><p>Bridged Client Mode (with relayd)，使用relayed软件进行中继，伪桥接方式，<a href="https://wiki.openwrt.org/doc/recipes/relayclient" target="_blank" rel="external">介绍资料</a>。</p>
<center><img src="http://i.imgur.com/uKnMcxw.png" alt=""></center><center style="color:purple"><strong>图1-4 使用relayed桥接客户端模式</strong></center>

</li>
</ul>
<hr>
<h3 id="2-路由客户端模式"><a href="#2-路由客户端模式" class="headerlink" title="2.  路由客户端模式"></a>2.  路由客户端模式</h3><h4 id="连接无线网络"><a href="#连接无线网络" class="headerlink" title="连接无线网络"></a>连接无线网络</h4><ul>
<li>配置位置：Network → WiFi → 选择5G/2.4G网卡 → Scan</li>
<li>出现无线网络列表之后，选择要中继的SSID，本文要中继的SSID是Onion-5G，然后输入无线网路密码</li>
<li>Network选择创建一个新的虚拟适配器WWAN</li>
<li>保存之后，过一会在Network → Interface 会看到一个WWAN的虚拟适配器，并从Onion-5G获取到了IP地址，假设这里是192.168.1.7/24</li>
</ul>
<h4 id="防火墙设置"><a href="#防火墙设置" class="headerlink" title="防火墙设置"></a>防火墙设置</h4><ul>
<li>配置位置：Network → Interface</li>
<li>选择刚才生成的wwan虚拟适配器，然后转到Firewall Settings，确认分配到防火墙区域为wan</li>
<li>保存生效</li>
</ul>
<h4 id="IPv6中继设置"><a href="#IPv6中继设置" class="headerlink" title="IPv6中继设置"></a>IPv6中继设置</h4><p>与之前设置OpenWRT IPv6中继的方法相同</p>
<h4 id="LAN配置"><a href="#LAN配置" class="headerlink" title="LAN配置"></a>LAN配置</h4><p>修改LAN接口IP地址段，因为使用的NAT模式，所以LAN接口的IP地址段不能与主路由器的IP段（192.168.1.0/24）重复，主假设修改的IP地址段为10.10.10.0/24</p>
<h4 id="无线配置"><a href="#无线配置" class="headerlink" title="无线配置"></a>无线配置</h4><p>创建一个新的SSID，并桥接到LAN接口</p>
<ul>
<li>配置位置：Network → WiFi → 选择5G/2.4G网卡 → Add</li>
<li>ESSID：Onion-5G+<ul>
<li>疑问：此处可以设置为Onion-5G吗？SSID相同会有什么干扰吗？</li>
</ul>
</li>
<li>Mode：Access Point</li>
<li>Network： LAN</li>
</ul>
<h4 id="终端连接测试"><a href="#终端连接测试" class="headerlink" title="终端连接测试"></a>终端连接测试</h4><p>此时连接到Onion-5G+的终端设备，可以从主路由器获取192.168.1.0/24地址段的IP地址了</p>
<h4 id="失败总结"><a href="#失败总结" class="headerlink" title="失败总结"></a>失败总结</h4><p>无法将wifi虚拟适配器直接桥接到WWAN接口，如果这样设置，会导致导致WWAN虚拟适配器变为Bridge interface类型，这样WWAN接口无法从主路由器获取IP地址，因此整个路由器也不能连接到网络了。</p>
<hr>
<h3 id="3-使用relayd桥接客户端模式"><a href="#3-使用relayd桥接客户端模式" class="headerlink" title="3. 使用relayd桥接客户端模式"></a>3. 使用relayd桥接客户端模式</h3><h4 id="软件安装"><a href="#软件安装" class="headerlink" title="软件安装"></a>软件安装</h4><ul>
<li>relayd</li>
<li>luci-proto-relay<h4 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h4></li>
<li>创建一个新的网络192.168.2.0/24, 用来正常访问路由器，<span style="color:red">否则在完成relay桥接模式后无法访问从路由器</span>，所以创建一个LAN2用来保证可以正常访问路由器</li>
<li>ssh管理切换到LAN2</li>
<li>无法通过WAN，WWAN接口的IP地址段访问luci网页管理端，只能通过LAN地址段访问luci网页管理端。</li>
</ul>
<h4 id="连接无线网络-1"><a href="#连接无线网络-1" class="headerlink" title="连接无线网络"></a>连接无线网络</h4><ul>
<li>配置位置：Network → WiFi → 选择5G/2.4G网卡 → Scan</li>
<li>出现无线网络列表之后，选择要中继的SSID，本文要中继的SSID是Onion-5G，然后输入无线网路密码</li>
<li>Network选择创建一个新的虚拟适配器WWAN</li>
<li>保存之后，过一会在Network → Interface 会看到一个WWAN的虚拟适配器，并从Onion-5G获取到了IP地址，假设这里是192.168.1.7/24</li>
</ul>
<h4 id="防火墙设置-1"><a href="#防火墙设置-1" class="headerlink" title="防火墙设置"></a>防火墙设置</h4><ul>
<li>配置位置：Network → Interface</li>
<li>选择刚才生成的wwan虚拟适配器，然后转到Firewall Settings，<span style="color:red">确认分配到防火墙区域为lan，不是wan</span></li>
<li>保存生效</li>
</ul>
<h4 id="关闭LAN接口-DHCP功能"><a href="#关闭LAN接口-DHCP功能" class="headerlink" title="关闭LAN接口 DHCP功能"></a>关闭LAN接口 DHCP功能</h4><p>关闭lLAN接口的DHCP功能，保证客户端可以从主路由器获取IP地址</p>
<h4 id="桥接适配器创建"><a href="#桥接适配器创建" class="headerlink" title="桥接适配器创建"></a>桥接适配器创建</h4><ul>
<li>配置位置：Network → Interface → Add new interface</li>
<li>Protocol：Relay Bridge</li>
<li>Relay between Network：lan wwan</li>
<li>保存设置</li>
</ul>
<h4 id="无线配置-1"><a href="#无线配置-1" class="headerlink" title="无线配置"></a>无线配置</h4><ul>
<li>配置位置：Network → WiFi → 选择5G/2.4G网卡 → Add</li>
<li>ESSID：Onion-5G<ul>
<li>疑问：此处可以设置为Onion-5G吗？SSID相同会有什么干扰吗？</li>
</ul>
</li>
<li>Mode：Access Point</li>
<li>Network： LAN</li>
</ul>
<h4 id="终端连接测试-1"><a href="#终端连接测试-1" class="headerlink" title="终端连接测试"></a>终端连接测试</h4><p>此时连接到Onion-5G的终端设备，可以从主路由器获取192.168.1.0/24地址段的IP地址了，可以实现设备无缝漫游了</p>
<h4 id="配置文件示例"><a href="#配置文件示例" class="headerlink" title="配置文件示例"></a>配置文件示例</h4><p>使用luci网页配置可能有问题，可以直接修改配置文件并重启网络</p>
<ul>
<li><p>/etc/config/network</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">config interface &apos;lan&apos;</div><div class="line">	option ifname &apos;eth0&apos;</div><div class="line">	option type &apos;bridge&apos;</div><div class="line">	option proto &apos;static&apos;</div><div class="line">	option netmask &apos;255.255.255.0&apos;</div><div class="line">	option ipaddr &apos;192.168.2.1&apos; </div><div class="line"></div><div class="line">config interface &apos;stabridge&apos; </div><div class="line">	option proto &apos;relay&apos;</div><div class="line">	option network &apos;lan wwan&apos;</div><div class="line"></div><div class="line">config interface &apos;wwan&apos;</div><div class="line">	option proto &apos;dhcp&apos;</div></pre></td></tr></table></figure>
</li>
<li><p>/etc/config/dhcp</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">option interface        lan</div><div class="line">	option start         100</div><div class="line">	option limit        150</div><div class="line">	option leasetime        12h</div><div class="line">	option ignore 1          #这一行添加，关掉lan的dhcp功能</div></pre></td></tr></table></figure>
</li>
<li><p>/etc/config/firewall</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">config zone</div><div class="line">	option name &apos;lan&apos;</div><div class="line">	option input &apos;ACCEPT&apos;</div><div class="line">	option output &apos;ACCEPT&apos;</div><div class="line">	option forward &apos;ACCEPT&apos;       #修改前为REJECT</div><div class="line">	option network &apos;lan wwan&apos;     #添加了wwan</div></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="测试后记"><a href="#测试后记" class="headerlink" title="测试后记"></a>测试后记</h4><p>试用了一天之后，发现通过relayd方式分别连接到主从路由器的设备之间ping延时很高，因此不得不放弃这种方式。</p>
<hr>
<h3 id="4-局域网之间路由模式"><a href="#4-局域网之间路由模式" class="headerlink" title="4. 局域网之间路由模式"></a>4. 局域网之间路由模式</h3><h4 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h4><p>OpenWRT固件和Netgear官方固件都拥有自定义路由表的接口，两个路由器之间通过无线进行连接，分别在两个路由器上配置相互局域网转发的路由表。</p>
<h4 id="防火墙设置-2"><a href="#防火墙设置-2" class="headerlink" title="防火墙设置"></a>防火墙设置</h4><ul>
<li>创建wlan区域，为Netgear固件路由器所在区域</li>
<li>允许wlan转到lan，同时lan也可以转发到wlan，其中lan为OpenWRT固件所在区域。</li>
<li>只允许IPv4转发，禁止IPv6转发</li>
</ul>
<h4 id="路由表"><a href="#路由表" class="headerlink" title="路由表"></a>路由表</h4><h5 id="OpenWRT静态路由设置"><a href="#OpenWRT静态路由设置" class="headerlink" title="OpenWRT静态路由设置"></a>OpenWRT静态路由设置</h5><ul>
<li>配置位置：Network → WiFi → 选择5G/2.4G网卡 → Scan</li>
<li>出现无线网络列表之后，选择要中继的SSID，本文要中继的SSID是Onion-2.4G，然后输入无线网路密码</li>
<li>Network选择创建一个新的虚拟适配器WLAN，防火墙区域为wlan</li>
<li>保存之后，过一会在Network → Interface 会看到一个WLAN的虚拟适配器，并从Onion-2.4G获取到了IP地址，假设这里是192.168.1.2/24</li>
</ul>
<p>SSH连接到路由器后查看路由表，如下。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">Kernel IP routing table</div><div class="line">Destination     Gateway         Genmask         Flags Metric Ref    Use Iface</div><div class="line">default         192.168.1.1     0.0.0.0         UG    0      0        0 eth1</div><div class="line">10.30.0.0       *               255.255.224.0   U     0      0        0 eth1</div><div class="line">10.30.0.254     *               255.255.255.255 UH    0      0        0 eth1</div><div class="line">192.168.1.0     *               255.255.255.0   U     0      0        0 wlan0</div><div class="line">192.168.1.1     *               255.255.255.255 UH    0      0        0 wlan0</div><div class="line">192.168.2.0     *               255.255.255.0   U     0      0        0 br-lan</div></pre></td></tr></table></figure></p>
<p>从上述路由表可以看出，这时候所有本地的流量也被转发到192.168.1.1，不需要转发所有的流量，因为需要避免wlan0成为默认路由的出口，修改虚拟适配器WLAN的选项，修改文件/etc/conf/network<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">config interface &apos;wlan&apos;       </div><div class="line">        option proto &apos;dhcp&apos;  </div><div class="line">        option defaultroute &apos;0&apos;</div></pre></td></tr></table></figure></p>
<p>手动修改回正确的默认路由，这样路由器每次重启之后，或者连接到Onion-2.4G后，不会把Onion-2.4G的网络当作默认路由了。</p>
<h5 id="Netgear静态路由设置"><a href="#Netgear静态路由设置" class="headerlink" title="Netgear静态路由设置"></a>Netgear静态路由设置</h5><p>添加到192.168.2.0/24的路由表条目，网关地址为192.168.2.1，即为OpenWRT的IP的地址。</p>
<h4 id="问题总结"><a href="#问题总结" class="headerlink" title="问题总结"></a>问题总结</h4><ul>
<li>速度不稳定，ping延时有时候会很高</li>
</ul>

        
      
    </div>

    
  </article>

    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2016/09/29/CentOS Minimal X11转发/">CentOS Minimal X11转发</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2016年9月29日
        </span>
      </div>
    </header>

    

    <div class="post-content">
      
        

        
          <h3 id="1-X11安装以SSH设置"><a href="#1-X11安装以SSH设置" class="headerlink" title="1. X11安装以SSH设置"></a>1. X11安装以SSH设置</h3><h4 id="X11安装"><a href="#X11安装" class="headerlink" title="X11安装"></a>X11安装</h4><p>下载CentOS所需要的软件包，命令如下所示。安装xterm，以及xorg-x11-xauth和相关依赖。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">yum -y install xterm xorg-x11-xauth</div><div class="line">yum -y  install libXext libXtst libXi twm</div></pre></td></tr></table></figure>
<h4 id="SSH设置"><a href="#SSH设置" class="headerlink" title="SSH设置"></a>SSH设置</h4><p>修改/etc/ssh/sshd_config</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">AllowTcpForwarding yes</div><div class="line">X11Forwarding yes</div></pre></td></tr></table></figure>
<p>修改之后，重启ssh服务</p>
<h4 id="其他问题"><a href="#其他问题" class="headerlink" title="其他问题"></a>其他问题</h4><ul>
<li>若是postfix服务无法启动，则使用postfix set-permissions命令查看原因，可能原因之一因为hosts文件中缺失对localhost地址的解析，所以导致了postfix服务无法启动。</li>
</ul>
<ul>
<li>hosts文件中确实对localhost的解析，可能导致了X11无法转发。</li>
</ul>
<hr>
<h3 id="2-软件设置"><a href="#2-软件设置" class="headerlink" title="2. 软件设置"></a>2. 软件设置</h3><h4 id="xshell设置"><a href="#xshell设置" class="headerlink" title="xshell设置"></a>xshell设置</h4><p>在设置完基本的SSH登录之后，在隧道选项中添加如下信息，如图1-1所示。</p>
<center><img src="http://qingdao.icean.cc:11234/Imgbed/X11_forwarding/1-1.jpg" alt=""></center><br><center style="color:purple"><strong>图1-1</strong></center>

<p>但是xshell在通过IPv6登录到主机时候，不能成功执行，根据strace的结果，应该是xshell软件的问题或者xshell设置的问题。</p>
<h4 id="putty设置"><a href="#putty设置" class="headerlink" title="putty设置"></a>putty设置</h4><p>安装Xming，<a href="https://sourceforge.net/projects/xming/" target="_blank" rel="external">下载地址</a>，安装之后，在执行X11 Forwarding之前，需要启动X11。</p>
<p>启动putty，选择Connection-&gt;SSH-&gt;X11，启动X11 Forwarding，如图2-1所示。</p>
<center> <img src="http://qingdao.icean.cc:11234/Imgbed/X11_forwarding/1-2.jpg" alt="1-2"></center>

<center style="color:purple"><strong>图2-1</strong></center>

<p>然后再设置SSH登录的服务器、账户和密码等。这时候SSH通过IPv4和IPv6登录均可启动X11 Forwarding。</p>

        
      
    </div>

    
  </article>

    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2016/09/29/CentOS 7.x ocserv + freeradius验证 + ssl/">CentOS 7.x ocserv + freeradius验证 + SSL</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2016年9月29日
        </span>
      </div>
    </header>

    

    <div class="post-content">
      
        

        
          <h3 id="1-ocserv安装"><a href="#1-ocserv安装" class="headerlink" title="1.ocserv安装"></a>1.ocserv安装</h3><h4 id="yum安装相关软件"><a href="#yum安装相关软件" class="headerlink" title="yum安装相关软件"></a>yum安装相关软件</h4><p>在CentOS7中，可以直接使用yum安装ocserv</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">yum install epel-release -y</div><div class="line">yum install -y ocserv</div></pre></td></tr></table></figure>
<h4 id="自签名证书生成"><a href="#自签名证书生成" class="headerlink" title="自签名证书生成"></a>自签名证书生成</h4><h5 id="创建相关文件夹"><a href="#创建相关文件夹" class="headerlink" title="创建相关文件夹"></a>创建相关文件夹</h5><p>ocserv服务的启动需要证书，这里介绍的是如何使用自签证书。首先创建相关文件夹</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">mkdir -p /etc/ocserv/ssl/private          </div><div class="line">mkdir -p /etc/ocserv/ssl/ca               </div><div class="line">mkdir -p /etc/ocserv/ssl/server           </div><div class="line">mkdir -p /etc/ocserv/ssl/user             </div><div class="line">mkdir -p /etc/ocserv/ssl/crl</div></pre></td></tr></table></figure>
<ul>
<li><code>private</code> 保存服务器私钥</li>
<li><code>ca</code>      保存CA证书</li>
<li><code>server</code>  保存服务器证书</li>
<li><code>user</code>    保存用户证书</li>
<li><code>crl</code>     保存用户吊销证书链</li>
</ul>
<h5 id="创建自签CA"><a href="#创建自签CA" class="headerlink" title="创建自签CA"></a>创建自签CA</h5><p>创建自签名CA私钥</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">cd</span> /etc/ocserv/ssl/private</div><div class="line">certtool --generate-privkey --outfile ca-key.pem</div></pre></td></tr></table></figure>
<p>创建自签CA模版，其中$1为参数，该参数为本机的域名或者IP，如果以域名登录，例如VPS域名为<code>test.com</code>，则<code>cn=&quot;test.com&quot;</code>，organization字段随意填写，可以和cn一样，然后生成CA模版。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">cd</span> /etc/ocserv/ssl/ca</div><div class="line">cat &lt;&lt; EOF &gt; ca.tmpl</div><div class="line">  cn = <span class="string">"test.com"</span></div><div class="line">  organization = <span class="string">"test.com"</span></div><div class="line">  serial = 1</div><div class="line">  expiration_days = 3650</div><div class="line">  ca</div><div class="line">  signing_key</div><div class="line">  cert_signing_key</div><div class="line">  crl_signing_key</div><div class="line">EOF</div></pre></td></tr></table></figure>
<p>创建CA</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">cd</span> /etc/ocserv/ssl/ca</div><div class="line">certtool --generate-self-signed --load-privkey ../private/ca-key.pem \</div><div class="line">--template ca.tmpl --outfile ca-cert.pem</div></pre></td></tr></table></figure>
<h5 id="创建服务器证书"><a href="#创建服务器证书" class="headerlink" title="创建服务器证书"></a>创建服务器证书</h5><p>创建服务器私钥</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">cd</span> /etc/ocserv/ssl/private</div><div class="line">certtool --generate-privkey --outfile server-key.pem</div></pre></td></tr></table></figure>
<p>创建服务器模板，其中$1为参数，该参数为本机的域名或者IP，如果以域名登录，例如VPS域名为<code>test.com</code>，则<code>cn=&quot;test.com&quot;</code>，organization字段随意填写，可以和cn一样，然后生成服务器证书模板</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">cd</span> /etc/ocserv/ssl/server</div><div class="line">cat &lt;&lt; EOF &gt; server.tmpl</div><div class="line">  cn = <span class="string">"test.com"</span></div><div class="line">  organization  = <span class="string">"test.com"</span></div><div class="line">  expiration_days = 3650</div><div class="line">  signing_key</div><div class="line">  encryption_key </div><div class="line">  tls_www_server</div><div class="line">EOF</div></pre></td></tr></table></figure>
<p>生成服务器证书</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">cd</span> /etc/ocserv/ssl/server</div><div class="line">certtool --generate-certificate --load-privkey ../private/server-key.pem  \</div><div class="line">--load-ca-certificate ../ca/ca-cert.pem --load-ca-privkey ../private/ca-key.pem \</div><div class="line">--template server.tmpl --outfile server-cert.pem</div></pre></td></tr></table></figure>
<p>自签名服务器证书在此配置完成。</p>
<h4 id="使用授权证书"><a href="#使用授权证书" class="headerlink" title="使用授权证书"></a>使用授权证书</h4><h5 id="申请证书"><a href="#申请证书" class="headerlink" title="申请证书"></a>申请证书</h5><p>授权证书可以从<a href="https://buy.wosign.com/" target="_blank" rel="external">沃通</a>或者<a href="https://startssl.com" target="_blank" rel="external">startssl</a>、<a href="https://letsencrypt.org/" target="_blank" rel="external">Let’s Encrypt</a>等申请免费的ssl证书。申请证书的大概流程为：</p>
<ul>
<li>CSR文件为请求证书的文件，会产生一对公私钥，公钥（pub-key）需要上传给证书颁发结构，私钥（private-key）则要自己保留不能泄露。</li>
<li>证书颁发结构需要要验证申请人的域名拥有权，证明域名拥有权之后，使用其私钥（signature private-key）申请人上传的pub-lkey进行签名，并把域名等证书信息追加到其中，产生一个证书，例如2_dovzinp3.icean.xxx.crt</li>
<li>终端用户并不信任这个证书，鉴于这个证书不是权威机构颁发，所以需要证书链，来证明颁发该证书的结构是权威机构认证的。</li>
<li>证书链为颁发2_dovzinp3.icean.me.crt证书的结构，其上级机构对其公钥进行签名，逐级进行签名，直到顶级CA。</li>
</ul>
<h5 id="安装证书"><a href="#安装证书" class="headerlink" title="安装证书"></a>安装证书</h5><p>下载证书的压缩文件包中，解压OtherServer，以startssl为例子，解压出如下图所示。</p>
<center><img src="http://i.imgur.com/aUSEeOG.png" alt=""></center>

<center style="color:purple"><strong>图1-1 授权证书</strong></center>

<p>假定现在证书的路径仍和自签时候相同，服务器私钥为生成CSR文件所用的私钥</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">mv xxx.key server-key.pem</div><div class="line">mv server-key.pem /etc/ocserv/ssl/private</div></pre></td></tr></table></figure>
<p>创建服务器证书，根据证书链的顺序，首先追加服务器证书，然后追加中间证书，最后追加CA证书。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">cat 2_dovzinp3.icean.me.crt &gt;&gt; server-cert.pem</div><div class="line">cat 1_Intermediate.crt &gt;&gt; server-cert.pem</div><div class="line">cat root.crt &gt;&gt; server-cert.pem</div><div class="line">mv server-cert.pem /etc/ocserv/ssl/server</div></pre></td></tr></table></figure>
<p>ocserv配置</p>
<h4 id="配置文件修改"><a href="#配置文件修改" class="headerlink" title="配置文件修改"></a>配置文件修改</h4><p>备份原配置文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">cd</span> /etc/ocserv</div><div class="line">mv ocserv.conf ocserv.conf.bak</div></pre></td></tr></table></figure>
<p>创建新的配置文件，no-route列表过长，只是部分给出。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line">cat &lt;&lt; EOF &gt;/etc/ocserv/ocserv.conf</div><div class="line">    <span class="comment">#auth = "plain[/etc/ocserv/passwd]"</span></div><div class="line">    <span class="comment">#本地账户密码验证      </span></div><div class="line">    <span class="comment">#auth = "certificate</span></div><div class="line">    <span class="comment">#证书验证</span></div><div class="line">    <span class="comment">#ca-cert /etc/ocserv/ssl/ca/ca-cert.pem</span></div><div class="line">    <span class="comment">#CA证书路径</span></div><div class="line">    <span class="comment">#crl = /etc/ocserv/ssl/crl/crl.pem</span></div><div class="line">    <span class="comment">#吊销证书链</span></div><div class="line">    </div><div class="line">    <span class="comment">#auth = "radius[config=/etc/radiusclient/radiusclient.conf,groupconfig=true]"</span></div><div class="line">    <span class="comment"># acct = "radius[config=/etc/radiusclient/radiusclient.conf]"</span></div><div class="line">    <span class="comment">#审计采用radius</span></div><div class="line">    <span class="comment">#stats-report-time = 360</span></div><div class="line">    <span class="comment">#发送审计报告时间间隔</span></div><div class="line">    </div><div class="line">    max-clients = 16</div><div class="line">    max-same-clients = 1</div><div class="line">    tcp-port = 443</div><div class="line">    udp-port = 443</div><div class="line">    keepalive = 32400</div><div class="line">    dpd = 90</div><div class="line">    mobile-dpd = 1800</div><div class="line">    try-mtu-discovery = <span class="literal">true</span></div><div class="line">    cisco-client-compat = <span class="literal">true</span></div><div class="line">    server-cert = /etc/ocserv/ssl/server/server-cert.pem</div><div class="line">    <span class="comment">#服务器证书存储路径</span></div><div class="line">    server-key = /etc/ocserv/ssl/private/server-key.pem</div><div class="line">    <span class="comment">#服务器私钥存储路径</span></div><div class="line">    auth-timeout = 40</div><div class="line">    pid-file = /var/run/ocserv.pid</div><div class="line">    socket-file = /var/run/ocserv-socket</div><div class="line">    run-as-user = nobody</div><div class="line">    run-as-group = daemon</div><div class="line">    device = vpns</div><div class="line">    ipv4-network = 192.168.80.0</div><div class="line">    ipv4-netmask = 255.255.255.0</div><div class="line">    ipv6-network = 2001:cc0:2020:4008:2333::</div><div class="line">    ipv6-prefix = 80</div><div class="line">    ipv6-dns = 2001:4860:4860::8888</div><div class="line">    ipv6-dns = 2001:4860:4860::8844</div><div class="line">    dns = 8.8.8.8</div><div class="line">    dns = 8.8.4.4</div><div class="line">    no-route = 1.0.0.0/255.192.0.0</div><div class="line">    no-route = 1.64.0.0/255.224.0.0</div><div class="line">EOF</div></pre></td></tr></table></figure>
<h5 id="本地账户密码验证"><a href="#本地账户密码验证" class="headerlink" title="本地账户密码验证"></a>本地账户密码验证</h5><p>此时ocserv.conf前面部分应该为如下所示</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">auth = <span class="string">"plain[/etc/ocserv/passwd]"</span></div><div class="line"><span class="comment">#本地账户密码验证      </span></div><div class="line"><span class="comment">#auth = "certificate</span></div><div class="line"><span class="comment">#证书验证</span></div><div class="line"><span class="comment">#ca-cert /etc/ocserv/ssl/ca/ca-cert.pem </span></div><div class="line"><span class="comment">#CA证书路径</span></div><div class="line"><span class="comment">#crl = /etc/ocserv/ssl/crl/crl.pem</span></div><div class="line"><span class="comment">#吊销证书链</span></div><div class="line"></div><div class="line"><span class="comment">#auth = "radius[config=/etc/radiusclient/radiusclient.conf,groupconfig=true]"</span></div><div class="line"><span class="comment">#acct = "radius[config=/etc/radiusclient/radiusclient.conf]"</span></div><div class="line"><span class="comment">#审计采用radius</span></div><div class="line"><span class="comment">#stats-report-time = 360</span></div><div class="line"><span class="comment">#发送审计报告时间间隔</span></div></pre></td></tr></table></figure>
<p>需要安装httpd-tools工具</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">yum install -y httpd-tools</div></pre></td></tr></table></figure>
<p>创建账户密码，新添加用户也需要执行下面命令，不可省略<code>-c</code>，存储帐号密码文件需路径与配置文件中一致。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ocpasswd -c /etc/ocserv/passwd username</div></pre></td></tr></table></figure>
<h5 id="证书验证"><a href="#证书验证" class="headerlink" title="证书验证"></a>证书验证</h5><p>此时ocserv.conf前面部分应该为如下所示</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#auth = "plain[/etc/ocserv/passwd]"</span></div><div class="line"><span class="comment">#本地账户密码验证      </span></div><div class="line">auth = <span class="string">"certificate</span></div><div class="line">#证书验证</div><div class="line">ca-cert /etc/ocserv/ssl/ca/ca-cert.pem </div><div class="line">#CA证书路径</div><div class="line">crl = /etc/ocserv/ssl/crl/crl.pem</div><div class="line">#吊销证书链</div><div class="line"></div><div class="line">#auth = "radius[config=/etc/radiusclient/radiusclient.conf,groupconfig=<span class="literal">true</span>]<span class="string">"</span></div><div class="line">#acct = "radius[config=/etc/radiusclient/radiusclient.conf]<span class="string">"</span></div><div class="line">#审计采用radius</div><div class="line">#stats-report-time = 360</div><div class="line">#发送审计报告时间间隔</div></pre></td></tr></table></figure>
<p>使用证书登录不需要每次输入登录密码，在客户端导入证书即可，首先生成用户私钥</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">cd</span> /etc/ocserv/ssl/private</div><div class="line">certtool --generate-privkey --outfile user-key.pem</div></pre></td></tr></table></figure>
<p>创建用户模版</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">cat &lt;&lt; EOF &gt; user.tmpl</div><div class="line">  cn = <span class="string">"test.com"</span></div><div class="line">  unit = <span class="string">"test.com"</span></div><div class="line">  expiration_days = 365</div><div class="line">  signing_key</div><div class="line">  tls_www_client</div><div class="line">EOF</div></pre></td></tr></table></figure>
<p>生成用户证书</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">certtool --generate-certificate --load-privkey ../private/user-key.pem \</div><div class="line">--load-ca-certificate ca-cert.pem --load-ca-privkey ../private/ca-key.pem \</div><div class="line">--template user.tmpl --outfile user-cert.pem</div><div class="line"><span class="comment">#将用户证书和密钥打包为p12格式，在此过程中，需要输入名称和密码，在安装证书时，需要输入该密码进行验证。</span></div><div class="line">certtool --to-p12 --load-privkey ../private/user-key.pem --pkcs-cipher \ </div><div class="line">3des-pkcs12 --load-certificate user-cert.pem --outfile user-cert.p12 --outder</div></pre></td></tr></table></figure>
<p>批量创建用户证书脚本如下所示，其中需要一个user.tmpl文件。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#定义变量</span></div><div class="line">usr=icean</div><div class="line">id=ic-iPhone</div><div class="line">day=365</div><div class="line"></div><div class="line"><span class="comment">#最后相关的文件被放置在以id为名称的文件夹中</span></div><div class="line">mkdir <span class="variable">$id</span></div><div class="line">cp user.tmpl <span class="variable">$id</span>.tmpl</div><div class="line">sed -i <span class="string">"s/example-cn/<span class="variable">$id</span>/g"</span> <span class="variable">$id</span>.tmpl</div><div class="line">sed -i <span class="string">"s/example-unit/<span class="variable">$usr</span>/g"</span> <span class="variable">$id</span>.tmpl</div><div class="line">sed -i <span class="string">"s/1024/<span class="variable">$day</span>/g"</span> <span class="variable">$id</span>.tmpl</div><div class="line">certtool --generate-privkey --outfile <span class="variable">$id</span>-key.pem</div><div class="line">certtool --generate-certificate --load-privkey <span class="variable">$id</span>-key.pem \</div><div class="line">--load-ca-certificate ca-cert.pem --load-ca-privkey ca-key.pem \</div><div class="line">--template <span class="variable">$id</span>.tmpl --outfile <span class="variable">$id</span>-cert.pem</div><div class="line">certtool --to-p12 --load-privkey <span class="variable">$id</span>-key.pem --pkcs-cipher 3des-pkcs12 \</div><div class="line">--load-certificate <span class="variable">$id</span>-cert.pem --outfile <span class="variable">$id</span>-cert.p12 --outder</div><div class="line">mv <span class="variable">$id</span>* <span class="variable">$id</span></div></pre></td></tr></table></figure>
<h5 id="吊销证书"><a href="#吊销证书" class="headerlink" title="吊销证书"></a>吊销证书</h5><p>创建空吊销列表密钥文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">cd</span> /etc/ocserv/ssl/crl</div><div class="line">touch revoked.pem</div></pre></td></tr></table></figure>
<p>创建吊销证书模板</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">cat &lt;&lt; EOF &gt; crl.tmpl</div><div class="line">  crl_next_update = 9999</div><div class="line">  crl_number = 1</div><div class="line">EOF</div></pre></td></tr></table></figure>
<p>使用certtool创建空的吊销列表，当revoked.pem为空时，执行如下命令生成crl.pem文件。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">certtool --generate-crl --load-ca-privkey ../private/ca-key.pem \</div><div class="line">--load-ca-certificate ../ca/ca-cert.pem --template crl.tmpl --outfile crl.pem</div></pre></td></tr></table></figure>
<p>吊销一个用户，假设吊销用户为user1，首先将其证书追加到revoked.pem，然后生成新的吊销证书链文件crl.pem</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">cat ../user/user1/user1-cert.pem &gt;&gt; revoked.pem</div><div class="line">certtool --generate-crl --load-ca-privkey ../private/ca-key.pem \</div><div class="line">--load-ca-certificate ../ca/ca-cert.pem --load-certificate revoked.pem \</div><div class="line">--template crl.tmpl --outfile crl.pem</div></pre></td></tr></table></figure>
<p>若想重新启用一个被吊销的用户，则需要删除revoked.pem其中对应的密钥，然后重新生成吊销证书crl.pem,若revoke.pem被清空，则生成的时候不添加<code>--load-certificate</code>参数。吊销或者重新启用被吊销的证书时需要重启ocserv服务。</p>
<p>完整CA添加/吊销/重新启用脚本请点击<a href="http://pan.baidu.com/s/1o7Z55Om" target="_blank" rel="external">这里</a></p>
<hr>
<h3 id="2-其他设置"><a href="#2-其他设置" class="headerlink" title="2.其他设置"></a>2.其他设置</h3><h4 id="iptables设置"><a href="#iptables设置" class="headerlink" title="iptables设置"></a>iptables设置</h4><p>在CentOS下，首先禁用Firewall</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">service firewalld stop</div><div class="line">chkconfig firewalld off</div></pre></td></tr></table></figure>
<p>安装iptables并添加到开机启动</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">yum install -y iptables-services</div><div class="line">service iptables start</div><div class="line">chkconfig iptables on</div><div class="line">chkconfig ip6ables on</div></pre></td></tr></table></figure>
<p>添加如下条目到iptables和ip6tables，并保存。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">iptables -I INPUT 2 -p tcp --dport 443 -j ACCEPT</div><div class="line">iptables -I INPUT 3 -p udp --dport 443 -j ACCEPT</div><div class="line">iptables -I FORWARD 1  -j ACCEPT</div><div class="line">ip6tables -I FORWARD 1  -j ACCEPT</div><div class="line">iptables -t nat -A POSTROUTING <span class="_">-s</span>  192.168.80.0/24 -o eth0 -j MASQUERADE   <span class="comment">#转发ocserv虚拟子网</span></div><div class="line">iptables-save &gt; /etc/sysconfig/iptables</div><div class="line">ip6tables-save &gt; /etc/sysconfig/ip6tables</div></pre></td></tr></table></figure>
<h4 id="系统转发设置"><a href="#系统转发设置" class="headerlink" title="系统转发设置"></a>系统转发设置</h4><p>开启IPv4和IPv6转发</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">echo</span> <span class="string">'net.ipv4.ip_forward = 1'</span> &gt;&gt; /etc/sysctl.conf</div><div class="line"><span class="built_in">echo</span> <span class="string">'net.ipv6.conf.all.forwarding=1'</span> &gt;&gt; /etc/sysctl.conf</div><div class="line">sysctl -p /etc/sysctl.conf</div></pre></td></tr></table></figure>
<hr>
<h3 id="3-freeradius-设置"><a href="#3-freeradius-设置" class="headerlink" title="3.freeradius 设置"></a>3.freeradius 设置</h3><h4 id="ocserv配置文件"><a href="#ocserv配置文件" class="headerlink" title="ocserv配置文件"></a>ocserv配置文件</h4><p>此时ocserv.conf前面部分应该为如下所示</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#auth = "plain[/etc/ocserv/passwd]"</span></div><div class="line"><span class="comment">#本地账户密码验证      </span></div><div class="line"><span class="comment">#auth = "certificate</span></div><div class="line"><span class="comment">#证书验证</span></div><div class="line"><span class="comment">#ca-cert /etc/ocserv/ssl/ca/ca-cert.pem </span></div><div class="line"><span class="comment">#CA证书路径</span></div><div class="line"><span class="comment">#crl = /etc/ocserv/ssl/crl/crl.pem</span></div><div class="line"><span class="comment">#吊销证书链</span></div><div class="line"></div><div class="line">auth = <span class="string">"radius[config=/etc/radiusclient/radiusclient.conf,groupconfig=true]"</span></div><div class="line">acct = <span class="string">"radius[config=/etc/radiusclient/radiusclient.conf]"</span></div><div class="line"><span class="comment">#审计采用radius</span></div><div class="line">stats-report-time = 360</div><div class="line"><span class="comment">#发送审计报告时间间隔</span></div></pre></td></tr></table></figure>
<ul>
<li>groupconfig在配置文件的auth选项中去掉，否则freeradius的验证组radgroupreply属性只能添加<strong>‘Auth-Type’,’:=’,’Local’</strong>, <strong>acct字段为向freeradius服务器发送审计日志</strong>，否则ocserv只有在建立VPN连接之初与freeradius服务器进行验证用户的有效性，<strong>stats-report-time</strong>字段定义了向freeradius服务器发送审计日志的时间间隔。</li>
<li>groupconfig在配置文件的auth选项保留时，这时候需要在radius服务器的数据库插入IP、DNS等信息。 同时max-same-&gt;clients的应用灵敏度也提高了，之前不开启groupconfig时，max-same-clients的反应灵敏度有问题</li>
<li>不使用udp端口，可以提高下载速度，但是上传速度下降</li>
<li>经过验证，ocserv不能使用本地freeradius服务器进行验证,密码不匹配。</li>
</ul>
<h4 id="freeradius客户端安装"><a href="#freeradius客户端安装" class="headerlink" title="freeradius客户端安装"></a>freeradius客户端安装</h4><p>安装freeradius客户端以及工具</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">yum install freeradius-client freeradius-utils -y</div></pre></td></tr></table></figure>
<h4 id="freeradius客户端配置"><a href="#freeradius客户端配置" class="headerlink" title="freeradius客户端配置"></a>freeradius客户端配置</h4><p>变量设置，serverHostname为freeradius服务器hostname，serverIP为其IP地址，secret为共享的密钥。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">serverHostname=<span class="variable">$1</span></div><div class="line">serverIP=<span class="variable">$2</span></div><div class="line">secret=<span class="variable">$3</span></div></pre></td></tr></table></figure></p>
<p>向hosts文件中添加freeradius服务器地址解析</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">echo</span> <span class="string">"<span class="variable">$serverIP</span> <span class="variable">$serverHostname</span>"</span>&gt;&gt; /etc/hosts</div></pre></td></tr></table></figure>
<p>向freeradius server配置文件中追加freeradius服务器hostname</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">echo</span> <span class="string">"<span class="variable">$serverHostname</span>/<span class="variable">$serverHostname</span> <span class="variable">$secret</span>"</span> &gt;&gt; /etc/radiusclient/servers</div></pre></td></tr></table></figure>
<p>备份配置文件，将验证服务器从localhost改为其他，如果是时本地freeradius服务器，不需要修改</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">cd</span> /etc/radiusclient</div><div class="line">cp radiusclient.conf radiusclient.conf.bak</div><div class="line">sed -i <span class="string">'s/localhost/$serverHostname/g'</span> radiusclient.conf</div></pre></td></tr></table></figure>
<p>修改字典原来路径/usr/share/radiusclient为/etc/radiusclient</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sed -i <span class="string">'s/usr\/share/etc/g'</span> radiusclient.conf</div></pre></td></tr></table></figure>
<p>其他修改，具体原因不了解</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">sed -i <span class="string">'s/radius_deadtime/#radius_deadtime/g'</span> radiusclient.conf</div><div class="line">sed -i <span class="string">'s/bindaddr */#bindaddr */g'</span> radiusclient.conf</div></pre></td></tr></table></figure>
<p>下载字典，并修改字典文件，注释掉所有dictionary中带IPv6的条目，否则会报错<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">cd</span> /etc/radiusclient</div><div class="line">wget http://qingdao.icean.cc:11234/dictionary.microsoft</div><div class="line">cp /usr/share/radiusclient/dictionary.merit ./</div><div class="line">cp dictionary dictionary.bak </div><div class="line"></div><div class="line">cat &lt;&lt; EOF &gt;&gt; /etc/radiusclient/dictionary</div><div class="line">  INCLUDE /etc/radiusclient/dictionary.microsoft</div><div class="line">  INCLUDE /etc/radiusclient/dictionary.merit </div><div class="line">EOF</div></pre></td></tr></table></figure></p>
<h4 id="freeradius服务器配置"><a href="#freeradius服务器配置" class="headerlink" title="freeradius服务器配置"></a>freeradius服务器配置</h4><p>变量设置，clientHostname为配置ocserv服务的hostname，clientIP为其IP地址，secret为共享密钥</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">clientHostname= <span class="variable">$1</span></div><div class="line">clientIP=<span class="variable">$2</span></div><div class="line">secret=<span class="variable">$3</span></div></pre></td></tr></table></figure>
<p>添加客户端地址解析到hosts文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">echo</span> <span class="string">"<span class="variable">$clientIP</span> <span class="variable">$clientHostname</span>"</span>&gt;&gt; /etc/hosts</div></pre></td></tr></table></figure>
<p>添加设置到clients.conf</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">cat &lt;&lt; EOF &gt;&gt; /etc/raddb/clients.conf</div><div class="line">client <span class="variable">$clientHostname</span> &#123;</div><div class="line">	ipaddr = <span class="variable">$clientIP</span></div><div class="line">	secret= <span class="variable">$secret</span></div><div class="line">	require_message_authenticator = no</div><div class="line">	nas_type = other </div><div class="line">&#125; </div><div class="line">EOF</div></pre></td></tr></table></figure>
<p>服务器端mysql插入相应的验证条目，验证类型为本地，服务种类为Frame-User，其中Acct-Interim-Interval为统计流量的时间间隔，Max-Monthly-Traffic为每个月最大流量，这里以MB为准。<strong>在freeradius3中，不能添加更多属性，否则无法验证成功，这个问题有待探究。</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">insert</span> <span class="keyword">into</span> radgroupreply (groupname,<span class="keyword">attribute</span>,op,<span class="keyword">value</span>) <span class="keyword">values</span> (<span class="string">'ocserv'</span>,<span class="string">'Auth-Type'</span>,<span class="string">':='</span>,<span class="string">'Local'</span>); </div><div class="line"><span class="keyword">insert</span> <span class="keyword">into</span> radgroupreply (groupname,<span class="keyword">attribute</span>,op,<span class="keyword">VALUE</span>) <span class="keyword">VALUES</span> (<span class="string">'ocserv'</span>,<span class="string">'Acct-Interim-Interval'</span>,<span class="string">':='</span>,<span class="string">'600'</span>);</div><div class="line"><span class="keyword">insert</span> <span class="keyword">into</span> radgroupreply (groupname,<span class="keyword">attribute</span>,op,<span class="keyword">VALUE</span>) <span class="keyword">VALUES</span> (<span class="string">'ocserv'</span>,<span class="string">'Max-Monthly-Traffic'</span>,<span class="string">':='</span>,<span class="string">'1024'</span>);</div></pre></td></tr></table></figure>
<p>Max-Monthly-Traffic为用户自定义变量，需要在/etc/raddb/dictionary 中添加如下条目。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">ATTRIBUTE Max-Monthly-Traffic 3003 <span class="built_in">integer</span></div><div class="line">ATTRIBUTE  Monthly-Traffic-Limit  3004    <span class="built_in">integer</span></div></pre></td></tr></table></figure>
<p>账户和密码</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">insert</span> <span class="keyword">into</span> radcheck (username,<span class="keyword">attribute</span>,op,<span class="keyword">value</span>) <span class="keyword">values</span> (<span class="string">'ociPhone'</span>,<span class="string">'Cleartext-Password'</span>,<span class="string">':='</span>,<span class="string">'test'</span>);</div></pre></td></tr></table></figure>
<p>将账号加入对应的用户组</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">insert</span> <span class="keyword">into</span> radusergroup (username,groupname) <span class="keyword">values</span> (<span class="string">'ociPhone'</span>,<span class="string">'ocserv'</span>);</div></pre></td></tr></table></figure>
<p>切换到/etc/raddb/mods-enabled/目录下，建立sqlcounter的软链接，启用sqlcounter模块。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">cd</span> /etc/raddb/mods-enabled/</div><div class="line">ln <span class="_">-s</span> ../sqlcounter</div></pre></td></tr></table></figure>
<p>添加新的计数器</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">sqlcounter monthlytrafficcounter &#123;</div><div class="line">    sql_module_instance = sql                                                                                                                </div><div class="line">    dialect = <span class="variable">$&#123;modules.sql.dialect&#125;</span></div><div class="line"></div><div class="line">    counter_name = Monthly-Traffic               <span class="comment">#计数器名字，可以任意填写</span></div><div class="line">    check_name = Max-Monthly-Traffic          <span class="comment">#限制最大流量</span></div><div class="line">    reply_name = Monthly-Traffic-Limit          <span class="comment">#回复给客户端</span></div><div class="line"></div><div class="line">    key = User-Name</div><div class="line">    reset = monthly</div><div class="line"></div><div class="line">    <span class="variable">$INCLUDE</span> <span class="variable">$&#123;modconfdir&#125;</span>/sql/counter/<span class="variable">$&#123;dialect&#125;</span>/<span class="variable">$&#123;.:instance&#125;</span>.conf</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>切换到/etc/raddb/mods-config/sql/counter/mysql目录下，添加与计数器同名的配置文件，变量如下</p>
<ul>
<li>${key}  与计数器中的key属性队形</li>
<li>%b 为计数的起始时间，若reset为monthly，则为当前时间的月份第一天，其数值为标准UNIX时间</li>
<li>%e 为计数的结束时间，若reset为monthly，则为当前时间的月份最后一天，其数值为标准UNIX时间</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">cd</span> /etc/raddb/mods-config/sql/counter/mysql</div><div class="line">cat &lt;&lt; EOF &gt;monthlytrafficcounter.conf</div><div class="line"> query = <span class="string">"\</span></div><div class="line">	 SELECT SUM(acctinputoctets + acctoutputoctets) DIV 1048576 \     #1MB字节数，radacct按照字节统计的。</div><div class="line">          FROM radacct \</div><div class="line">         WHERE UserName='%&#123;<span class="variable">$&#123;key&#125;</span>&#125;' \</div><div class="line">         AND UNIX_TIMESTAMP(AcctStartTime) &gt; '%b'"</div><div class="line">EOF</div></pre></td></tr></table></figure>
<p>在/etc/raddb/sites-enabled/default中启用monthlytrafficcounter模块，在authenticate字段中，添加monthlytrafficcounter，然后重启radius服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">authenticate&#123;</div><div class="line">  	monthlytrafficcounter</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<hr>
<h3 id="4-启动服务"><a href="#4-启动服务" class="headerlink" title="4. 启动服务"></a>4. 启动服务</h3><p>启动ocserv服务，在终端进行测试，使用在freeradius服务器端配置的账号和密码进行登陆。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">service ocserv start</div></pre></td></tr></table></figure>
<hr>
<h3 id="5-问题拓展"><a href="#5-问题拓展" class="headerlink" title="5. 问题拓展"></a>5. 问题拓展</h3><ul>
<li><p>ocserv验证对应的radgroupreply无法添加更多属性。</p>
</li>
<li><p>ocserv验证对应的radgroupcheck中Simultaneous-Use，限制同时在线人数属性不生效，验证pptp时候也如此。</p>
</li>
<li><p>nas-identifier验证没解决，解决如何分辨多台nas，使其只能使用特定的账户验证，而不是可以使用数据库中所有的验证条目。</p>
</li>
<li><p>ocserv证书验证能否使用freeradius？</p>
<p>​</p>
</li>
</ul>

        
      
    </div>

    
  </article>

    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2016/09/29/Centos 6.x Hadoop 安装/">Centos 6.x Hadoop 安装</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2016年9月29日
        </span>
      </div>
    </header>

    

    <div class="post-content">
      
        

        
          <h3 id="1-简介"><a href="#1-简介" class="headerlink" title="1.简介"></a>1.简介</h3><p>Hadoop可分为<strong>分布式安装</strong>以及<strong>伪分布式安装</strong>，以分布式安装的方式安装Hadoop，可以更好地体验Hadoop的分布式工作的原理。然而，安装设备可能是一个问题，找不到那么多的Linux主机来安装Hadoop，以及要维护这些Linux主机之间的通信，这都是一系列问题。以下为我设计的Hadoop安装方案。</p>
<ul>
<li>所需软件<ul>
<li>VirtualBox</li>
<li>Xshell</li>
<li>XFTP</li>
</ul>
</li>
</ul>
<hr>
<h3 id="2-逻辑拓扑"><a href="#2-逻辑拓扑" class="headerlink" title="2.逻辑拓扑"></a>2.逻辑拓扑</h3><p>Hadoop的结构为主从结构，即为master和slave，可能有一个master多个slave，也可能存在多个master节点，多个master节点中一个启用，其他的为备用。master节点维护Hadoop的namenode，维护着所存储文件的元数据，slave节点具体存储数据块。其中逻辑拓扑如图1-1所示。</p>
<center><img src="http://qingdao.icean.cc:11234/Imgbed/Hadoop/hadoop-tpg.png" alt="图1-1"></center><br><center style="color:purple"><strong>图1-1</strong></center>   

<p>其中IP地址表为如表1-1所示。</p>
<table>
<thead>
<tr>
<th>主机名</th>
<th>IP地址</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td>MyPC</td>
<td>10.10.10.10/24</td>
<td>windows换汇接口</td>
</tr>
<tr>
<td>Master</td>
<td>10.10.10.1/24</td>
<td>桥接到Windows环回接口</td>
</tr>
<tr>
<td>Slave1</td>
<td>10.10.10.2/24</td>
<td>桥接到Windows环回接口</td>
</tr>
<tr>
<td>Slave2</td>
<td>10.10.10.3/24</td>
<td>桥接到Windows环回接口</td>
</tr>
</tbody>
</table>
<center style="color:purple"><strong>表1-1</strong></center>

<hr>
<h3 id="3-环境搭建"><a href="#3-环境搭建" class="headerlink" title="3.环境搭建"></a>3.环境搭建</h3><p>使用VirtualBox创建三个CentOS 6.x的虚拟机，这里建议创建CentOS minimal虚拟机，这样可以节省计算机内存，鉴于Hadoop的所有安装都是在命令行下， 所以极力建议只安装纯命令行的虚拟机。可以先创建一个虚拟机，然后克隆其他两个虚拟机。在虚拟机创建成功之后，关闭虚拟机并修改虚拟机的网卡文件。</p>
<h4 id="Windows环回端口"><a href="#Windows环回端口" class="headerlink" title="Windows环回端口"></a>Windows环回端口</h4><p>添加Windows环回端口的意义在于可以把Windows加入到Hadoop虚拟机集群之间的局域网中，如何创建Windows环回端口，请自行Google或者Baidu，创建环回端口之后，设置环回端口的静态IP。如图2-1所示,将环回接口IP设置为10.10.10.10/24。</p>
<center><img src="http://qingdao.icean.cc:11234/Imgbed/Hadoop/loopback.jpg" alt=""></center><br><center style="color:purple"><strong>图2-1</strong></center>  

<h4 id="修改虚拟机网口接口"><a href="#修改虚拟机网口接口" class="headerlink" title="修改虚拟机网口接口"></a>修改虚拟机网口接口</h4><p>为每个虚拟机添加三张网卡，第一张网卡VirtualBox配置如图2-2所示，网卡模式为NAT模式，用于虚拟机连接外网，对应CentOS的eth0。</p>
<center><img src="http://qingdao.icean.cc:11234/Imgbed/Hadoop/vm-net1.jpg" alt=""></center><br><center style="color:purple"><strong>图2-2</strong></center>   

<p>第二张网卡如图2-3所示，对应CentOS的eth1，该网卡用于Windows SSH登录虚拟机，为host-only模式。</p>
<blockquote>
<p><span style="color:red"><strong>提示：</strong></span>也可以通过其他网卡SSH登录虚拟机，例如下面介绍的第三个网卡。但是仍然推荐通过使用host-only网卡SSH登录虚拟机。</p>
</blockquote>
<center><img src="http://qingdao.icean.cc:11234/Imgbed/Hadoop/vm-net2.jpg" alt=""></center><br><center style="color:purple"><strong>图2-3</strong></center> 

<p>第三个网卡如图2-4所示，对应CentOS的eth2，用于Windows与Hadoop虚拟机集群之间的通信，也用于hadoop集群之间的通信，该网卡桥接到Windows之前创建的环回端口，这样在逻辑上，三台虚拟机和Windows都在一个局域网中了。   </p>
<blockquote>
<p><span style="color:red"><strong>提示：</strong></span>该网卡也可以桥接到Windows的任何一张物理网卡，但是物理网卡可能用于上网，所以推荐桥接到Windows的环回接口，环回接口也不影响Windows正常上网。</p>
</blockquote>
<center><img src="http://qingdao.icean.cc:11234/Imgbed/Hadoop/vm-net3.jpg" alt=""></center><br><center style="color:purple"><strong>图2-4</strong></center> 

<h4 id="虚拟机网卡设置"><a href="#虚拟机网卡设置" class="headerlink" title="虚拟机网卡设置"></a>虚拟机网卡设置</h4><p>删除克隆虚拟机网卡遗留信息，克隆的虚拟机会重置MAC地址，但是CentOS系统不会自动更新信息，需要清理清理历史网卡信息，删除如图2-5所示的文件。删除该文件之后，重启虚拟机。</p>
<center><img src="http://qingdao.icean.cc:11234/Imgbed/Hadoop/hadoop-1.png" alt=""></center>   <center style="color:purple"><strong>图2-5</strong></center>


<p>以一台虚拟机为例，创建虚拟机网卡文件并修改其中的MAC地址以及IP地址，缺省只有eth0的文件，切换目录到网卡文件下,并创建其他两张网卡文件。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">cd /etc/sysconfig/network-script</div><div class="line">cp ifcfg-eth0 ifcfg-eth1</div><div class="line">cp ifcfg-eth0 ifcfg-eth2</div></pre></td></tr></table></figure>
<p>修改ifcfg-eth0<br>​<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">vi ifcfg-eth0</div></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">DEVICE=eth0</div><div class="line">HWADDR=08:00:27:B4:01:1F</div><div class="line">TYPE=Ethernet</div><div class="line">ONBOOT=yes</div><div class="line">BOOTPROTO=dhcp</div></pre></td></tr></table></figure>
<p>MAC地址修改为VirtualBox网卡的MAC地址，该MAC为图2-2中的MAC地址。ONBOOT=yes是必要的，这样网卡会开机启动，获取地址的方式为DHCP。</p>
<p>修改ifcfg-eth1</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">vi ifcfg-eth0</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">DEVICE=eth1</div><div class="line">HWADDR=08:00:27:CB:C7:DE</div><div class="line">TYPE=Ethernet</div><div class="line">ONBOOT=yes</div><div class="line">BOOTPROTO=dhcp</div></pre></td></tr></table></figure>
<p>修改ifcfg-eth2</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">vi ifcfg-eth0</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">DEVICE=eth2</div><div class="line">HWADDR=08:00:27:9D:D9:4C</div><div class="line">TYPE=Ethernet</div><div class="line">ONBOOT=yes</div><div class="line">BOOTPROTO=none</div><div class="line">IPADDR=10.10.10.1</div><div class="line">NETMASK=255.255.255.0</div></pre></td></tr></table></figure>
<p>该网卡地址为静态IP地址。</p>
<p>设置好三张网卡的信息之后，重启网络服务。<br>​<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">service network restart</div></pre></td></tr></table></figure></p>
<h4 id="SSH到虚拟机"><a href="#SSH到虚拟机" class="headerlink" title="SSH到虚拟机"></a>SSH到虚拟机</h4><p>在VirtualBox下查看虚拟机eth1的IP地址<br>​<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ifconfig eth1</div></pre></td></tr></table></figure></p>
<p>通过查询的到的IP地址，在Windows下使用xshell SSH到虚拟机，这样可以在xhell下更方便地操作命令行。</p>
<h4 id="测试网络通信"><a href="#测试网络通信" class="headerlink" title="测试网络通信"></a>测试网络通信</h4><p>在Windows cmd模式下分别ping其他三台虚拟机IP地址，若可以ping通，则进入Hadoop安装的环节，若ping不通，可能的原因如下：</p>
<ul>
<li>虚拟机防火墙：关闭虚拟机的防火墙；</li>
<li>IP地址配置错误：查看虚拟机eth2的IP信息；</li>
<li>Windows环回接口IP地址与虚拟机eth2的IP不在一个网段。</li>
</ul>
<hr>
<h3 id="4-Hadoop安装"><a href="#4-Hadoop安装" class="headerlink" title="4.Hadoop安装"></a>4.Hadoop安装</h3><h4 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h4><p>将<code>hadoop-2.6.0.tar.gz</code>和<code>jdk-7u75-linux-x64.tar</code>以及相关xml文件通过xftp传送不过到虚拟机/root目录下，三台虚拟机都如此操作。文件下载地址请点<a href="http://pan.baidu.com/s/1gdJgh4B" target="_blank" rel="external">这里</a>。</p>
<h4 id="创建hadoop账户"><a href="#创建hadoop账户" class="headerlink" title="创建hadoop账户"></a>创建hadoop账户</h4><p>在三台虚拟机上均创建hadoop账户。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">useradd hadoop</div><div class="line">passwd hadoop</div></pre></td></tr></table></figure>
<h4 id="JDK安装"><a href="#JDK安装" class="headerlink" title="JDK安装"></a>JDK安装</h4><p>Hadoop需要JDK的支持，需要在所有的虚拟机节点上安装JDK环境，首先解压安装JDK。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">cd /opt/</div><div class="line">cp /root/jdk-7u75-linux-x64.tar.gz  ./</div><div class="line">tar xzf jdk-7u75-linux-x64.tar.gz</div><div class="line">cd /opt/jdk1.7.0_75/</div><div class="line">alternatives --install /usr/bin/java java /opt/jdk1.7.0_75/bin/java 2</div><div class="line">alternatives --config java</div><div class="line">alternatives --install /usr/bin/jar jar /opt/jdk1.7.0_75/bin/jar 2</div><div class="line">alternatives --install /usr/bin/javac javac /opt/jdk1.7.0_75/bin/javac 2</div><div class="line">alternatives --set jar /opt/jdk1.7.0_75/bin/jar</div><div class="line">alternatives --set javac /opt/jdk1.7.0_75/bin/javac</div></pre></td></tr></table></figure>
<p>设置设置环境变量。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">echo &apos;export JAVA_HOME=/opt/jdk1.7.0_75&apos; &gt;&gt; /etc/profile</div><div class="line">echo &apos;export JRE_HOME=/opt/jdk1.7.0_75/jre&apos; &gt;&gt; /etc/profile</div><div class="line">echo &apos;export PATH=$PATH:/opt/jdk1.7.0_75/bin:/opt/jdk1.7.0_75/jre/bin&apos; &gt;&gt; /etc/profile</div></pre></td></tr></table></figure>
<h4 id="Hadoop基础安装"><a href="#Hadoop基础安装" class="headerlink" title="Hadoop基础安装"></a>Hadoop基础安装</h4><p>首先解压文件。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">cd /home/hadoop</div><div class="line">cp /root/hadoop-2.6.0.tar.gz ./</div><div class="line">tar -zxvf hadoop-2.6.0.tar.gz</div><div class="line">rm -rf hadoop-2.6.0.tar.gz</div><div class="line">mv hadoop-2.6.0 hadoop</div></pre></td></tr></table></figure>
<p>创建tmp文件夹以及节点数据存储文件夹。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">cd hadoop</div><div class="line">mkdir tmp hadoopdata hadoopdata/hdfs hadoopdata/hdfs/datanode1 hadoopdata/hdfs/datanode2 </div><div class="line">mkdir hadoopdata/hdfs/namenode1 hadoopdata/hdfs/namenode2</div></pre></td></tr></table></figure>
<p>配置环境变量。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">echo &apos;export HADOOP_INSTALL=/home/hadoop/hadoop&apos; &gt;&gt;/etc/profile </div><div class="line">echo &apos;export PATH=$&#123;PATH&#125;:$&#123;HADOOP_INSTALL&#125;/bin:$&#123;HADOOP_INSTALL&#125;/sbin&apos; &gt;&gt;/etc/profile </div><div class="line">echo &apos;export HADOOP_MAPRED_HOME=$&#123;HADOOP_INSTALL&#125;&apos; &gt;&gt;/etc/profile </div><div class="line">echo &apos;export HADOOP_COMMON_HOME=$&#123;HADOOP_INSTALL&#125;&apos; &gt;&gt;/etc/profile </div><div class="line">echo &apos;export HADOOP_HDFS_HOME=$&#123;HADOOP_INSTALL&#125;&apos; &gt;&gt;/etc/profile </div><div class="line">echo &apos;export YARN_HOME=$&#123;HADOOP_INSTALLL&#125;&apos; &gt;&gt;/etc/profile </div><div class="line">echo &apos;export HADOOP_COMMON_LIB_NATIVE_DIR=$&#123;HADOOP_INSTALL&#125;/lib/natvie&apos; &gt;&gt;/etc/profile </div><div class="line">echo &apos;export HADOOP_OPTS=&quot;-Djava.library.path=$&#123;HADOOP_INSTALL&#125;/lib:$&#123;HADOOP_INSTALL&#125;/lib/native&quot;&apos; &gt;&gt;/etc/profile </div><div class="line">source /etc/profile</div></pre></td></tr></table></figure>
<p>很重要，否则无法启动hadoop进程。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">echo &apos;export JAVA_HOME=/opt/jdk1.7.0_75&apos; &gt;&gt; hadoop/etc/hadoop/hadoop-env.sh</div><div class="line">echo &apos;export HADOOP_HOME_WARN_SUPPRESS=1&apos; &gt;&gt; hadoop/etc/hadoop/hadoop-env.sh</div><div class="line">echo &apos;export JAVA_HOME=/opt/jdk1.7.0_75&apos; &gt;&gt; hadoop/etc/hadoop/yarn-env.sh</div></pre></td></tr></table></figure>
<h4 id="master节点配置"><a href="#master节点配置" class="headerlink" title="master节点配置"></a>master节点配置</h4><p>对master节点进行一些配置。<br>​<br>关闭iptables，防止其阻碍hadoop节点之间通信。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">service iptables stop</div><div class="line">chkconfig iptables off</div></pre></td></tr></table></figure>
<p>修改主机hostname为master</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">HOSTNAME=master</div><div class="line">hostname $HOSTNAME</div><div class="line">sed -i &quot;s/^HOSTNAME=.*/HOSTNAME=$HOSTNAME/g&quot; /etc/sysconfig/network</div></pre></td></tr></table></figure>
<p>备份配置文件。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">cd /home/hadoop/hadoop/etc/hadoop</div><div class="line">mv masters masters.bak</div><div class="line">mv slaves slaves.bak</div><div class="line">mv core-site.xml core-site.xml.bak</div><div class="line">mv hdfs-site.xml hdfs-site.xml.bak</div><div class="line">mv mapred-site.xml mapred-site.xml.bak</div><div class="line">mv yarn-site.xml yarn-site.xml.bak</div></pre></td></tr></table></figure>
<p>拷贝新的配置文件。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">cp /root/xml/core-site.xml ./</div><div class="line">cp /root/xml/hdfs-site.xml ./</div><div class="line">cp /root/xml/mapred-site.xml ./</div><div class="line">cp /root/xml/yarn-site.xml ./</div></pre></td></tr></table></figure>
<blockquote>
<p><span style="color:red"><strong>提示：</strong></span>配置文件的内容，请自行参考官网，在这里不进行赘述，配置文件中涉及的参数过多，本文只修改其中一些比较重要的参数。</p>
</blockquote>
<p>根据主机的IP地址，修改配置文件，将配置文件core-site.xml、mapred-site.xml、hdfs-site.xml、yarn-site.xml中master_ipaddr字段替换为eth2的IP地址。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">master_ip=$(ifconfig eth2 | awk -F&apos;:&apos; &apos;/inet addr/&#123;split($2,_,&quot; &quot;);print _[1]&#125;&apos;)</div><div class="line">sed -i &quot;s/master_ipaddr/$master_ip/g&quot; core-site.xml mapred-site.xml hdfs-site.xml  yarn-site.xml</div></pre></td></tr></table></figure>
<p>修改hdfs-site.xml中的replications字段为2，鉴于有两个slave节点，实际生产环境数量一般为3。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sed -i &quot;s/replications/2/g&quot; hdfs-site.xml</div></pre></td></tr></table></figure>
<p>修改hosts文件。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">mv /etc/hosts /etc/hosts.bak</div><div class="line">echo &quot;10.10.10.1 master</div><div class="line">10.10.10.2 slave1</div><div class="line">10.10.10.3 slave2&quot;&gt;&gt;/etc/hosts</div></pre></td></tr></table></figure>
<p>修改master、slave的IP列表。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">cd /home/hadoop/etc/hadoop</div><div class="line">echo &quot;10.10.10.1&quot;&gt;&gt;masters</div><div class="line">echo &quot;10.10.10.2</div><div class="line">10.10.10.3&quot;&gt;&gt;slaves</div></pre></td></tr></table></figure>
<h4 id="slave节点配置"><a href="#slave节点配置" class="headerlink" title="slave节点配置"></a>slave节点配置</h4><p>步骤与master节点配置基本一致，只有在主机名配置不太一样，$1在执行脚本时手动指定。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">HOSTNAME=$1</div><div class="line">hostname $HOSTNAME</div><div class="line">sed -i &quot;s/^HOSTNAME=.*/HOSTNAME=$HOSTNAME/g&quot; /etc/sysconfig/network</div></pre></td></tr></table></figure>
<h4 id="修改文件属主以及所属组群"><a href="#修改文件属主以及所属组群" class="headerlink" title="修改文件属主以及所属组群"></a>修改文件属主以及所属组群</h4><p>将hadoop的属组以及组群设置为hadoop。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">cd /home/hadoop</div><div class="line">chown -R hadoop:hadoop hadoop</div><div class="line">chgrp -R hadoop hadoop</div></pre></td></tr></table></figure>
<h4 id="免密码SSH登录"><a href="#免密码SSH登录" class="headerlink" title="免密码SSH登录"></a>免密码SSH登录</h4><p>hadoop集群要求master节点可以免密码SSH登录slave节点，slave节点也可以免密码登录master<br>节点。以master主机为例，首先切换到hadoop账户下。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">su hadoop</div></pre></td></tr></table></figure>
<p>生成一对公私钥，全部回车即可，生成的目录在~/.ssh下。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ssh-keygen</div></pre></td></tr></table></figure>
<p>将生成的公钥 id_rsa.pub 追加到 ~/.ssh/authorized_keys中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">cat ~/.ssh/id_rsa.pub&gt;&gt; ~/.ssh/authorized_keys</div></pre></td></tr></table></figure>
<p>修改~/.ssh文件权限为600，否则无法免密码登录。这样，master主机就可ssh免密码登录本机，如图3-1所示。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ssh master</div></pre></td></tr></table></figure>
<center><img src="http://qingdao.icean.cc:11234/Imgbed/Hadoop/hadoop-5.jpg" alt=""></center><br><center style="color:purple"><strong>图3-1</strong></center> 

<p>将master主机的公钥 id_rsa.pub 拷贝到所有slave节点上。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">scp ~/.ssh/id_rsa.pub hadoop@slave1:~/</div><div class="line">scp ~/.ssh/id_rsa.pub hadoop@slave2:~/</div></pre></td></tr></table></figure>
<p>在slave节点下， 把master的 id_rsa.pub 追加到 ~/.ssh/authorized_keys中并删除master 公钥。<br>​<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">cat ~/id_rsa.pub&gt;&gt; ~/.ssh/authorized_keys</div><div class="line">rm -rf ~/id_rsa.pub</div></pre></td></tr></table></figure></p>
<p>这样master节点可以免密码ssh登录所有的slave节点了，如图3-2，图3-3所示。</p>
<center><img src="http://qingdao.icean.cc:11234/Imgbed/Hadoop/hadoop-6.jpg" alt=""></center><br><center style="color:purple"><strong>图3-2</strong></center>  

<center><img src="http://qingdao.icean.cc:11234/Imgbed/Hadoop/hadoop-7.jpg" alt=""></center><br><center style="color:purple"><strong>图3-3</strong></center>  

<p>同样的道理，slave节点也生成一对公私钥，并把公钥追加到master的~/.ssh/authorized_keys中，这样slave节点均可免密码ssh登录master节点了。</p>
<blockquote>
<p><span style="color:red"><strong>提示：</strong></span>以上关于免密码SSH登录的配置均在master和slave的hadoop账户下进行的， 免密码登录的是主机之间的hadoop账户，若需要root账户之间免密码登录，需要另行配置。还有很重要的一点是~/.ssh文件夹的权限必须是700</p>
</blockquote>
<hr>
<h3 id="5-hadoop启动运行"><a href="#5-hadoop启动运行" class="headerlink" title="5.hadoop启动运行"></a>5.hadoop启动运行</h3><h4 id="脚本启动hadoop"><a href="#脚本启动hadoop" class="headerlink" title="脚本启动hadoop"></a>脚本启动hadoop</h4><p>以下操作均在master节点下<br>格式化master节点，即格式化namenode</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">~/hadoop/bin/hdfs namenode -format</div></pre></td></tr></table></figure>
<p>启动HDFS服务</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">~/hadoop/sbin/start-dfs.sh</div></pre></td></tr></table></figure>
<p>服务启动成功之后，在浏览器地址栏输入<a href="http://10.10.10.1:50070" target="_blank" rel="external">http://10.10.10.1:50070</a>进入hdfs管理页面。如图4-1所示</p>
<center><img src="http://qingdao.icean.cc:11234/Imgbed/Hadoop/hadoop-9.jpg" alt=""></center><br><center style="color:purple"><strong>图4-1</strong></center> 

<p>启动yarn服务,用于任务管理。<br>​<br>    ~/hadoop/sbin/start-yarn.sh<br>服务启动成功之后，在浏览器地址栏输入<a href="http://10.10.10.1:50070" target="_blank" rel="external">http://10.10.10.1:8088</a>进入mapreduce任务管理页面，如图4-2所示。</p>
<center><img src="http://qingdao.icean.cc:11234/Imgbed/Hadoop/hadoop-10.jpg" alt=""></center><br><center style="color:purple"><strong>图4-2</strong></center>  

<blockquote>
<p><span style="color:red"><strong>提示：</strong></span>在主机下可以使用jps命令查看hadoop的相关进程。</p>
</blockquote>
<h4 id="hadoop相关操作"><a href="#hadoop相关操作" class="headerlink" title="hadoop相关操作"></a>hadoop相关操作</h4><p>假设HADOOP_HOME已经写入环境变量，则以下操作可以在任何路径执行，若hadoop命令无法执行，请执行source /etc/profile。</p>
<p>查看文件列表，找到了hdfs中/user下的文件。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">hadoop fs -ls /user</div></pre></td></tr></table></figure>
<p>可以列出hdfs中/user目录下的所有文件（包括子目录下的文件）。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">hadoop fs -lsr /user</div></pre></td></tr></table></figure>
<p>创建文件目录，查看hdfs中/user目录下再新建一个叫做newDir的新目录。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">hadoop fs -mkdir /user/newDir</div></pre></td></tr></table></figure>
<p>删除文件，删除hdfs中/user目录下一个名叫needDelete的文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">hadoop fs -rm /user/needDelete</div></pre></td></tr></table></figure>
<p>删除hdfs中/user目录以及该目录下的所有文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">hadoop fs -rmr /user</div></pre></td></tr></table></figure>
<p>上传文件，上传一个本机/home/admin/newFile的文件到hdfs中/user目录下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">hadoop fs –put /home/admin/newFile /user/</div></pre></td></tr></table></figure>
<p>下载文件，下载hdfs中/user目录下的newFile文件到本机/home/admin/newFile中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">hadoop fs –get /user/newFile /home/admin/newFile</div></pre></td></tr></table></figure>
<p>查看文件，可以直接在hdfs中直接查看文件，功能与类是cat类似，查看hdfs中/user目录下的newFile文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">hadoop fs –cat /home/admin/newFile</div></pre></td></tr></table></figure>
<p>提交MAPREDUCE JOB，原则上说，Hadoop所有的MapReduce Job都是一个jar包。运行一个/home/admin/hadoop/job.jar的MapReduce Job</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">hadoop jar ~/hadoop/job.jar [jobMainClass] [jobArgs]</div></pre></td></tr></table></figure>
<p>杀死某个正在运行的JOB，假设Job_Id为：job_201005310937_0053</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">hadoop job -kill job_201005310937_0053</div></pre></td></tr></table></figure>
<blockquote>
<p><span style="color:red"><strong>提示：</strong></span>完整Hadoop安装脚本轻点击<a href="http://pan.baidu.com/s/1dDdSF9R" target="_blank" rel="external">这里</a></p>
</blockquote>

        
      
    </div>

    
  </article>

    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2016/09/29/CentOS 6.x ocserv IPv6 实验/">CentOS 6.x ocserv IPv6 实验</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2016年9月29日
        </span>
      </div>
    </header>

    

    <div class="post-content">
      
        

        
          <h3 id="1-ocserv安装"><a href="#1-ocserv安装" class="headerlink" title="1.ocserv安装"></a>1.ocserv安装</h3><p>需要提前安装好ocserv，运行ocserv服务后，Anyconnect客户端可以成功登录服务器。</p>
<hr>
<h3 id="2-配置"><a href="#2-配置" class="headerlink" title="2.配置"></a>2.配置</h3><h4 id="修改ocserv-conf"><a href="#修改ocserv-conf" class="headerlink" title="修改ocserv.conf"></a>修改ocserv.conf</h4><strike style="color:red">添加如下字段，其中ipv6-network字段从vps供应商处获取，或者通过查看自己网卡获取的ipv6地址来找出ipv6的网络地址，记住一定要在网络地址后加::，例如x:x:x:x::，否者无法连接服务。prefix也是从供应商处获知，dns自己可以填写谷歌的公共ipv6 DNS服务器或者其他。</strike>

<pre><code>ipv6-network = 2607:f358:1a:1::
ipv6-prefix = 64
ipv6-dns = 2001:4860:4860::8888
ipv6-dns = 2001:4860:4860::8844
</code></pre><blockquote>
<p><span style="color:red"><strong>修订：</strong></span>填写vps供应商提供的可以路由的IPv6地址池，如果vps供应商没提供可以全局路由的IPv6地址池，则无法配置支持IPv6的ocserv。距离例子如下所示，DNS服务器可以填写谷歌的公共IPv6 DNS。</p>
</blockquote>
<pre><code>ipv6-network = 2607:f358:1a:1::
ipv6-prefix = 124
ipv6-dns = 2001:4860:4860::8888
ipv6-dns = 2001:4860:4860::8844
</code></pre><h4 id="开启ipv6转发"><a href="#开启ipv6转发" class="headerlink" title="开启ipv6转发"></a>开启ipv6转发</h4><p>root用户下执行如下命令，开启ipv6转发功能</p>
<p>sysctl net.ipv6.conf.all.forwarding</p>
<h4 id="ip6tables修改"><a href="#ip6tables修改" class="headerlink" title="ip6tables修改"></a>ip6tables修改</h4><p>ip6tables中不存在nat表，所以只删除filter表FORWARD链中可能阻碍的条目即可，在我的vps中缺省有拒绝转发所有请求的条目，删除之。</p>
<blockquote>
<p><span style="color:red"><strong>提示：</strong></span>ocserv.conf的修改一定要严格遵守格式，否则Anyconnect客户端无法连接服务器，之前在最后少写个冒号，导致了这个问题。DNS服务器推荐填写google的公共DNS。</p>
</blockquote>
<hr>
<h3 id="3-连接测试"><a href="#3-连接测试" class="headerlink" title="3.连接测试"></a>3.连接测试</h3><h4 id="iPhone连接"><a href="#iPhone连接" class="headerlink" title="iPhone连接"></a>iPhone连接</h4><p>iPhone连接成功，成功地获取了IPv4地址和IPv6地址，如图3-1所示。可以进行IPv4访问，但是仍然无法访问IPv6网站。。</p>
<p><span style="color:purple">图3-1</span><br><img src="http://qingdao.icean.cc:11234/Imgbed/openconnect_IPv6/3-1.jpg" alt=""></p>
<h4 id="PC测试"><a href="#PC测试" class="headerlink" title="PC测试"></a>PC测试</h4><p>PC连接成功，成功地获取IPv4和IPv6地址，如图3-2所示，但是IPv6却无网络连接，如图3-3所示。</p>
<p><span style="color:purple">图3-2</span><br><img src="http://qingdao.icean.cc:11234/Imgbed/openconnect_IPv6/3-2.jpg" alt=""></p>
<p><span style="color:purple">图3-3</span><br><img src="http://qingdao.icean.cc:11234/Imgbed/openconnect_IPv6/3-3.jpg" alt=""></p>
<hr>
<h3 id="4-排错流程"><a href="#4-排错流程" class="headerlink" title="4.排错流程"></a>4.排错流程</h3><h4 id="网关地址寻找"><a href="#网关地址寻找" class="headerlink" title="网关地址寻找"></a>网关地址寻找</h4><strike style="color:red">在vps上通过traceroute6命令来找到vps所在局域网的网关地址，如图4-1所示，第一跳为网关地址。</strike><br>&gt;<span style="color:red"><strong>修订：</strong></span>vps的网关确实为图4-1所圈出的，但是在Anyconnect客户端连接时vps服务器会生成vpns0的网卡，该网卡的地址如下所示。对于接入到vps服务器的Anyconnect客户端而言，其获取的网关地址是vps服务器的虚拟网卡，而不是vps服务器局域网的网关，之前理解为填写vps服务器所在局域网的IPv6地址段，客户端获取的IPv6地址是接入的到vps所在的局域网，其实则不然，因为填写了vps所在局域网的地址池前缀，所以接入到vps服务器的客户端其发送的数据包，都被发送到vpns0这块虚拟网卡之上，但是该网卡IPv6地址与vps的IPv6网关地址冲突，因为数据包无法被转发，所以无法接入vps的Anyconnect的IPv6网络无法连接到因特网。<br><br>    vpns0 Link encap:UNSPEC  HWaddr 00-00-00-00-00-00-00-00-00-00-00-00-00-00-00-00<br>          inet addr:192.168.30.1  P-t-P:192.168.30.172  Mask:255.255.255.255<br>          inet6 addr: 2607:f358:1a:1::1/128 Scope:Global<br>          UP POINTOPOINT RUNNING  MTU:1341  Metric:1<br>          RX packets:0 errors:0 dropped:0 overruns:0 frame:0<br>          TX packets:1 errors:0 dropped:0 overruns:0 carrier:0<br>          collisions:0 txqueuelen:500<br>          RX bytes:0 (0.0 b)  TX bytes:76 (76.0 b)<br><br><span style="color:purple">图4-1</span><br><img src="http://qingdao.icean.cc:11234/Imgbed/openconnect_IPv6/4-1.png" alt=""><br><br><strike style="color:red">在PC端ping网关和手机的IPv6地址，ping成功，如图4-2，图4-3所示。</strike><br>&gt;<span style="color:red"><strong>修订：</strong></span>虽然Anyconnect客户端无法通过IPv6接入网络，但是局域网还是可以进行通信。<br><br><span style="color:purple">图4-2</span><br><img src="http://qingdao.icean.cc:11234/Imgbed/openconnect_IPv6/4-2.png" alt=""><br><br><span style="color:purple">图4-3</span><br><img src="http://qingdao.icean.cc:11234/Imgbed/openconnect_IPv6/4-3.png" alt=""><br><br>说明局域网之间是可以通信的。<br><br>#### tcpdump抓包 ####<br>使用tcpdump进行抓包，抓包的过程中，手机向一个IPv6站点发送http请求。抓包命令如下。<br><br>    tcpdump ip6 -w ipv6.cap<br><br><strike style="color:red">抓包结果如图4-4所示，http请求发出去若干个但是，但是没有收到回应。</strike><br>&gt;<span style="color:red"><strong>修订：</strong></span>数据包都发送到了vpns0网卡，可以被tcpdump抓到。<br><br><span style="color:purple">图4-4</span><br><img src="http://qingdao.icean.cc:11234/Imgbed/openconnect_IPv6/4-4.png" alt=""><br><br><strike style="color:red">由此暂时可以认为http请求数据包已经发出，但是却没有收到任何回应，ocserv的配置没有问题。</strike>

<blockquote>
<p><span style="color:red"><strong>修订：</strong></span>http请求没有发出去，因为vpns0和vps的IPv6默认网关冲突，此时vps都</p>
</blockquote>
<h4 id="tracert排错"><a href="#tracert排错" class="headerlink" title="tracert排错"></a>tracert排错</h4><strike style="color:red">在PC使用Anyconnect连接到服务器之后，命令行下使用tracert，查看结果，如图4-5所示，tracert只能到网关无法到下一跳，由此可以认为在网关路由器处http请求没有被转发。</strike>

<blockquote>
<p><span style="color:red"><strong>修订：</strong></span>tracert只能到vpns0，无法tracert到下一跳。</p>
</blockquote>
<p><span style="color:purple">图4-5</span><br><img src="http://qingdao.icean.cc:11234/Imgbed/openconnect_IPv6/4-5.png" alt=""></p>
<hr>
<h3 id="5-结论与猜想"><a href="#5-结论与猜想" class="headerlink" title="5.结论与猜想"></a>5.结论与猜想</h3><h4 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h4><ul>
<li><strike style="color:red">vps服务商可能禁用了非注册IPv6地址的转发。</strike></li>
<li><strike style="color:red">ocserv配置可能还存在问题，具体问题不得而知。</strike></li>
<li><strike style="color:red">设备获取的IPv6地址不是eui-64地址，配置方式不得而知。</strike>

</li>
</ul>
<p>如果在ocserv.conf中填写的ipv6地址池范围，不被上游路由器转发，则vpn方式接入的设备仍无法上网，如果填写和vps所在的网段相同，也无法上网，因为vps会在有设备接入的时候，虚拟化出一张网卡，该网卡的IPv6地址和局域网网关的IP地址一样，所以其数据包也不会被转发。</p>
<h4 id="猜想"><a href="#猜想" class="headerlink" title="猜想"></a>猜想</h4><ul>
<li>换一家vps供应商试试，例如linode或者搬瓦工。</li>
<li>在自己局域网的双栈linux主机上尝试配置ocserv服务，并进行验证。</li>
</ul>

        
      
    </div>

    
  </article>

    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2016/09/29/CentOS 6.x PPTP + Radius + Mysql + Daloradius/">CentOS 6.x PPTP + Radius + Mysql + Daloradius</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2016年9月29日
        </span>
      </div>
    </header>

    

    <div class="post-content">
      
        

        
          <h3 id="1-radius服务器安装"><a href="#1-radius服务器安装" class="headerlink" title="1. radius服务器安装"></a>1. radius服务器安装</h3><h4 id="yum安装相关软件"><a href="#yum安装相关软件" class="headerlink" title="yum安装相关软件"></a>yum安装相关软件</h4><pre><code>yum install freeradius freeradius-mysql freeradius-utils mysql-server -y
</code></pre><h4 id="mysql设置"><a href="#mysql设置" class="headerlink" title="mysql设置"></a>mysql设置</h4><p>启动mysql</p>
<pre><code>service mysqld start
</code></pre><p>设置mysql密码和安全设置<br>    /usr/bin/mysql_secure_installation</p>
<p>创建数据库并授权</p>
<pre><code>mysql -uroot -p
mysql-&gt; CREATE DATABASE radius;
mysql-&gt; GRANT ALL PRIVILEGES ON radius.* TO radius@localhost IDENTIFIED BY &quot;radpass&quot;;
mysql-&gt; flush privileges;
</code></pre><p>导入数据表</p>
<pre><code>mysql&gt; use radius;
mysql&gt; SOURCE /etc/raddb/sql/mysql/schema.sql;
mysql&gt; exit；
</code></pre><h4 id="修改freeadius配置文件"><a href="#修改freeadius配置文件" class="headerlink" title="修改freeadius配置文件"></a>修改freeadius配置文件</h4><p>编辑freeradius配置文件，开启sql认证</p>
<p>文件1：/etc/raddb/sql.conf </p>
<pre><code># Connection info:
server = &quot;localhost&quot;
#port = 3306
login = &quot;radius&quot;  #mysql登录用户名
password = &quot;radpass&quot; #上述登录用户名的密码
# Database table configuration for everything except Oracle
radius_db = &quot;radius&quot;
</code></pre><p>文件2：/etc/raddb/radiusd.conf</p>
<pre><code>$INCLUDE  sql.conf   #去掉前面的注释
</code></pre><p>文件3： /etc/raddb/sites-available/default</p>
<pre><code>authorize{} accounting {} session {} 去掉里面sql前面的注释
</code></pre><p>文件4： /etc/raddb/sites-available/inner-tunnel </p>
<pre><code>authorize {} session {} 去掉里面sql前面的注释
</code></pre><p>文件5： /etc/raddb/clients.conf，修改本地客户端的共享key</p>
<pre><code>secret = testing123 这个key太简单，可以为一个随机字符串。例如：
secret = 3c23498n349c3yt290y93b4t3
</code></pre><p>可以在这个文件中添加其他客户端。</p>
<h4 id="iptables端口开放"><a href="#iptables端口开放" class="headerlink" title="iptables端口开放"></a>iptables端口开放</h4><p>需要在iptables上开放1812到1814之间，以及18120的udp端口</p>
<pre><code>iptables -A INPUT -p udp --dport 1812:1814 -j ACCEPT
iptables -A INPUT -p udp --dport 18120 -j ACCEPT
</code></pre><h4 id="启动测试radius服务"><a href="#启动测试radius服务" class="headerlink" title="启动测试radius服务"></a>启动测试radius服务</h4><p>启动freeradius服务</p>
<pre><code>service radiusd restart
</code></pre><p>添加用户信息</p>
<pre><code>mysql -uroot -p
use radius;
insert into radcheck (username,attribute,op,value) values (&apos;test&apos;,&apos;User-Password&apos;,&apos;:=&apos;,&apos;test&apos;);
exit；
radtest test test 127.0.0.1 0 3c23498n349c3yt290y93b4t3
</code></pre><p>看到“rad_recv: Access-Accept” 则本地客户端认证成功。</p>
<blockquote>
<p><span style="color:red"><strong>提示：</strong></span>若出现radtest测试出现radclient:: Failed to find IP address for servername，修改  /etc/hosts 添加：127.0.0.1 servername</p>
</blockquote>
<hr>
<h3 id="2-pptp服务器设置"><a href="#2-pptp服务器设置" class="headerlink" title="2.pptp服务器设置"></a>2.pptp服务器设置</h3><h4 id="配置文件修改"><a href="#配置文件修改" class="headerlink" title="配置文件修改"></a>配置文件修改</h4><p>修改/etc/ppp/option.pptpd,添加如下</p>
<pre><code>plugin /usr/lib64/pppd/2.4.5/radius.so
plugin /usr/lib64/pppd/2.4.5/radattr.so
radius-config-file /etc/radiusclient/radiusclient.conf
</code></pre><p>去掉/etc/pptpd.conf中的logwtmp字段</p>
<blockquote>
<p><span style="color:red"><strong>提示：</strong></span>pptp需要在iptables上开放gre协议，如果没有开放该端口，则无法进行验证，即无法登陆成功。这个问题在公网vps还没遇到，但是在同一个局域网内的pptp服务器则有这个问题。</p>
<pre><code>iptables -A INPUT -p gre -j ACCEPT
</code></pre></blockquote>
<h4 id="freeradius客户端安装设置"><a href="#freeradius客户端安装设置" class="headerlink" title="freeradius客户端安装设置"></a>freeradius客户端安装设置</h4><p>安装freeadius客户端，没有安装epel源的需要yum安装epel源，freeradius-utils为测试工具，radtest为freeradius-utils命令。</p>
<pre><code>yum install epel-release
yum install freeradius-client freeradius-utils -y
</code></pre><h4 id="freearadius配置"><a href="#freearadius配置" class="headerlink" title="freearadius配置"></a>freearadius配置</h4><p><strong>radius客户端</strong>修改/etc/radiusclient/servers，添加条目，若是本地radius服务器，添加如下，rootroot为共享密钥，需要和服务器配置文件/etc/raddb/clients.conf中localhost中的secret一样。</p>
<pre><code>localhost/localhost rootroot
</code></pre><p>若要使用远程服务器，<strong>radius客户端</strong>需要在/etc/radiusclient/servers中添加如下，centos2为服务器主机名，需要在hosts文件中添加相应解析条目。</p>
<pre><code>centos2/centos2 rootroot
</code></pre><p><strong>radius客户端</strong>也需要在/etc/radiusclient/radiusclient.conf中修改配置，修改</p>
<pre><code>authserver  centos2
acctserver  centos2
</code></pre><p><strong>radius服务器</strong>端的/etc/raddb/clients.conf添加如下配置，架设客户端为centos1，ip地址为192.168.86.101，secret为rootroot。在服务器端的hosts中也需要添加关于centos1的地址解析条目。</p>
<pre><code>client centos1 {
    ipaddr = 192.168.86.101
    secret= rootroot
    require_message_authenticator = no
    nastype = other 
}  
</code></pre><h4 id="freeadius测试"><a href="#freeadius测试" class="headerlink" title="freeadius测试"></a>freeadius测试</h4><p>客户端可以使用radtest测试远端radius服务器命令，若不成功，可以在服务器端查看/var/log/radius/radius.log来进行debug</p>
<h4 id="字典添加设置"><a href="#字典添加设置" class="headerlink" title="字典添加设置"></a>字典添加设置</h4><p>修改/etc/radiusclient/radiusclient.conf中的<code>/usr/share/radiusclient/dictionary</code>，将其修改为<code>/etc/radiusclient/dictionary</code>。注释掉84行的<code>radius_deadtime    0</code> 和87行<code>bindaddr *</code></p>
<p>下载微软字典</p>
<pre><code>wget http://qingdao.icean.cc:11234/dictionary.microsoft
</code></pre><p>修改/etc/radiusclient/dictionary字典文件，在文件末尾添加如下</p>
<pre><code>INCLUDE /etc/radiusclient/dictionary.microsoft
INCLUDE /etc/radiusclient/dictionary.merit 
</code></pre><p>需要将<code>dictionary.microsoft, dictionary.merit</code>放在<code>/etc/radiusclient</code>目录下,dictionary.merit在<code>/usr/share/radiusclient/</code>目录下。</p>
<blockquote>
<p><span style="color:red"><strong>修订：</strong></span>需要将dictionary中所有关于IPv6的选项全部注释掉，否则无法鉴定成功。若出现鉴定失败字样，请使用tail -f /var/log/message来动态查看信息。</p>
</blockquote>
<hr>
<h3 id="3-Daloradius安装"><a href="#3-Daloradius安装" class="headerlink" title="3.Daloradius安装"></a>3.Daloradius安装</h3><h4 id="LAMP环境搭建"><a href="#LAMP环境搭建" class="headerlink" title="LAMP环境搭建"></a>LAMP环境搭建</h4><p>Daloradius是基于LAMP环境的，所以首先需要搭建LAMP环境</p>
<h4 id="下载安装"><a href="#下载安装" class="headerlink" title="下载安装"></a>下载安装</h4><p>下载daloradius源码</p>
<pre><code>cd usr/share
wget http://downloads.sourceforge.net/project/daloradius/daloradius/daloradius0.9-9/daloradius-0.9-9.tar.gz
tar -xvzf daloradius-0.9-9.tar.gz
mv daloradius-0.9-9 daloradius
</code></pre><h4 id="编辑daloradius配置文件"><a href="#编辑daloradius配置文件" class="headerlink" title="编辑daloradius配置文件"></a>编辑daloradius配置文件</h4><p>修改/usr/share/daloradius/library/daloradius.conf.php</p>
<pre><code>$configValues[&apos;CONFIG_DB_HOST&apos;] = &apos;localhost&apos;;
$configValues[&apos;CONFIG_DB_USER&apos;] = &apos;radius&apos;;
$configValues[&apos;CONFIG_DB_PASS&apos;] = &apos;***&apos;;  // 设为自己的密码
$configValues[&apos;CONFIG_DB_NAME&apos;] = &apos;radius&apos;;
</code></pre><p>修改daloRadius路径</p>
<pre><code>$configValues[&apos;CONFIG_PATH_DALO_VARIABLE_DATA&apos;] = &apos;/usr/share/daloradius/var&apos;
</code></pre><h4 id="mysql导入表格数据"><a href="#mysql导入表格数据" class="headerlink" title="mysql导入表格数据"></a>mysql导入表格数据</h4><p>导入daloradius数据</p>
<pre><code>mysql -uroot -p radius &lt; /usr/share/daloradius/contrib/db/fr2-mysql-daloradius-and-freeradius.sql
</code></pre><h4 id="添加Apache虚拟主机"><a href="#添加Apache虚拟主机" class="headerlink" title="添加Apache虚拟主机"></a>添加Apache虚拟主机</h4><p>在/etc/httpd/conf/httpd.conf中加入</p>
<pre><code>Alias /daloradius &quot;/usr/share/daloradius/&quot;
&lt;Directory &quot;/usr/share/daloradius&quot;&gt;
&lt;/Directory&gt;
</code></pre><h4 id="php-pear-DB安装"><a href="#php-pear-DB安装" class="headerlink" title="php-pear-DB安装"></a>php-pear-DB安装</h4><p>安装该软件，否则在浏览器下可以登录daloradius，但是出现http 500错误。</p>
<h4 id="重启服务并网页访问"><a href="#重启服务并网页访问" class="headerlink" title="重启服务并网页访问"></a>重启服务并网页访问</h4><p>重启httpd，mysqld服务并在浏览器下输入<a href="http://[ip" target="_blank" rel="external">http://[ip</a> address]/daloradius，默认账户为administrator，密码为radius</p>

        
      
    </div>

    
  </article>

    
  </section>

  
  <nav class="pagination">
    
      <a class="prev" href="/">
        <i class="iconfont icon-left"></i>
        <span class="prev-text">上一页</span>
      </a>
    
    
      <a class="next" href="/page/3/">
        <span class="next-text">下一页</span>
        <i class="iconfont icon-right"></i>
      </a>
    
  </nav>


          </div>
          
        </div>  
      </main>

      <footer id="footer" class="footer">
  <div class="social-links">
    
      
        
          <a href="mailto:mailto:iceanness@gmail.com" class="iconfont icon-email" title="email"></a>
        
      
    
      
    
      
        
          <a href="https://twitter.com/Iceanian" class="iconfont icon-twitter" title="twitter"></a>
        
      
    
      
    
      
        
          <a href="https://github.com/icean" class="iconfont icon-github" title="github"></a>
        
      
    
      
        
          <a href="http://weibo.com/1509230644" class="iconfont icon-weibo" title="weibo"></a>
        
      
    
      
    
    
    
  </div>


<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://hexo.io/">Hexo</a> 强力驱动
  </span>
  
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/ahonn/hexo-theme-even">Even</a>
  </span>

  <span class="copyright-year">
    
    &copy; 
     
      2015 - 
    
    2017

    <span class="heart">
      <! --<i class="iconfont icon-heart"></i>
    </span>
    <span class="author">Icean L</span>
  </span>
</div>
      </footer>

      <div class="back-to-top" id="back-to-top">
        <i class="iconfont icon-up"></i>
      </div>
    </div>

    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"kompass"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>


    
  





  
    <script type="text/javascript" src="/lib/jquery/jquery-3.1.1.min.js"></script>
  

  
    <script type="text/javascript" src="/lib/fancybox/jquery.fancybox.pack.js"></script>
  

    <script type="text/javascript" src="/js/src/even.js?v=2.1.x"></script>
<script type="text/javascript" src="/js/src/bootstrap.js?v=2.1.x"></script>

    <!-- <script src="http://code.jquery.com/jquery-1.9.1.js"></script>
    <script src="/plugins/prettify/prettify.js" type="text/javascript"></script>
    <script type="text/javascript">
      $(window).load(function(){
      $('pre').addClass('prettyprint linenums').attr('style', 'overflow:auto;');
      prettyPrint();
    }) 
    </script> -->
  </body>

</html>