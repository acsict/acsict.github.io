<!DOCTYPE html>
<html lang="">
  <head>
    <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>


<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />









  <link rel="alternate" href="/atom.xml" title="Kompass">




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=2.1.x" />



<link rel="canonical" href="http://yoursite.com/"/>


<meta property="og:type" content="website">
<meta property="og:title" content="Kompass">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="Kompass">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Kompass">


<link rel="stylesheet" type="text/css" href="/css/style.css?v=2.1.x" />



  <link rel="stylesheet" type="text/css" href="/lib/fancybox/jquery.fancybox.css" />




  


<!-- <link href="/plugins/prettify/prettify.css" rel="stylesheet"> -->

    <title> Kompass </title>
  </head>

  <body>
    <div class="container">
      <header id="header" class="header"><div class="logo-wrapper">
  <a href="/." class="logo"><img src="http://qingdao.icean.cc:11234/Imgbed/logo.png" height="58" width="58">  Kompass</a>
  
</div>

<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        <li class="menu-item">
          <a class="menu-item-link" href="/">
            
            
              主页
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/archives/">
            
            
              归档
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/tags">
            
            
              标签
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/about">
            
            
              关于
            
          </a>
        </li>
      
      
    </ul>
  
</nav>

<div class="mobile-navbar">
  <div class="mobile-header">
    <div class="mobile-header-logo">
      <a href="/." class="logo">Kompass</a>
    </div>

    <div class="mobile-header-icon">
      <span></span>
      <span></span>
      <span></span>
    </div>
  </div>
  <nav class="mobile-menu">
    
      <a class="mobile-menu-item" href="/">
        
        
          主页
        
      </a>
    
      <a class="mobile-menu-item" href="/archives/">
        
        
          归档
        
      </a>
    
      <a class="mobile-menu-item" href="/tags">
        
        
          标签
        
      </a>
    
      <a class="mobile-menu-item" href="/about">
        
        
          关于
        
      </a>
    
  </nav>
</div>
      </header>

      <main id="main" class="main">
        <div class="content-wrapper">
          <div id="content" class="content">
            
  <section id="posts" class="posts">
    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2017/01/29/Anyconnect 用户配置手册（图文版）/">Anyconnect 用户配置手册（图文版）</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2017年1月29日
        </span>
      </div>
    </header>

    

    <div class="post-content">
      
        

        
          <h3 id="提示"><a href="#提示" class="headerlink" title="提示"></a>提示</h3><ul>
<li><span style="color:red">红色字体</span>需要重点注意，带<span style="color:red"><strong>*</strong></span>标注信息客服会提供</li>
<li>客服联系方式<ul>
<li>QQ: 444080836</li>
<li>Telegram: Mniulso</li>
<li>Email: iceantale@gmail.com</li>
</ul>
</li>
</ul>
<hr>
<h3 id="客户端安装"><a href="#客户端安装" class="headerlink" title="客户端安装"></a>客户端安装</h3><p>AnyConnect为思科推出的VPN客户端，目前已有Windows、Android、iOS、OS X、Ubuntu等操作系统的客户端，根据操作系统的需求，下载Anyconnect安装包，并安装客户端。</p>
<table>
<thead>
<tr>
<th>操作系统</th>
<th>官方下载途径</th>
<th>个人分享</th>
</tr>
</thead>
<tbody>
<tr>
<td>iOS</td>
<td>Appstore</td>
<td></td>
</tr>
<tr>
<td>Mac OS X</td>
<td>从官网下载要求授权</td>
<td><a href="http://pan.baidu.com/s/1mixwrm4" target="_blank" rel="external">下载链接</a></td>
</tr>
<tr>
<td>Android</td>
<td>GooglePlay或国内安卓商店</td>
<td><a href="http://pan.baidu.com/s/1o8dAcm2" target="_blank" rel="external">下载链接</a></td>
</tr>
<tr>
<td>Windows</td>
<td>从官网下载要求授权</td>
<td><a href="http://pan.baidu.com/s/1geIjFXL" target="_blank" rel="external">下载链接</a></td>
</tr>
<tr>
<td>Linux</td>
<td>用包管理器安装openconnect</td>
<td><a href="http://pan.baidu.com/s/1kVm2Tk7" target="_blank" rel="external">下载链接</a></td>
</tr>
</tbody>
</table>
<p>如果需要下载其他平台客户端，请到这个<a href="http://pan.baidu.com/s/1c1Gnhrq" target="_blank" rel="external">链接</a>去下载对应的客户端。</p>
<hr>
<h3 id="iOS"><a href="#iOS" class="headerlink" title="iOS"></a>iOS</h3><ul>
<li>选择连接，添加VPN连接</li>
</ul>
<center><img src="http://qingdao.icean.cc:11234/Imgbed/Anyconnect/iOS/new/iOS-1.jpg" alt=""></center><center style="color:purple"><strong>图1-1</strong></center>

<center><img src="http://qingdao.icean.cc:11234/Imgbed/Anyconnect/iOS/new/iOS-2.jpg" alt=""></center><center style="color:purple"><strong>图1-2</strong></center>

<ul>
<li>说明：任意</li>
<li>服务器地址<span style="color:red"><strong>*</strong></span>: 服务器域名或者URL</li>
</ul>
<center><img src="http://qingdao.icean.cc:11234/Imgbed/Anyconnect/iOS/new/iOS-3.jpg" alt=""></center><center style="color:purple"><strong>图1-3</strong></center>

<ul>
<li>选择刚创建的VPN，并连接</li>
</ul>
<center><img src="http://qingdao.icean.cc:11234/Imgbed/Anyconnect/iOS/new/iOS-4.jpg" alt=""></center><center style="color:purple"><strong>图1-4</strong></center>

<center><img src="http://qingdao.icean.cc:11234/Imgbed/Anyconnect/iOS/new/iOS-5.jpg" alt=""></center><center style="color:purple"><strong>图1-5</strong></center>

<ul>
<li>账号<span style="color:red"><strong>*</strong></span>：登录Anyconnect所用账户</li>
</ul>
<center><img src="http://qingdao.icean.cc:11234/Imgbed/Anyconnect/iOS/new/iOS-6.jpg" alt=""></center><center style="color:purple"><strong>图1-6</strong></center>

<ul>
<li>密码<span style="color:red"><strong>*</strong></span>：登录Anyconnect所用密码</li>
</ul>
<center><img src="http://qingdao.icean.cc:11234/Imgbed/Anyconnect/iOS/new/iOS-7.jpg" alt=""></center><center style="color:purple"><strong>图1-7</strong></center>

<ul>
<li>Anyconnect连接成功，并可以查看详细信息</li>
</ul>
<center><img src="http://qingdao.icean.cc:11234/Imgbed/Anyconnect/iOS/new/iOS-8.jpg" alt=""></center><center style="color:purple"><strong>图1-8</strong></center>

<ul>
<li>Anyconnect详细信息</li>
</ul>
<center><img src="http://qingdao.icean.cc:11234/Imgbed/Anyconnect/iOS/new/iOS-9.jpg" alt=""></center><center style="color:purple"><strong>图1-9</strong></center>

<ul>
<li>如果出现<span style="color:red">不信任的服务器</span>警告，则修改设置，将<strong>阻止不信任的服务器</strong>的勾选去掉。</li>
</ul>
<center><img src="http://qingdao.icean.cc:11234/Imgbed/Anyconnect/iOS/new/iOS-10.jpg" alt=""></center><center style="color:purple"><strong>图1-10</strong></center>

<hr>
<h3 id="MAC-OS-X"><a href="#MAC-OS-X" class="headerlink" title="MAC OS X"></a>MAC OS X</h3><ul>
<li>启动Anyconnect</li>
<li>服务器地址<span style="color:red"><strong>*</strong></span>: 服务器域名或者URL</li>
</ul>
<center><img src="http://qingdao.icean.cc:11234/Imgbed/Anyconnect/MACOSX/new/Macosx-1.jpg" alt=""></center><center style="color:purple"><strong>图2-1</strong></center>

<ul>
<li>继续连接，选择<strong>Connect Anyway</strong></li>
</ul>
<center><img src="http://qingdao.icean.cc:11234/Imgbed/Anyconnect/MACOSX/new/Macosx-4.jpg" alt=""></center><center style="color:purple"><strong>图2-4</strong></center>

<ul>
<li>账号<span style="color:red"><strong>*</strong></span>：登录Anyconnect所用账户</li>
</ul>
<center><img src="http://qingdao.icean.cc:11234/Imgbed/Anyconnect/MACOSX/new/Macosx-5.jpg" alt=""></center><center style="color:purple"><strong>图2-5</strong></center>

<ul>
<li>密码<span style="color:red"><strong>*</strong></span>：登录Anyconnect所用密码</li>
</ul>
<center><img src="http://qingdao.icean.cc:11234/Imgbed/Anyconnect/MACOSX/new/Macosx-6.jpg" alt=""></center><center style="color:purple"><strong>图2-6</strong></center>

<ul>
<li>继续连接，选择<strong>Connect Anyway</strong></li>
</ul>
<center><img src="http://qingdao.icean.cc:11234/Imgbed/Anyconnect/MACOSX/new/Macosx-7.jpg" alt=""></center><center style="color:purple"><strong>图2-7</strong></center>

<ul>
<li>Anyconnect连接成功</li>
</ul>
<center><img src="http://qingdao.icean.cc:11234/Imgbed/Anyconnect/MACOSX/new/Macosx-8.jpg" alt=""></center><center style="color:purple"><strong>图2-8</strong></center>

<ul>
<li>查看连接数据</li>
</ul>
<center><img src="http://qingdao.icean.cc:11234/Imgbed/Anyconnect/MACOSX/new/Macosx-9.jpg" alt=""></center><center style="color:purple"><strong>图2-9</strong></center>

<ul>
<li>如果出现<span style="color:red">Untrusted Server Blocked</span>，则修改设置，将<strong>Block connections to untrusted servers</strong>的勾选去掉。</li>
</ul>
<center><img src="http://qingdao.icean.cc:11234/Imgbed/Anyconnect/MACOSX/new/Macosx-2.jpg" alt=""></center><center style="color:purple"><strong>图2-2</strong></center>

<center><img src="http://qingdao.icean.cc:11234/Imgbed/Anyconnect/MACOSX/new/Macosx-3.jpg" alt=""></center><center style="color:purple"><strong>图2-3</strong></center>

<hr>
<h3 id="Android"><a href="#Android" class="headerlink" title="Android"></a>Android</h3><ul>
<li>选择连接，添加VPN连接</li>
</ul>
<center><img src="http://qingdao.icean.cc:11234/Imgbed/Anyconnect/Android/new/Android-1.jpg" alt=""></center><center style="color:purple"><strong>图3-1</strong></center>

<center><img src="http://qingdao.icean.cc:11234/Imgbed/Anyconnect/Android/new/Android-2.jpg" alt=""></center><center style="color:purple"><strong>图3-2</strong></center>

<ul>
<li>说明：任意</li>
<li>服务器地址<span style="color:red"><strong>*</strong></span>: 服务器域名或者URL</li>
</ul>
<center><img src="http://qingdao.icean.cc:11234/Imgbed/Anyconnect/Android/new/Android-3.jpg" alt=""></center><center style="color:purple"><strong>图3-3</strong></center>

<ul>
<li>选择刚创建的VPN，并连接</li>
</ul>
<center><img src="http://qingdao.icean.cc:11234/Imgbed/Anyconnect/Android/new/Android-4.jpg" alt=""></center><center style="color:purple"><strong>图3-4</strong></center>

<center><img src="http://qingdao.icean.cc:11234/Imgbed/Anyconnect/Android/new/Android-5.jpg" alt=""></center><center style="color:purple"><strong>图3-5</strong></center>

<ul>
<li>证书不可靠警告，选择<strong>继续</strong>进行连接</li>
</ul>
<center><img src="http://qingdao.icean.cc:11234/Imgbed/Anyconnect/Android/new/Android-6.jpg" alt=""></center><center style="color:purple"><strong>图3-6</strong></center>

<ul>
<li>账号<span style="color:red"><strong>*</strong></span>：登录Anyconnect所用账户</li>
</ul>
<center><img src="http://qingdao.icean.cc:11234/Imgbed/Anyconnect/Android/new/Android-7.jpg" alt=""></center><center style="color:purple"><strong>图3-7</strong></center>

<ul>
<li>密码<span style="color:red"><strong>*</strong></span>：登录Anyconnect所用密码</li>
</ul>
<center><img src="http://qingdao.icean.cc:11234/Imgbed/Anyconnect/Android/new/Android-8.jpg" alt=""></center><center style="color:purple"><strong>图3-8</strong></center>

<ul>
<li>选择<strong>我信任此应用</strong></li>
</ul>
<center><img src="http://qingdao.icean.cc:11234/Imgbed/Anyconnect/Android/new/Android-9.jpg" alt=""></center><center style="color:purple"><strong>图3-9</strong></center>

<ul>
<li>连接VPN成功</li>
</ul>
<center><img src="http://qingdao.icean.cc:11234/Imgbed/Anyconnect/Android/new/Android-10.jpg" alt=""></center><center style="color:purple"><strong>图3-10</strong></center>

<ul>
<li>如果出现<span style="color:red">不信任的服务器</span>警告，则修改设置，将<strong>阻止不信任的服务器</strong>的勾选去掉。</li>
</ul>
<center><img src="http://qingdao.icean.cc:11234/Imgbed/Anyconnect/Android/new/Android-11.jpg" alt=""></center><center style="color:purple"><strong>图3-11</strong></center>

<center><img src="http://qingdao.icean.cc:11234/Imgbed/Anyconnect/Android/new/Android-12.jpg" alt=""></center><center style="color:purple"><strong>图3-12</strong></center>

<hr>
<h3 id="Windows"><a href="#Windows" class="headerlink" title="Windows"></a>Windows</h3><ul>
<li>启动Anyconnect</li>
<li>服务器地址<span style="color:red"><strong>*</strong></span>: 服务器域名或者URL</li>
</ul>
<center><img src="http://qingdao.icean.cc:11234/Imgbed/Anyconnect/Windows/new/win-1.jpg" alt=""></center><center style="color:purple"><strong>图4-1</strong></center>

<ul>
<li>账号<span style="color:red"><strong>*</strong></span>：登录Anyconnect所用账户</li>
</ul>
<center><img src="http://qingdao.icean.cc:11234/Imgbed/Anyconnect/Windows/new/win-2.jpg" alt=""></center><center style="color:purple"><strong>图4-2</strong></center>

<ul>
<li>密码<span style="color:red"><strong>*</strong></span>：登录Anyconnect所用密码</li>
</ul>
<center><img src="http://qingdao.icean.cc:11234/Imgbed/Anyconnect/Windows/new/win-3.jpg" alt=""></center><center style="color:purple"><strong>图4-3</strong></center>

<ul>
<li>选择连接VPN</li>
</ul>
<center><img src="http://qingdao.icean.cc:11234/Imgbed/Anyconnect/Windows/new/win-4.jpg" alt=""></center><center style="color:purple"><strong>图4-4</strong></center>

<ul>
<li>连接VPN成功</li>
</ul>
<center><img src="http://qingdao.icean.cc:11234/Imgbed/Anyconnect/Windows/new/win-5.jpg" alt=""></center><center style="color:purple"><strong>图4-5</strong></center>

<ul>
<li>VPN连接详情</li>
</ul>
<center><img src="http://qingdao.icean.cc:11234/Imgbed/Anyconnect/Windows/new/win-6.jpg" alt=""></center><center style="color:purple"><strong>图4-6</strong></center>

<ul>
<li>如果出现<span style="color:red">Untrusted Server Blocked</span>，则修改设置，将<strong>Block connections to untrusted servers</strong>的勾选去掉。</li>
</ul>
<center><img src="http://qingdao.icean.cc:11234/Imgbed/Anyconnect/Windows/new/win-7.jpg" alt=""></center><center style="color:purple"><strong>图4-7</strong></center><br><center><img src="http://qingdao.icean.cc:11234/Imgbed/Anyconnect/Windows/new/win-8.jpg" alt=""></center><center style="color:purple"><strong>图4-8</strong></center>


        
      
    </div>

    
  </article>

    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2017/01/29/IKEv2 用户配置手册（图文版）/">IKEv2 用户配置手册（图文版）</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2017年1月29日
        </span>
      </div>
    </header>

    

    <div class="post-content">
      
        

        
          <h3 id="提示-amp-FAQ"><a href="#提示-amp-FAQ" class="headerlink" title="提示 &amp; FAQ"></a>提示 &amp; FAQ</h3><h4 id="提示"><a href="#提示" class="headerlink" title="提示"></a>提示</h4><ul>
<li><span style="color:red">红色字体</span>需要重点注意，带<span style="color:red"><strong>*</strong></span>标注信息客服会提供</li>
<li>客服联系方式<ul>
<li>QQ: 444080836</li>
<li>Telegram: Mniulso</li>
<li>Email: iceantale@gmail.com</li>
</ul>
</li>
</ul>
<h4 id="FAQ"><a href="#FAQ" class="headerlink" title="FAQ"></a>FAQ</h4><ul>
<li>Windows、Android、iOS和Mac OS X使用的证书是相同的吗？<ul>
<li>所有平台使用的证书均是同样的证书文件，不同平台导入方法不同而已。</li>
</ul>
</li>
</ul>
<hr>
<h3 id="iOS"><a href="#iOS" class="headerlink" title="iOS"></a>iOS</h3><h4 id="系统版本要求"><a href="#系统版本要求" class="headerlink" title="系统版本要求"></a>系统版本要求</h4><p><span style="color:red">iOS 9</span>或者更高版本</p>
<h4 id="证书导入"><a href="#证书导入" class="headerlink" title="证书导入"></a>证书导入</h4><ul>
<li>Safari浏览器中输入CA证书下载地址: <a href="https://letsencrypt.org/certs/lets-encrypt-x3-cross-signed.pem，然后选择安装证书" target="_blank" rel="external">https://letsencrypt.org/certs/lets-encrypt-x3-cross-signed.pem，然后选择安装证书</a></li>
</ul>
<center><img src="http://qingdao.icean.cc:11234/Imgbed/ikev2-user/iOS/cert/cert-2.jpg" alt=""></center><center style="color:purple"><strong>图1-1</strong></center>

<ul>
<li>输入iOS密码</li>
</ul>
<center><img src="http://qingdao.icean.cc:11234/Imgbed/ikev2-user/iOS/cert/cert-3.jpg" alt=""></center><center style="color:purple"><strong>图1-2</strong></center>

<ul>
<li>点击安装，导入证书</li>
</ul>
<center><img src="http://qingdao.icean.cc:11234/Imgbed/ikev2-user/iOS/cert/cert-4.jpg" alt=""></center><center style="color:purple"><strong>图1-3</strong></center>

<h4 id="VPN设置"><a href="#VPN设置" class="headerlink" title="VPN设置"></a>VPN设置</h4><ul>
<li>配置位置: <strong>设置 -&gt; VPN -&gt; 添加配置</strong></li>
</ul>
<center><img src="http://qingdao.icean.cc:11234/Imgbed/ikev2-user/iOS/config/iOS-1.jpg" alt=""></center><center style="color:purple"><strong>图1-4</strong></center>

<ul>
<li>类型: IKEv2</li>
<li>描述: 任意</li>
<li>用户鉴定: 用户名</li>
<li>服务器<span style="color:red"><strong>*</strong></span>: VPN服务器URL或者IP地址</li>
<li>用户名<span style="color:red"><strong>*</strong></span>: 登录VPN用户名</li>
<li>密码<span style="color:red"><strong>*</strong></span>: 登录VPN密码</li>
<li>远程ID<span style="color:red"><strong>*</strong></span>: VPN远程ID</li>
<li>本地ID: 留空</li>
</ul>
<center><img src="http://qingdao.icean.cc:11234/Imgbed/ikev2-user/iOS/config/iOS-2.jpg" alt=""></center><center style="color:purple"><strong>图1-5</strong></center>

<ul>
<li>设置完毕后，连接VPN</li>
</ul>
<center><img src="http://qingdao.icean.cc:11234/Imgbed/ikev2-user/iOS/config/iOS-3.jpg" alt=""></center><center style="color:purple"><strong>图1-6</strong></center>

<hr>
<h3 id="MAC-OS-X"><a href="#MAC-OS-X" class="headerlink" title="MAC OS X"></a>MAC OS X</h3><h4 id="系统版本要求-1"><a href="#系统版本要求-1" class="headerlink" title="系统版本要求"></a>系统版本要求</h4><p><span style="color:red">OS X 10.11 (“El Capitan”)</span>或者更高版本</p>
<h4 id="证书导入-1"><a href="#证书导入-1" class="headerlink" title="证书导入"></a>证书导入</h4><ul>
<li>下载CA证书到本地，下载地址为: <a href="https://letsencrypt.org/certs/lets-encrypt-x3-cross-signed.pem" target="_blank" rel="external">https://letsencrypt.org/certs/lets-encrypt-x3-cross-signed.pem</a></li>
<li>配置位置: <strong>钥匙串访问 -&gt; 钥匙串 -&gt; 系统</strong></li>
</ul>
<center><img src="http://qingdao.icean.cc:11234/Imgbed/ikev2-user/MacOSX/cert/cert-1.jpg" alt=""></center><center style="color:purple"><strong>图2-1</strong></center>

<center><img src="http://qingdao.icean.cc:11234/Imgbed/ikev2-user/MacOSX/cert/cert-2.jpg" alt=""></center><center style="color:purple"><strong>图2-2</strong></center>

<ul>
<li>选择要添加的证书文件</li>
</ul>
<center><img src="http://qingdao.icean.cc:11234/Imgbed/ikev2-user/MacOSX/cert/cert-3.jpg" alt=""></center><center style="color:purple"><strong>图2-3</strong></center>

<ul>
<li>导入证书</li>
</ul>
<center><img src="http://qingdao.icean.cc:11234/Imgbed/ikev2-user/MacOSX/cert/cert-4.jpg" alt=""></center><center style="color:purple"><strong>图2-4</strong></center>

<center><img src="http://qingdao.icean.cc:11234/Imgbed/ikev2-user/MacOSX/cert/cert-5.jpg" alt=""></center><center style="color:purple"><strong>图2-5</strong></center>

<h4 id="VPN设置-1"><a href="#VPN设置-1" class="headerlink" title="VPN设置"></a>VPN设置</h4><ul>
<li>配置位置: <strong>设置 -&gt; 网络 -&gt;添加网络连接</strong></li>
</ul>
<center><img src="http://qingdao.icean.cc:11234/Imgbed/ikev2-user/MacOSX/config/macosx-1.jpg" alt=""></center><center style="color:purple"><strong>图2-6</strong></center>

<ul>
<li>接口: VPN</li>
<li>VPN类型: IKEv2</li>
<li>服务名称: 任意</li>
</ul>
<center><img src="http://qingdao.icean.cc:11234/Imgbed/ikev2-user/MacOSX/config/macosx-2.jpg" alt=""></center><center style="color:purple"><strong>图2-7</strong></center>

<ul>
<li>服务器<span style="color:red"><strong>*</strong></span>: VPN服务器URL或者IP地址</li>
<li>远程ID<span style="color:red"><strong>*</strong></span>: VPN远程ID</li>
<li>本地ID: 留空</li>
<li>鉴定设置 -&gt; 用户名<span style="color:red"><strong>*</strong></span>: 登录VPN用户名</li>
<li>鉴定设置 -&gt; 密码<span style="color:red"><strong>*</strong></span>: 登录VPN密码</li>
</ul>
<center><img src="http://qingdao.icean.cc:11234/Imgbed/ikev2-user/MacOSX/config/macosx-3.jpg" alt=""></center><center style="color:purple"><strong>图2-8</strong></center>

<ul>
<li>选择连接VPN</li>
</ul>
<center><img src="http://qingdao.icean.cc:11234/Imgbed/ikev2-user/MacOSX/config/macosx-4.png" alt=""></center><center style="color:purple"><strong>图2-9</strong></center>

<ul>
<li>连接VPN成功</li>
</ul>
<center><img src="http://qingdao.icean.cc:11234/Imgbed/ikev2-user/MacOSX/config/macosx-5.jpg" alt=""></center><center style="color:purple"><strong>图2-10</strong></center>

<hr>
<h3 id="Android"><a href="#Android" class="headerlink" title="Android"></a>Android</h3><h4 id="系统版本要求-2"><a href="#系统版本要求-2" class="headerlink" title="系统版本要求"></a>系统版本要求</h4><p><span style="color:red">Android 4</span>或者更高版本，需要安装<a href="http://pan.baidu.com/s/1gfkEXKB" target="_blank" rel="external">Strongswan客户端</a>，下载地址为：<a href="http://pan.baidu.com/s/1gfkEXKB" target="_blank" rel="external">http://pan.baidu.com/s/1gfkEXKB</a></p>
<h4 id="证书导入-2"><a href="#证书导入-2" class="headerlink" title="证书导入"></a>证书导入</h4><ul>
<li>下载CA证书到本机，下载地址为: <a href="https://letsencrypt.org/certs/lets-encrypt-x3-cross-signed.pem" target="_blank" rel="external">https://letsencrypt.org/certs/lets-encrypt-x3-cross-signed.pem</a></li>
<li>Strongswan客户端中导入服务器证书</li>
<li>配置位置: <strong>CA certificates -&gt; Import certificates</strong></li>
</ul>
<center><img src="http://qingdao.icean.cc:11234/Imgbed/ikev2-user/android/cert/cert-1.jpg" alt=""></center><center style="color:purple"><strong>图3-1</strong></center>

<center><img src="http://qingdao.icean.cc:11234/Imgbed/ikev2-user/android/cert/cert-2.jpg" alt=""></center><center style="color:purple"><strong>图3-2</strong></center>

<ul>
<li>选择证书文件</li>
</ul>
<center><img src="http://qingdao.icean.cc:11234/Imgbed/ikev2-user/android/cert/cert-3.jpg" alt=""></center><center style="color:purple"><strong>图3-3</strong></center>

<ul>
<li>确认导入证书</li>
</ul>
<center><img src="http://qingdao.icean.cc:11234/Imgbed/ikev2-user/android/cert/cert-4.jpg" alt=""></center><center style="color:purple"><strong>图3-4</strong></center>

<ul>
<li>可以查看导入的CA证书</li>
</ul>
<center><img src="http://qingdao.icean.cc:11234/Imgbed/ikev2-user/android/cert/cert-5.jpg" alt=""></center><center style="color:purple"><strong>图3-5</strong></center>

<h4 id="VPN设置-2"><a href="#VPN设置-2" class="headerlink" title="VPN设置"></a>VPN设置</h4><ul>
<li>配置位置：<strong>ADD VPN PROFILE</strong></li>
</ul>
<center><img src="http://qingdao.icean.cc:11234/Imgbed/ikev2-user/android/config/android-1.jpg" alt=""></center><center style="color:purple"><strong>图3-6</strong></center>


<ul>
<li>服务器<span style="color:red"><strong>*</strong></span>: VPN服务器URL或者IP地址</li>
<li>VPN类型: IKEv2 EAP</li>
<li>用户名<span style="color:red"><strong>*</strong></span>: 登录VPN用户名</li>
<li>密码<span style="color:red"><strong>*</strong></span>: 登录VPN密码</li>
</ul>
<center><img src="http://qingdao.icean.cc:11234/Imgbed/ikev2-user/android/config/android-2.jpg" alt=""></center><center style="color:purple"><strong>图3-7</strong></center>

<ul>
<li>添加完毕后，点击配置完毕的VPN</li>
</ul>
<center><img src="http://qingdao.icean.cc:11234/Imgbed/ikev2-user/android/config/android-3.jpg" alt=""></center><center style="color:purple"><strong>图3-8</strong></center>

<ul>
<li>连接VPN成功</li>
</ul>
<center><img src="http://qingdao.icean.cc:11234/Imgbed/ikev2-user/android/config/android-4.jpg" alt=""></center><center style="color:purple"><strong>图3-9</strong></center>

<hr>
<h3 id="Windows"><a href="#Windows" class="headerlink" title="Windows"></a>Windows</h3><h4 id="系统版本要求-3"><a href="#系统版本要求-3" class="headerlink" title="系统版本要求"></a>系统版本要求</h4><p><span style="color:red">Win 7</span>或者更高版本</p>
<h4 id="证书导入-3"><a href="#证书导入-3" class="headerlink" title="证书导入"></a>证书导入</h4><p>Windows使用IKEv2 VPN需要导入服务器CA证书到<span style="color:red"><strong>信任根证书颁发机构</strong></span>，以win7为例，win8/10类似</p>
<ul>
<li>下载CA证书到本机，下载地址为: <a href="https://letsencrypt.org/certs/lets-encrypt-x3-cross-signed.pem" target="_blank" rel="external">https://letsencrypt.org/certs/lets-encrypt-x3-cross-signed.pem</a></li>
<li>开始菜单搜索<strong>mmc（Microsoft 管理控制台）</strong></li>
</ul>
<center><img src="http://qingdao.icean.cc:11234/Imgbed/ikev2-user/Windows/cert/cert-1.jpg" alt=""></center><center style="color:purple"><strong>图4-1</strong></center>

<ul>
<li><strong>文件</strong>-<strong>添加/删除管理单元</strong>，添加<strong>证书</strong>单元</li>
</ul>
<center><img src="http://qingdao.icean.cc:11234/Imgbed/ikev2-user/Windows/cert/cert-2.jpg" alt=""></center><center style="color:purple"><strong>图4-2</strong></center>

<center><img src="http://qingdao.icean.cc:11234/Imgbed/ikev2-user/Windows/cert/cert-3.jpg" alt=""></center><center style="color:purple"><strong>图4-3</strong></center>

<ul>
<li>证书单元的弹出窗口中选<strong>计算机账户</strong>，之后选<strong>本地计算机</strong>，确定</li>
</ul>
<center><img src="http://qingdao.icean.cc:11234/Imgbed/ikev2-user/Windows/cert/cert-4.jpg" alt=""></center><center style="color:purple"><strong>图4-4</strong></center>

<center><img src="http://qingdao.icean.cc:11234/Imgbed/ikev2-user/Windows/cert/cert-5.jpg" alt=""></center><center style="color:purple"><strong>图4-5</strong></center>

<ul>
<li>在左边的<strong>控制台根节点</strong>下选择<strong>证书</strong> -&gt; <strong>受信任的根证书颁发机构</strong> -&gt; <strong>证书</strong>，右键 -&gt; <strong>所有任务</strong> -&gt; <strong>导入</strong>打开证书导入窗口。</li>
</ul>
<center><img src="http://qingdao.icean.cc:11234/Imgbed/ikev2-user/Windows/cert/cert-6.jpg" alt=""></center><center style="color:purple"><strong>图4-6</strong></center>

<center><img src="http://qingdao.icean.cc:11234/Imgbed/ikev2-user/Windows/cert/cert-7.jpg" alt=""></center><center style="color:purple"><strong>图4-7</strong></center>

<ul>
<li>选择证书文件导入即可</li>
</ul>
<center><img src="http://qingdao.icean.cc:11234/Imgbed/ikev2-user/Windows/cert/cert-8.jpg" alt=""></center><center style="color:purple"><strong>图4-8</strong></center>



<center><img src="http://qingdao.icean.cc:11234/Imgbed/ikev2-user/Windows/cert/cert-9.jpg" alt=""></center><center style="color:purple"><strong>图4-9</strong></center>

<h4 id="VPN设置-3"><a href="#VPN设置-3" class="headerlink" title="VPN设置"></a>VPN设置</h4><h5 id="Win10-Win8"><a href="#Win10-Win8" class="headerlink" title="Win10/Win8"></a>Win10/Win8</h5><ul>
<li>配置位置: <strong>设置 -&gt; 网络和Internet -&gt; VPN -&gt; 添加VPN</strong></li>
</ul>
<center><img src="http://qingdao.icean.cc:11234/Imgbed/ikev2-user/Windows/win10/win10-1.jpg" alt=""></center><center style="color:purple"><strong>图4-10</strong></center>

<center><img src="http://qingdao.icean.cc:11234/Imgbed/ikev2-user/Windows/win10/win10-2.jpg" alt=""></center><center style="color:purple"><strong>图4-11</strong></center>

<center><img src="http://qingdao.icean.cc:11234/Imgbed/ikev2-user/Windows/win10/win10-3.jpg" alt=""></center><center style="color:purple"><strong>图4-12</strong></center>

<ul>
<li>VPN提供商: Windows（内置）</li>
<li>连接名称: 任意</li>
<li>服务器名称或地址<span style="color:red"><strong>*</strong></span>: VPN服务器URL或者IP地址</li>
<li>VPN类型: IKEv2</li>
<li>登录信息类型: 用户名和密码</li>
<li>用户名<span style="color:red"><strong>*</strong></span>: 登录VPN用户名</li>
<li>密码<span style="color:red"><strong>*</strong></span>: 登录VPN密码</li>
</ul>
<center><img src="http://qingdao.icean.cc:11234/Imgbed/ikev2-user/Windows/win10/win10-4.jpg" alt=""></center><center style="color:purple"><strong>图4-13</strong></center>

<ul>
<li>连接VPN</li>
</ul>
<center><img src="http://qingdao.icean.cc:11234/Imgbed/ikev2-user/Windows/win10/win10-5.jpg" alt=""></center><center style="color:purple"><strong>图4-14</strong></center>

<ul>
<li>继续连接，信任证书</li>
</ul>
<center><img src="http://qingdao.icean.cc:11234/Imgbed/ikev2-user/Windows/win10/win10-6.jpg" alt=""></center><center style="color:purple"><strong>图4-15</strong></center>

<ul>
<li>连接VPN成功</li>
</ul>
<center><img src="http://qingdao.icean.cc:11234/Imgbed/ikev2-user/Windows/win10/win10-7.jpg" alt=""></center><center style="color:purple"><strong>图4-16</strong></center>

<ul>
<li>可以在<strong>控制面板 -&gt; 网络和 Internet -&gt; 网络连接</strong>中查看VPN虚拟网卡信息</li>
</ul>
<center><img src="http://qingdao.icean.cc:11234/Imgbed/ikev2-user/Windows/win10/win10-8.jpg" alt=""></center><center style="color:purple"><strong>图4-17</strong></center>

<h5 id="Win7"><a href="#Win7" class="headerlink" title="Win7"></a>Win7</h5><p> 配置位置: <strong>控制面板 -&gt; 网络和 Internet -&gt; 网络和共享中心 -&gt; 连接新的网络或连接 -&gt; 连接到工作区 -&gt; 创建新连接 -&gt; 使用我的Internet连接(VPN)</strong></p>
<center><img src="http://qingdao.icean.cc:11234/Imgbed/ikev2-user/Windows/win7/win7-1.jpg" alt=""></center><center style="color:purple"><strong>图4-18</strong></center>

<center><img src="http://qingdao.icean.cc:11234/Imgbed/ikev2-user/Windows/win7/win7-2.jpg" alt=""></center><center style="color:purple"><strong>图4-19</strong></center>

<center><img src="http://qingdao.icean.cc:11234/Imgbed/ikev2-user/Windows/win7/win7-3.jpg" alt=""></center><center style="color:purple"><strong>图4-20</strong></center>

<ul>
<li>Internet 地址<span style="color:red"><strong>*</strong></span>: VPN服务器URL或者IP地址</li>
<li>目标名称: 任意</li>
</ul>
<center><img src="http://qingdao.icean.cc:11234/Imgbed/ikev2-user/Windows/win7/win7-4.jpg" alt=""></center><center style="color:purple"><strong>图4-21</strong></center>

<ul>
<li>用户名<span style="color:red"><strong>*</strong></span>: 登录VPN用户名</li>
<li>密码<span style="color:red"><strong>*</strong></span>: 登录VPN密码</li>
</ul>
<center><img src="http://qingdao.icean.cc:11234/Imgbed/ikev2-user/Windows/win7/win7-5.jpg" alt=""></center><center style="color:purple"><strong>图4-22</strong></center>

<ul>
<li><p>设置完毕后，先不连接</p>
<center><img src="http://qingdao.icean.cc:11234/Imgbed/ikev2-user/Windows/win7/win7-6.jpg" alt=""></center><center style="color:purple"><strong>图4-23</strong></center>
</li>
<li><p>配置位置: <strong>控制面板 -&gt; 网络和 Internet -&gt; 网络和共享中心 -&gt; 更改适配器设置</strong></p>
</li>
<li>在新建的 VPN 连接上右键<strong>属性</strong></li>
</ul>
<center><img src="http://qingdao.icean.cc:11234/Imgbed/ikev2-user/Windows/win7/win7-7.jpg" alt=""></center><center style="color:purple"><strong>图4-24</strong></center>

<ul>
<li>切换到<strong>安全</strong>选项卡<ul>
<li>VPN 类型: IKEv2</li>
<li>数据加密选: 需要加密</li>
<li>身份验证：EAP-MSCHAP v2</li>
</ul>
</li>
</ul>
<center><img src="http://qingdao.icean.cc:11234/Imgbed/ikev2-user/Windows/win7/win7-8.jpg" alt=""></center><center style="color:purple"><strong>图4-25</strong></center>

<ul>
<li>连接VPN</li>
</ul>
<center><img src="http://qingdao.icean.cc:11234/Imgbed/ikev2-user/Windows/win7/win7-9.jpg" alt=""></center><center style="color:purple"><strong>图4-26</strong></center>

<ul>
<li>连接VPN成功</li>
</ul>
<center><img src="http://qingdao.icean.cc:11234/Imgbed/ikev2-user/Windows/win7/win7-10.jpg" alt=""></center><center style="color:purple"><strong>图4-27</strong></center>

<hr>
<h3 id="Linux"><a href="#Linux" class="headerlink" title="Linux"></a>Linux</h3><p>Linux 的版本众多，认证方法与协议支持也非常丰富，详细方法请根据 Linux 版本查询连接方法。一般而言，Linux 通过 NetworkManager-strongswan连接。</p>

        
      
    </div>

    
  </article>

    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2017/01/29/IPsec VPN用户配置手册（简版）/">IPsec 用户配置手册（简单版）</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2017年1月29日
        </span>
      </div>
    </header>

    

    <div class="post-content">
      
        

        
          <h3 id="提示"><a href="#提示" class="headerlink" title="提示"></a>提示</h3><ul>
<li><span style="color:red">红色字体</span>需要重点注意，带<span style="color:red"><strong>*</strong></span>标注信息客服会提供</li>
<li>客服联系方式<ul>
<li>QQ: 444080836</li>
<li>Telegram: Mniulso</li>
<li>Email: iceantale@gmail.com</li>
</ul>
</li>
</ul>
<hr>
<h3 id="iOS"><a href="#iOS" class="headerlink" title="iOS"></a>iOS</h3><ul>
<li>配置位置: <strong>设置 -&gt; VPN -&gt; 添加配置 -&gt; IPSec</strong></li>
<li>描述: 任意</li>
<li>用户鉴定: 用户名</li>
<li>服务器<span style="color:red"><strong>*</strong></span>: VPN服务器URL或者IP地址</li>
<li>用户名<span style="color:red"><strong>*</strong></span>: 登录VPN所用账户</li>
<li>密码<span style="color:red"><strong>*</strong></span>: 登录VPN所用密码</li>
<li>密钥<span style="color:red"><strong>*</strong></span>: IPsec VPN预共享密钥</li>
</ul>
<hr>
<h3 id="MAC-OS-X"><a href="#MAC-OS-X" class="headerlink" title="MAC OS X"></a>MAC OS X</h3><ul>
<li>配置位置: <strong>系统偏好设置 -&gt; 网络 -&gt;添加网络连接</strong></li>
<li>接口: VPN</li>
<li>VPN类型: Cisco IPsec</li>
<li>服务器地址<span style="color:red"><strong>*</strong></span>: 服务器URL或者IP地址</li>
<li>账户名称<span style="color:red"><strong>*</strong></span>: 登录VPN所用账户</li>
<li>密码<span style="color:red"><strong>*</strong></span>: 登录VPN所用密码</li>
<li>鉴定设置 -&gt; 共享的密钥<span style="color:red"><strong>*</strong></span>: IPsec VPN预共享密钥</li>
</ul>
<hr>
<h3 id="Android"><a href="#Android" class="headerlink" title="Android"></a>Android</h3><ul>
<li>配置位置: <strong>设置 -&gt; 其它连接方式 -&gt; VPN -&gt; 添加 VPN</strong></li>
<li>名称: 任意</li>
<li>服务器地址<span style="color:red"><strong>*</strong></span>: 服务器URL或者IP地址</li>
<li>类型: IPSec Xauth PSK</li>
<li>IPsec 标识符: 不更改</li>
<li>预共享密钥<span style="color:red"><strong>*</strong></span>: IPsec VPN预共享密钥</li>
<li>用户名<span style="color:red"><strong>*</strong></span>: 登录VPN所用账户</li>
<li>密码<span style="color:red"><strong>*</strong></span>: 登录VPN所用密码</li>
</ul>
<hr>
<h3 id="Windows"><a href="#Windows" class="headerlink" title="Windows"></a>Windows</h3><p><span style="color:red">Windows系统推荐使用IKEv2 VPN<span></span></span></p>
<hr>
<h3 id="Linux"><a href="#Linux" class="headerlink" title="Linux"></a>Linux</h3><p>Linux 的版本众多，认证方法与协议支持也非常丰富，详细方法请根据 Linux 版本查询连接方法。一般而言，Linux 通过 NetworkManager-strongswan。</p>

        
      
    </div>

    
  </article>

    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2017/01/29/Anyconnect 用户配置手册（简版）/">Anyconnect 用户配置手册（简单版）</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2017年1月29日
        </span>
      </div>
    </header>

    

    <div class="post-content">
      
        

        
          <h3 id="提示"><a href="#提示" class="headerlink" title="提示"></a>提示</h3><ul>
<li><span style="color:red">红色字体</span>需要重点注意，带<span style="color:red"><strong>*</strong></span>标注信息客服会提供</li>
<li>客服联系方式<ul>
<li>QQ: 444080836</li>
<li>Telegram: Mniulso</li>
<li>Email: iceantale@gmail.com</li>
</ul>
</li>
</ul>
<hr>
<h3 id="客户端安装"><a href="#客户端安装" class="headerlink" title="客户端安装"></a>客户端安装</h3><p>AnyConnect为思科推出的VPN客户端，目前已有Windows、Android、iOS、OS X、Ubuntu等操作系统的客户端，根据操作系统的需求，下载Anyconnect安装包，并安装客户端。</p>
<table>
<thead>
<tr>
<th>操作系统</th>
<th>官方下载途径</th>
<th>个人分享</th>
</tr>
</thead>
<tbody>
<tr>
<td>iOS</td>
<td>Appstore</td>
<td></td>
</tr>
<tr>
<td>Mac OS X</td>
<td>从官网下载要求授权</td>
<td><a href="http://pan.baidu.com/s/1mixwrm4" target="_blank" rel="external">下载链接</a></td>
</tr>
<tr>
<td>Android</td>
<td>GooglePlay或国内安卓商店</td>
<td><a href="http://pan.baidu.com/s/1o8dAcm2" target="_blank" rel="external">下载链接</a></td>
</tr>
<tr>
<td>Windows</td>
<td>从官网下载要求授权</td>
<td><a href="http://pan.baidu.com/s/1geIjFXL" target="_blank" rel="external">下载链接</a></td>
</tr>
<tr>
<td>Linux</td>
<td>用包管理器安装openconnect</td>
<td><a href="http://pan.baidu.com/s/1kVm2Tk7" target="_blank" rel="external">下载链接</a></td>
</tr>
</tbody>
</table>
<p>如果需要下载其他平台客户端，请到这个<a href="http://pan.baidu.com/s/1c1Gnhrq" target="_blank" rel="external">链接</a>去下载对应的客户端。</p>
<hr>
<h3 id="Anyconnect连接"><a href="#Anyconnect连接" class="headerlink" title="Anyconnect连接"></a>Anyconnect连接</h3><ul>
<li>启动客户端</li>
<li>说明：任意</li>
<li>服务器地址<span style="color:red"><strong>*</strong></span>: 服务器域名或者URL</li>
<li>账号<span style="color:red"><strong>*</strong></span>：登录Anyconnect所用账户</li>
<li>密码<span style="color:red"><strong>*</strong></span>：登录Anyconnect所用密码</li>
<li>Anyconnect连接成功</li>
</ul>
<p>如果出现<span style="color:red">Untrusted Server Blocked/不信任的服务器</span>，则修改设置，将<strong>Block connections to untrusted servers/阻止不信任的服务器</strong>的勾选去掉。</p>

        
      
    </div>

    
  </article>

    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2017/01/29/IKEv2 用户配置手册（简版）/">IKEv2 用户配置手册（简单版）</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2017年1月29日
        </span>
      </div>
    </header>

    

    <div class="post-content">
      
        

        
          <h3 id="提示-amp-FAQ"><a href="#提示-amp-FAQ" class="headerlink" title="提示 &amp; FAQ"></a>提示 &amp; FAQ</h3><h4 id="提示"><a href="#提示" class="headerlink" title="提示"></a>提示</h4><ul>
<li><span style="color:red">红色字体</span>需要重点注意，带<span style="color:red"><strong>*</strong></span>标注信息客服会提供</li>
<li>客服联系方式<ul>
<li>QQ: 444080836</li>
<li>Telegram: Mniulso</li>
<li>Email: iceantale@gmail.com</li>
</ul>
</li>
</ul>
<h4 id="FAQ"><a href="#FAQ" class="headerlink" title="FAQ"></a>FAQ</h4><ul>
<li>Windows、Android、iOS和Mac OS X使用的证书是相同的吗？<ul>
<li>所有平台使用的证书均是同样的证书文件，不同平台导入方法不同而已。</li>
</ul>
</li>
</ul>
<hr>
<h3 id="iOS"><a href="#iOS" class="headerlink" title="iOS"></a>iOS</h3><h4 id="系统版本要求"><a href="#系统版本要求" class="headerlink" title="系统版本要求"></a>系统版本要求</h4><p><span style="color:red">iOS 9</span>或者更高版本</p>
<h4 id="证书导入"><a href="#证书导入" class="headerlink" title="证书导入"></a>证书导入</h4><ul>
<li>Safari浏览器中输入CA证书下载地址: <a href="https://letsencrypt.org/certs/lets-encrypt-x3-cross-signed.pem" target="_blank" rel="external">https://letsencrypt.org/certs/lets-encrypt-x3-cross-signed.pem</a></li>
<li>安装证书到设备</li>
<li>输入iOS密码</li>
</ul>
<h4 id="VPN设置"><a href="#VPN设置" class="headerlink" title="VPN设置"></a>VPN设置</h4><ul>
<li>配置位置: <strong>设置 -&gt; VPN -&gt; 添加配置</strong></li>
<li>类型: IKEv2</li>
<li>描述: 任意</li>
<li>用户鉴定: 用户名</li>
<li>服务器<span style="color:red"><strong>*</strong></span>: VPN服务器URL或者IP地址</li>
<li>用户名<span style="color:red"><strong>*</strong></span>: 登录VPN用户名</li>
<li>密码<span style="color:red"><strong>*</strong></span>: 登录VPN密码</li>
<li>远程ID<span style="color:red"><strong>*</strong></span>: VPN远程ID</li>
<li>本地ID: 留空</li>
</ul>
<hr>
<h3 id="MAC-OS-X"><a href="#MAC-OS-X" class="headerlink" title="MAC OS X"></a>MAC OS X</h3><h4 id="系统版本要求-1"><a href="#系统版本要求-1" class="headerlink" title="系统版本要求"></a>系统版本要求</h4><p><span style="color:red">OS X 10.11 (“El Capitan”)</span>或者更高版本</p>
<h4 id="证书导入-1"><a href="#证书导入-1" class="headerlink" title="证书导入"></a>证书导入</h4><ul>
<li>下载CA证书到本地，下载地址为: <a href="https://letsencrypt.org/certs/lets-encrypt-x3-cross-signed.pem" target="_blank" rel="external">https://letsencrypt.org/certs/lets-encrypt-x3-cross-signed.pem</a></li>
<li>配置位置: <strong>钥匙串访问 -&gt; 钥匙串 -&gt; 系统</strong></li>
<li>选择要添加的证书文件</li>
<li>导入证书</li>
</ul>
<h4 id="VPN设置-1"><a href="#VPN设置-1" class="headerlink" title="VPN设置"></a>VPN设置</h4><ul>
<li>配置位置: <strong>系统偏好设置 -&gt; 网络 -&gt;添加网络连接</strong></li>
<li>接口: VPN</li>
<li>VPN类型: IKEv2</li>
<li>服务名称: 任意</li>
<li>服务器<span style="color:red"><strong>*</strong></span>: VPN服务器URL或者IP地址</li>
<li>远程ID<span style="color:red"><strong>*</strong></span>: VPN远程ID</li>
<li>本地ID: 留空</li>
<li>鉴定设置 -&gt; 用户名<span style="color:red"><strong>*</strong></span>: 登录VPN用户名</li>
<li>鉴定设置 -&gt; 密码<span style="color:red"><strong>*</strong></span>: 登录VPN密码</li>
</ul>
<hr>
<h3 id="Android"><a href="#Android" class="headerlink" title="Android"></a>Android</h3><h4 id="系统版本要求-2"><a href="#系统版本要求-2" class="headerlink" title="系统版本要求"></a>系统版本要求</h4><p><span style="color:red">Android 4</span>或者更高版本，需要安装<a href="http://pan.baidu.com/s/1gfkEXKB" target="_blank" rel="external">Strongswan客户端</a>，下载地址为：<a href="http://pan.baidu.com/s/1gfkEXKB" target="_blank" rel="external">http://pan.baidu.com/s/1gfkEXKB</a></p>
<h4 id="证书导入-2"><a href="#证书导入-2" class="headerlink" title="证书导入"></a>证书导入</h4><ul>
<li>下载CA证书到本机，下载地址为: <a href="https://letsencrypt.org/certs/lets-encrypt-x3-cross-signed.pem" target="_blank" rel="external">https://letsencrypt.org/certs/lets-encrypt-x3-cross-signed.pem</a></li>
<li>配置位置: <strong>CA certificates -&gt; Import certificates</strong></li>
<li>选择证书文件</li>
<li>确认导入证书</li>
</ul>
<h4 id="VPN设置-2"><a href="#VPN设置-2" class="headerlink" title="VPN设置"></a>VPN设置</h4><ul>
<li>配置位置: <strong>ADD VPN PROFILE</strong></li>
<li>服务器<span style="color:red"><strong>*</strong></span>: VPN服务器URL或者IP地址</li>
<li>VPN类型: IKEv2 EAP</li>
<li>用户名<span style="color:red"><strong>*</strong></span>: 登录VPN用户名</li>
<li>密码<span style="color:red"><strong>*</strong></span>: 登录VPN密码</li>
</ul>
<hr>
<h3 id="Windows"><a href="#Windows" class="headerlink" title="Windows"></a>Windows</h3><h4 id="系统版本要求-3"><a href="#系统版本要求-3" class="headerlink" title="系统版本要求"></a>系统版本要求</h4><p><span style="color:red">Win 7</span>或者更高版本</p>
<h4 id="证书导入-3"><a href="#证书导入-3" class="headerlink" title="证书导入"></a>证书导入</h4><p>Windows使用IKEv2 VPN需要导入服务器<a href="https://letsencrypt.org/certs/lets-encrypt-x3-cross-signed.pem" target="_blank" rel="external">CA证书</a>到<span style="color:red"><strong>信任根证书颁发机构</strong></span></p>
<ul>
<li>下载CA证书到本机，下载地址为: <a href="https://letsencrypt.org/certs/lets-encrypt-x3-cross-signed.pem" target="_blank" rel="external">https://letsencrypt.org/certs/lets-encrypt-x3-cross-signed.pem</a></li>
<li><strong>开始</strong>菜单搜索<strong>mmc（Microsoft 管理控制台）</strong></li>
<li><strong>文件</strong> -&gt; <strong>添加/删除管理单元</strong>添加<strong>证书</strong>单元</li>
<li>证书单元的弹出窗口中选<strong>计算机账户</strong>，之后选<strong>本地计算机</strong>，确定</li>
<li>在左边的<strong>控制台根节点</strong>下选择<strong>证书</strong> -&gt; <strong>受信任的根证书颁发机构</strong> -&gt; <strong>证书</strong>，右键 -&gt; <strong>所有任务</strong> -&gt; <strong>导入</strong>打开证书导入窗口。</li>
<li>选择证书文件导入即可</li>
</ul>
<h4 id="VPN设置-3"><a href="#VPN设置-3" class="headerlink" title="VPN设置"></a>VPN设置</h4><h5 id="Win10-Win8"><a href="#Win10-Win8" class="headerlink" title="Win10/Win8"></a>Win10/Win8</h5><ul>
<li>配置位置: <strong>设置 -&gt; 网络和Internet -&gt; VPN -&gt; 添加VPN</strong></li>
<li>VPN提供商: Windows（内置）</li>
<li>连接名称: 任意</li>
<li>服务器名称或地址<span style="color:red"><strong>*</strong></span>: VPN服务器URL或者IP地址</li>
<li>VPN类型: IKEv2</li>
<li>登录信息类型: 用户名和密码</li>
<li>用户名<span style="color:red"><strong>*</strong></span>: 登录VPN用户名</li>
<li>密码<span style="color:red"><strong>*</strong></span>: 登录VPN密码</li>
</ul>
<h5 id="Win7"><a href="#Win7" class="headerlink" title="Win7"></a>Win7</h5><ul>
<li>配置位置: <strong>控制面板 -&gt; 网络和 Internet -&gt; 网络和共享中心 -&gt; 连接新的网络或连接 -&gt; 连接到工作区 -&gt; 创建新连接 -&gt; 使用我的Internet连接(VPN)</strong></li>
<li>Internet 地址<span style="color:red"><strong>*</strong></span>: VPN服务器URL或者IP地址</li>
<li>目标名称: 任意</li>
<li>用户名<span style="color:red"><strong>*</strong></span>: 登录VPN用户名</li>
<li>密码<span style="color:red"><strong>*</strong></span>: 登录VPN密码</li>
</ul>
<p>设置完毕后，先不连接</p>
<ul>
<li>配置位置: <strong>控制面板 -&gt; 网络和 Internet -&gt; 网络和共享中心 -&gt; 更改适配器设置</strong></li>
<li>在新建的 VPN 连接上右键<strong>属性</strong></li>
<li>切换到<strong>安全</strong>选项卡<ul>
<li>VPN 类型: IKEv2</li>
<li>数据加密选: 需要加密</li>
<li>身份验证: EAP-MSCHAP v2</li>
</ul>
</li>
</ul>
<p>win7/8/10连接VPN界面可能不同，但是大同小异。</p>
<hr>
<h3 id="Linux"><a href="#Linux" class="headerlink" title="Linux"></a>Linux</h3><p>Linux 的版本众多，认证方法与协议支持也非常丰富，详细方法请根据 Linux 版本查询连接方法。一般而言，Linux 通过 NetworkManager-strongswan连接。</p>

        
      
    </div>

    
  </article>

    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2017/01/29/IPsec VPN用户配置手册（图文版）/">IPsec 用户配置手册（图文版）</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2017年1月29日
        </span>
      </div>
    </header>

    

    <div class="post-content">
      
        

        
          <h3 id="提示"><a href="#提示" class="headerlink" title="提示"></a>提示</h3><ul>
<li><span style="color:red">红色字体</span>需要重点注意，带<span style="color:red"><strong>*</strong></span>标注信息客服会提供</li>
<li>客服联系方式<ul>
<li>QQ: 444080836</li>
<li>Telegram: Mniulso</li>
<li>Email: iceantale@gmail.com</li>
</ul>
</li>
</ul>
<hr>
<h3 id="iOS"><a href="#iOS" class="headerlink" title="iOS"></a>iOS</h3><ul>
<li>配置位置: <strong>设置 -&gt; VPN -&gt; 添加配置 -&gt; IPSec</strong></li>
</ul>
<center><img src="http://qingdao.icean.cc:11234/Imgbed/IPsec/new/iOS-1.jpg" alt=""></center><center style="color:purple"><strong>图1-1</strong></center>

<ul>
<li>描述: 任意</li>
<li>服务器<span style="color:red"><strong>*</strong></span>: VPN服务器URL或者IP地址</li>
<li>用户名<span style="color:red"><strong>*</strong></span>: 登录VPN所用账户</li>
<li>密码<span style="color:red"><strong>*</strong></span>: 登录VPN所用密码</li>
<li>密钥<span style="color:red"><strong>*</strong></span>: IPsec VPN预共享密钥</li>
</ul>
<center><img src="http://qingdao.icean.cc:11234/Imgbed/IPsec/new/iOS-2.jpg" alt=""></center><center style="color:purple"><strong>图1-2</strong></center>

<ul>
<li>连接刚创建的VPN</li>
</ul>
<center><img src="http://qingdao.icean.cc:11234/Imgbed/IPsec/new/iOS-3.jpg" alt=""></center><center style="color:purple"><strong>图1-3</strong></center>

<ul>
<li>VPN连接成功</li>
</ul>
<center><img src="http://qingdao.icean.cc:11234/Imgbed/IPsec/new/iOS-4.jpg" alt=""></center><center style="color:purple"><strong>图1-4</strong></center>

<hr>
<h3 id="MAC-OS-X"><a href="#MAC-OS-X" class="headerlink" title="MAC OS X"></a>MAC OS X</h3><ul>
<li>配置位置: <strong>系统偏好设置 -&gt; 网络 -&gt;添加网络连接</strong></li>
</ul>
<center><img src="http://qingdao.icean.cc:11234/Imgbed/IPsec/new/Macosx-1.jpg" alt=""></center><center style="color:purple"><strong>图2-1</strong></center>

<ul>
<li>接口: VPN</li>
<li>VPN类型: Cisco IPsec</li>
</ul>
<center><img src="http://qingdao.icean.cc:11234/Imgbed/IPsec/new/Macosx-2.jpg" alt=""></center><center style="color:purple"><strong>图2-2</strong></center>

<ul>
<li>服务器地址<span style="color:red"><strong>*</strong></span>: 服务器URL或者IP地址</li>
<li>账户名称<span style="color:red"><strong>*</strong></span>: 登录VPN所用账户</li>
<li>密码<span style="color:red"><strong>*</strong></span>: 登录VPN所用密码</li>
</ul>
<center><img src="http://qingdao.icean.cc:11234/Imgbed/IPsec/new/Macosx-3.jpg" alt=""></center><center style="color:purple"><strong>图2-3</strong></center>

<ul>
<li>鉴定设置 -&gt; 共享的密钥<span style="color:red"><strong>*</strong></span>: IPsec VPN预共享密钥</li>
</ul>
<center><img src="http://qingdao.icean.cc:11234/Imgbed/IPsec/new/Macosx-4.jpg" alt=""></center><center style="color:purple"><strong>图2-4</strong></center>

<ul>
<li>连接刚创建的VPN</li>
</ul>
<center><img src="http://qingdao.icean.cc:11234/Imgbed/IPsec/new/Macosx-5.jpg" alt=""></center><center style="color:purple"><strong>图2-5</strong></center>

<ul>
<li>VPN连接成功</li>
</ul>
<center><img src="http://qingdao.icean.cc:11234/Imgbed/IPsec/new/Macosx-6.jpg" alt=""></center><center style="color:purple"><strong>图2-6</strong></center>

<hr>
<h3 id="Android"><a href="#Android" class="headerlink" title="Android"></a>Android</h3><ul>
<li>配置位置: <strong>设置 -&gt; 其它连接方式 -&gt; VPN -&gt; 添加 VPN</strong></li>
</ul>
<center><img src="http://qingdao.icean.cc:11234/Imgbed/IPsec/new/Android-1.jpg" alt=""></center><center style="color:purple"><strong>图3-1</strong></center>

<center><img src="http://qingdao.icean.cc:11234/Imgbed/IPsec/new/Android-2.jpg" alt=""></center><center style="color:purple"><strong>图3-2</strong></center>

<ul>
<li>名称: 任意</li>
<li>服务器地址<span style="color:red"><strong>*</strong></span>: 服务器URL或者IP地址</li>
<li>类型: IPSec Xauth PSK</li>
<li>IPsec 标识符: 不更改</li>
<li>预共享密钥<span style="color:red"><strong>*</strong></span>: IPsec VPN预共享密钥</li>
</ul>
<center><img src="http://qingdao.icean.cc:11234/Imgbed/IPsec/new/Android-3.jpg" alt=""></center><center style="color:purple"><strong>图3-3</strong></center>

<ul>
<li>选择连接刚创建的VPN</li>
</ul>
<center><img src="http://qingdao.icean.cc:11234/Imgbed/IPsec/new/Android-4.jpg" alt=""></center><center style="color:purple"><strong>图3-4</strong></center>

<ul>
<li>用户名<span style="color:red"><strong>*</strong></span>: 登录VPN所用账户</li>
<li>密码<span style="color:red"><strong>*</strong></span>: 登录VPN所用密码</li>
</ul>
<center><img src="http://qingdao.icean.cc:11234/Imgbed/IPsec/new/Android-5.jpg" alt=""></center><center style="color:purple"><strong>图3-5</strong></center>

<ul>
<li>VPN连接成功</li>
</ul>
<center><img src="http://qingdao.icean.cc:11234/Imgbed/IPsec/new/Android-6.jpg" alt=""></center><center style="color:purple"><strong>图3-6</strong></center>

<hr>
<h3 id="Windows"><a href="#Windows" class="headerlink" title="Windows"></a>Windows</h3><p><span style="color:red">Windows系统推荐使用IKEv2 VPN<span></span></span></p>
<hr>
<h3 id="Linux"><a href="#Linux" class="headerlink" title="Linux"></a>Linux</h3><p>Linux 的版本众多，认证方法与协议支持也非常丰富，详细方法请根据 Linux 版本查询连接方法。一般而言，Linux 通过 NetworkManager-strongswan。</p>

        
      
    </div>

    
  </article>

    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2017/01/26/IKEv2服务器静态NAT + Freeradius验证 + 流量分离实验/">IKEv2服务器静态NAT + Freeradius验证 + 流量分离实验</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2017年1月26日
        </span>
      </div>
    </header>

    

    <div class="post-content">
      
        

        
          <h3 id="1-需求分析"><a href="#1-需求分析" class="headerlink" title="1. 需求分析"></a>1. 需求分析</h3><ul>
<li>IKEv2服务器地址为私有IP，通过静态NAT映射，外网可以访问</li>
<li>使用Freeradius进行验证</li>
<li>客户端接入VPN之后，只有指定的流量可以通过VPN网关，其他流量仍通过客户端原来的网关</li>
</ul>
<hr>
<h3 id="2-实验环境"><a href="#2-实验环境" class="headerlink" title="2. 实验环境"></a>2. 实验环境</h3><h4 id="2-1-实验拓扑"><a href="#2-1-实验拓扑" class="headerlink" title="2.1 实验拓扑"></a>2.1 实验拓扑</h4><center><img src="http://qingdao.icean.cc:11234/Imgbed/ikev2 + freeradius + nat/topo+.png" alt="topo"></center><center style="color:purple"><strong>图2-1 实验拓扑</strong></center>

<h4 id="2-2-设备信息"><a href="#2-2-设备信息" class="headerlink" title="2.2 设备信息"></a>2.2 设备信息</h4><p>各个设备的操作系统、IP地址以及网卡信息如下所示</p>
<table>
<thead>
<tr>
<th>设备</th>
<th>系统</th>
<th>网卡</th>
<th>IP</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td>IKEv2 Server</td>
<td>CentOS 7</td>
<td>e0</td>
<td>10.10.10.3/24</td>
<td>静态NAT地址为10.10.20.3/24</td>
</tr>
<tr>
<td>Freeradius Server</td>
<td>CentOS 7</td>
<td>e0</td>
<td>10.10.10.2/24</td>
<td></td>
</tr>
<tr>
<td>Router</td>
<td>IOS</td>
<td>f0/0</td>
<td>10.10.10.254/24</td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td>f0/1</td>
<td>10.10.20.254/24</td>
<td>方便测试，使用私有地址</td>
</tr>
<tr>
<td>Client</td>
<td>Windows 7</td>
<td>e0</td>
<td>10.10.20.1/24</td>
<td>网关地址为10.10.20.5</td>
</tr>
<tr>
<td>Internet</td>
<td>CentOS 7</td>
<td>e2</td>
<td>10.10.20.5/24</td>
<td>模拟互联网，实际为多网卡转发</td>
</tr>
</tbody>
</table>
<p><strong>Internet</strong>设备有多个网卡，使用iptables的nat表，将转发到e2网卡的所有流量转发到可以上网的其他网卡，这样<strong>Client</strong>可以与互联网进行连接</p>
<hr>
<h3 id="3-路由器配置"><a href="#3-路由器配置" class="headerlink" title="3. 路由器配置"></a>3. 路由器配置</h3><p>路由器配置如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">interface FastEthernet0/0</div><div class="line"> ip address 10.10.10.254 255.255.255.0</div><div class="line"> ip nat inside</div><div class="line"></div><div class="line">interface FastEthernet0/1</div><div class="line"> ip address 10.10.20.254 255.255.255.0</div><div class="line"> ip nat outside</div><div class="line"></div><div class="line">ip nat inside source static 10.10.10.3 10.10.20.3</div></pre></td></tr></table></figure>
<hr>
<h3 id="4-Strongswan编译安装"><a href="#4-Strongswan编译安装" class="headerlink" title="4. Strongswan编译安装"></a>4. Strongswan编译安装</h3><h4 id="4-1-环境准备"><a href="#4-1-环境准备" class="headerlink" title="4.1 环境准备"></a>4.1 环境准备</h4><p>需要安装如下依赖<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">yum -y install pam-devel</div></pre></td></tr></table></figure></p>
<p>可能还需要安装如下依赖</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">yum install -y openssl-devel make gcc curl wget</div></pre></td></tr></table></figure>
<h4 id="4-2-下载源码"><a href="#4-2-下载源码" class="headerlink" title="4.2 下载源码"></a>4.2 下载源码</h4><p>从<a href="https://www.strongswan.org/" target="_blank" rel="external">Strongswan</a>官网下载最新Strongswan 5.5.1源码到并解压</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">wget https://download.strongswan.org/strongswan-5.5.1.tar.gz</div><div class="line">tar xvf strongswan-5.5.1.tar.gz</div></pre></td></tr></table></figure>
<h4 id="4-3-编译安装"><a href="#4-3-编译安装" class="headerlink" title="4.3 编译安装"></a>4.3 编译安装</h4><p>切换到Strongswan源码解压的目录，执行配置与编译安装<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">cd</span> strongswan-5.5.1</div><div class="line">./configure  --enable-eap-identity --enable-eap-md5 --enable-eap-mschapv2 --enable-eap-tls \</div><div class="line">--enable-eap-ttls --enable-eap-peap --enable-eap-tnc --enable-eap-dynamic \</div><div class="line">--enable-eap-radius --enable-xauth-eap --enable-xauth-pam  --enable-dhcp  \</div><div class="line">--enable-openssl  --enable-addrblock --enable-unity  --enable-certexpire --enable-radattr \</div><div class="line">--enable-swanctl --enable-openssl --disable-gmp --enable-farp</div><div class="line">make &amp;&amp; make install</div></pre></td></tr></table></figure></p>
<p><code>--enable-farp</code>参数为编译farp插件，<a href="https://wiki.strongswan.org/projects/strongswan/wiki/Farpplugin#farp-plugin" target="_blank" rel="external">farp</a>插件允许接入VPN客户端在逻辑上与服务器处于同一局域网</p>
<p><code>--enable-dhcp</code>参数为编译dhcp插件，dhcp插件允许接入VPN客户端获取某个DHCP分配的IP地址</p>
<p>根据主机性能，完成上述编译安装需要的时间不同。安装完成后，可执行文件的路径为/usr/local/sbin, 配置文件路径为/usr/local/etc，配置文件以及文件夹主要如下</p>
<ul>
<li>ipsec.conf              </li>
<li>ipsec.secrets</li>
<li><strong>ipsec.d</strong></li>
<li>strongswan.conf</li>
<li><strong>strongswan.d</strong></li>
<li><strong>swanctl</strong></li>
</ul>
<hr>
<h3 id="5-证书配置"><a href="#5-证书配置" class="headerlink" title="5. 证书配置"></a>5. 证书配置</h3><h4 id="5-1-自签名CA证书"><a href="#5-1-自签名CA证书" class="headerlink" title="5.1 自签名CA证书"></a>5.1 自签名CA证书</h4><p>生成一个CA私钥</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ipsec pki --gen --outform pem &gt; ca.key.pem</div></pre></td></tr></table></figure>
<p>基于私钥生成一个自签名的CA证书<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ipsec pki --self --in ca.key.pem --dn <span class="string">"C=CN, O=ACS, CN=ACS CA"</span> --ca --lifetime 3650 --outform pem &gt; ca.cert.pem</div></pre></td></tr></table></figure></p>
<ul>
<li>–self 表示自签证书</li>
<li>–in 是输入的私钥</li>
<li>–dn 是判别名</li>
<li>C 表示国家名，同样还有 ST 州/省名，L 地区名，STREET（全大写） 街道名</li>
<li>O 组织名称</li>
<li>CN 友好显示的通用名</li>
<li>–ca 表示生成 CA 根证书</li>
<li>–lifetime 为有效期, 单位是天</li>
</ul>
<h4 id="5-2-服务器证书"><a href="#5-2-服务器证书" class="headerlink" title="5.2 服务器证书"></a>5.2 服务器证书</h4><p>生成服务器证书的私钥<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ipsec pki --gen --outform pem &gt; server.key.pem</div></pre></td></tr></table></figure></p>
<p>用自签的 CA 证书签发一个服务器证书<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">ipsec pki --pub --in server.key.pem --outform pem &gt; server.pub.pem</div><div class="line">ipsec pki --issue --lifetime 1200 --cacert ca.cert.pem --cakey ca.key.pem --in server.pub.pem \</div><div class="line">--dn <span class="string">"C=CN, O=Strongswan, CN=test.icean.cc"</span> --san=<span class="string">"test.icean.cc"</span> --flag serverAuth \</div><div class="line">--flag ikeIntermediate --outform pem &gt; server.cert.pem</div></pre></td></tr></table></figure></p>
<p>–issue, –cacert 和–cakey 就是表明要用刚才自签的 CA 证书来签这个服务器证书，–dn, –san，–flag 是一些客户端方面的特殊要求：</p>
<ul>
<li>iOS 客户端要求 CN 也就是通用名必须是服务器的 URL 或 IP 地址;</li>
<li>Windows 7 或者更高版本不但要求了上面，还要求必须显式说明这个服务器证书的用途（用于与服务器进行认证），–flag serverAuth;</li>
<li>非 iOS 的 Mac OS X 要求了“IP 安全网络密钥互换居间（IP Security IKE Intermediate）”这种增强型密钥用法（EKU），–flag ikdeIntermediate;</li>
<li>Android 和 iOS 都要求服务器别名（serverAltName）就是服务器的 URL 或 IP 地址，即是–san，同时Windows 7不能添加额外的服务器别名，Windows 10可以添加</li>
</ul>
<p><span style="color:red"><strong>*</strong></span>为了兼容Windows 7，只添加一个服务器别名（serverAltName）</p>
<h4 id="5-3-安装证书"><a href="#5-3-安装证书" class="headerlink" title="5.3 安装证书"></a>5.3 安装证书</h4><p>复制证书到指定的路径<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">cp ca.key.pem /usr/<span class="built_in">local</span>/etc/ipsec.d/private/</div><div class="line">cp server.key.pem /usr/<span class="built_in">local</span>/etc/ipsec.d/private/</div><div class="line">cp server.cert.pem /usr/<span class="built_in">local</span>/etc/ipsec.d/certs/</div><div class="line">cp ca.cert.pem /usr/<span class="built_in">local</span>/etc/ipsec.d/cacerts/</div></pre></td></tr></table></figure></p>
<hr>
<h3 id="6-Strongswan配置-amp-启动"><a href="#6-Strongswan配置-amp-启动" class="headerlink" title="6. Strongswan配置&amp;启动"></a>6. Strongswan配置&amp;启动</h3><h4 id="6-1-ipsec-conf设置"><a href="#6-1-ipsec-conf设置" class="headerlink" title="6.1 ipsec.conf设置"></a>6.1 ipsec.conf设置</h4><p>基础设置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">config setup</div><div class="line">    uniqueids = no</div><div class="line">    </div><div class="line">conn %default</div><div class="line">    compress = yes</div><div class="line">    keyingtries = 1</div><div class="line">    keyexchange = ike</div></pre></td></tr></table></figure>
<p>IKE基础配置，其中leftsubnet流量选择器的参数，这里设置为客户端只能访问10.10.10.0/24这个网段</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">conn IKE-BASE          </div><div class="line">    leftcert = server.cert.pem                   </div><div class="line">    left = %any</div><div class="line">    leftsubnet = 10.10.10.0/24            #这很重要，只允许VPN接入客户端可以访问这个网段，可以通过逗</div><div class="line">                                                           #号分割， 添加其他单个地址或者网段</div><div class="line">    right = %any</div><div class="line">    rightsourceip = %dhcp                  #使用dhcp插件从局域网的DHCP服务器给客户端分配IP地址，若要</div><div class="line">                                                           #具体选择哪个DHCP服务器，</div></pre></td></tr></table></figure>
<p>IKEv2面向Windows配置，次设置也适用于Linux、Android<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">conn IKEv2-LAW</div><div class="line">    also = IKE-BASE</div><div class="line">    keyexchange = ikev2</div><div class="line">    keyingtries = 1 </div><div class="line">    ike = aes256-sha1-modp1024</div><div class="line">    esp = aes256-sha1</div><div class="line">    leftauth = pubkey</div><div class="line">    leftsendcert = always</div><div class="line">    rightauth = eap-radius</div><div class="line">    rekey = no</div><div class="line">    eap_identity = %identity</div><div class="line">    auto = add</div></pre></td></tr></table></figure></p>
<p>IKEv2面向iOS、MAC OS X配置，<span style="color:red">*</span><code>leftid</code>需要和服务器URL或者IP地址一致，否则无法登录。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">conn IKEv2-Apple</div><div class="line">    also = IKE-BASE</div><div class="line">    keyexchange = ikev2</div><div class="line">    keyingtries = 1 </div><div class="line">    ike = aes256-sha256-modp1024</div><div class="line">    esp = aes256-sha256</div><div class="line">    leftid =  test.icean.cc</div><div class="line">    leftauth = pubkey</div><div class="line">    leftsendcert = always</div><div class="line">    rightauth = eap-radius</div><div class="line">    rightsendcert = never</div><div class="line">    fragmentation = yes </div><div class="line">    rekey = yes</div><div class="line">    eap_identity = %identity</div><div class="line">    auto = add</div></pre></td></tr></table></figure></p>
<h4 id="6-2-strongswan-conf设置"><a href="#6-2-strongswan-conf设置" class="headerlink" title="6.2 strongswan.conf设置"></a>6.2 strongswan.conf设置</h4><p>修改/usr/local/etc/strongswan.conf，修改为如下，其中filelog选项可以调节等级，通过修改default后面的数字调节日志等级</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">charon &#123;</div><div class="line">    load_modular = yes </div><div class="line">    filelog &#123;</div><div class="line">        /var/log/charon.log &#123;</div><div class="line">            time_format = %b %e %T</div><div class="line">            ike_name = yes </div><div class="line">            append = no</div><div class="line">            default = 2 </div><div class="line">            flush_line = yes </div><div class="line">        &#125;   </div><div class="line">        stderr &#123;</div><div class="line">            ike = 2 </div><div class="line">            knl = 3 </div><div class="line">        &#125;                                                                                                                                                            </div><div class="line">    &#125;   </div><div class="line">    syslog &#123;</div><div class="line">        identifier = charon-custom</div><div class="line">        daemon &#123;</div><div class="line">        &#125;   </div><div class="line">        auth &#123;</div><div class="line">            default = -1</div><div class="line">            ike = 0 </div><div class="line">        &#125;   </div><div class="line">    &#125;                                                                                                                                                </div><div class="line">    plugins &#123;</div><div class="line">        include strongswan.d/charon/*.conf</div><div class="line">    &#125;   </div><div class="line">&#125;</div><div class="line">include strongswan.d/*.conf</div></pre></td></tr></table></figure>
<h4 id="6-3-ipsec-secrets设置"><a href="#6-3-ipsec-secrets设置" class="headerlink" title="6.3 ipsec.secrets设置"></a>6.3 ipsec.secrets设置</h4><p>配置验证方式的用户名与密码，<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">: RSA server.key.pem 		#使用证书验证时的服务器端私钥</div></pre></td></tr></table></figure></p>
<h4 id="6-4-Freeradius设置"><a href="#6-4-Freeradius设置" class="headerlink" title="6.4 Freeradius设置"></a>6.4 Freeradius设置</h4><p>修改/usr/local/etc/strongswan.d/charon/eap-radius .conf，设置accounting改为yes，并添加servers中添加Freeradius 服务器<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">accounting = yes</div><div class="line">servers &#123;</div><div class="line">  RadiusServer &#123;</div><div class="line">       secret = testing1234        #与Freeradius 服务器的暗码</div><div class="line">       address = 10.10.10.2        #Freeradius 服务器IP地址</div><div class="line">       auth_port = 1812             #验证端口</div><div class="line">       acct_port = 1813              #记账端口</div><div class="line">               &#125;</div><div class="line">       &#125;</div></pre></td></tr></table></figure></p>
<p>freeradius服务器设置参考其他资料，这里使用的测试帐号和密码都是test</p>
<h4 id="6-5-iptables设置"><a href="#6-5-iptables设置" class="headerlink" title="6.5 iptables设置"></a>6.5 iptables设置</h4><p>开放UDP的500和4500端口，删除转发表所有拒绝的条目，保存并重启iptables服务<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">iptables -A INPUT -p udp -m udp --dport 4500 -j ACCEPT</div><div class="line">iptables -A INPUT -p udp -m udp --dport 500 -j ACCEPT  </div><div class="line">iptables -D FORWARD 1</div><div class="line">service iptables save</div><div class="line">service iptables restart</div></pre></td></tr></table></figure></p>
<h4 id="6-6-Strongswan服务启动"><a href="#6-6-Strongswan服务启动" class="headerlink" title="6.6 Strongswan服务启动"></a>6.6 Strongswan服务启动</h4><p>启动服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ipsec start</div></pre></td></tr></table></figure>
<hr>
<h3 id="7-客户端设置-Windows"><a href="#7-客户端设置-Windows" class="headerlink" title="7. 客户端设置-Windows"></a>7. 客户端设置-Windows</h3><h4 id="7-1-系统版本要求"><a href="#7-1-系统版本要求" class="headerlink" title="7.1 系统版本要求"></a>7.1 系统版本要求</h4><p>Windows 7或者更高版本</p>
<h4 id="7-2-证书导入"><a href="#7-2-证书导入" class="headerlink" title="7.2 证书导入"></a>7.2 证书导入</h4><ul>
<li>下载<strong>ca.cert.pem</strong>(自签名CA证书)到本地</li>
</ul>
<ul>
<li>开始菜单搜索 <strong>mmc（Microsoft 管理控制台）</strong></li>
<li><strong>文件</strong> -&gt; <strong>添加/删除管理单元</strong>，添加<strong>证书</strong>单元</li>
<li>证书单元的弹出窗口中选<strong>计算机账户</strong>，之后选<strong>本地计算机</strong>，确定</li>
<li>在左边的<strong>控制台根节点</strong>下选择<strong>证书</strong> -&gt; <strong>受信任的根证书颁发机构</strong> -&gt; <strong>证书</strong>，右键 -&gt; <strong>所有任务</strong> -&gt; <strong>导入</strong>，打开证书导入窗口。</li>
<li>选择证书文件导入即可</li>
</ul>
<h4 id="7-3-DNS设置"><a href="#7-3-DNS设置" class="headerlink" title="7.3 DNS设置"></a>7.3 DNS设置</h4><p>在<code>C:\Windows\System32\drivers\etc\hosts</code>中添加如下解析条目</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">10.10.20.3 test.icean.cc</div></pre></td></tr></table></figure>
<p>在正式生产环境中，需要在DNS服务器具体设置</p>
<h4 id="7-4-VPN设置"><a href="#7-4-VPN设置" class="headerlink" title="7.4 VPN设置"></a>7.4 VPN设置</h4><h5 id="7-4-1-Win10-Win8"><a href="#7-4-1-Win10-Win8" class="headerlink" title="7.4.1 Win10/Win8"></a>7.4.1 Win10/Win8</h5><ul>
<li>配置位置: <strong>设置 -&gt; 网络和Internet -&gt; VPN -&gt; 添加VPN</strong></li>
<li>VPN提供商: Windows（内置）</li>
<li>连接名称: 任意</li>
<li>服务器名称或地址: test.icean.cc</li>
<li>VPN类型: IKEv2</li>
<li>登录信息类型: 用户名和密码</li>
<li>用户名: test</li>
<li>密码: test</li>
</ul>
<h5 id="7-4-2-Win7"><a href="#7-4-2-Win7" class="headerlink" title="7.4.2 Win7"></a>7.4.2 Win7</h5><ul>
<li>配置位置: <strong>控制面板 -&gt; 网络和 Internet -&gt; 网络和共享中心 -&gt; 连接新的网络或连接 -&gt; 连接到工作区 -&gt; 创建新连接 -&gt; 使用我的Internet连接(VPN)</strong></li>
<li>Internet 地址: test.icean.cc</li>
<li>目标名称: 任意</li>
<li>用户名: test</li>
<li>密码: test</li>
</ul>
<p>设置完毕后，先不连接</p>
<ul>
<li>配置位置: <strong>控制面板 -&gt; 网络和 Internet -&gt; 网络和共享中心 -&gt; 更改适配器设置</strong></li>
<li>在新建的 VPN 连接上右键<strong>属性</strong></li>
<li>切换到<strong>安全</strong>选项卡<ul>
<li>VPN 类型: IKEv2</li>
<li>数据加密选: 需要加密</li>
<li>身份验证: EAP-MSCHAP v2</li>
</ul>
</li>
</ul>
<p>然后选择连接VPN，win7/8/10连接界面可能不同，但是大同小异。</p>
<h4 id="7-5-网关设置"><a href="#7-5-网关设置" class="headerlink" title="7.5 网关设置"></a>7.5 网关设置</h4><p>若不想将本机的默认网关设置为VPN服务器的网关，Windows设置如下</p>
<ul>
<li>配置位置：<strong>控制面板 -&gt; 网络和 Internet -&gt; 网络和共享中心 -&gt; 更改适配器设置</strong></li>
<li>在新建的 VPN 连接上右键<strong>属性</strong></li>
<li>切换到<strong>网络</strong>选项卡<ul>
<li>选择<strong>Internet协议版本4 -&gt; 高级 </strong></li>
<li>切换到<strong>IP设置</strong>选项卡</li>
<li>不选择<strong>在远程网络上使用默认网关</strong>，然后保存</li>
</ul>
</li>
<li>再次连接VPN</li>
</ul>
<h4 id="7-6-连接测试"><a href="#7-6-连接测试" class="headerlink" title="7.6 连接测试"></a>7.6 连接测试</h4><p>VPN登录成功后，查看路由表，10.10.10.4是从VPN网关获取的地址，默认网关还是10.10.20.5</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">IPv4 路由表</div><div class="line">=========================================================================</div><div class="line">活动路由:</div><div class="line">网络目标        网络掩码          网关       接口   跃点数</div><div class="line">          <span class="number">0.0</span>.<span class="number">0.0</span>          <span class="number">0.0</span>.<span class="number">0.0</span>       <span class="number">10.10</span>.<span class="number">20.5</span>       <span class="number">10.10</span>.<span class="number">20.1</span>    <span class="number">266</span></div><div class="line">         <span class="number">10.0</span>.<span class="number">0.0</span>        <span class="number">255.0</span>.<span class="number">0.0</span>            在链路上        <span class="number">10.10</span>.<span class="number">10.4</span>     <span class="number">11</span></div><div class="line">       <span class="number">10.10</span>.<span class="number">10.4</span>  <span class="number">255.255</span>.<span class="number">255.255</span>            在链路上        <span class="number">10.10</span>.<span class="number">10.4</span>    <span class="number">266</span></div><div class="line">       <span class="number">10.10</span>.<span class="number">20.0</span>    <span class="number">255.255</span>.<span class="number">255.0</span>            在链路上        <span class="number">10.10</span>.<span class="number">20.1</span>    <span class="number">266</span></div><div class="line">       <span class="number">10.10</span>.<span class="number">20.1</span>  <span class="number">255.255</span>.<span class="number">255.255</span>            在链路上        <span class="number">10.10</span>.<span class="number">20.1</span>    <span class="number">266</span></div><div class="line">       <span class="number">10.10</span>.<span class="number">20.3</span>  <span class="number">255.255</span>.<span class="number">255.255</span>            在链路上        <span class="number">10.10</span>.<span class="number">20.1</span>     <span class="number">11</span></div><div class="line">     <span class="number">10.10</span>.<span class="number">20.255</span>  <span class="number">255.255</span>.<span class="number">255.255</span>            在链路上        <span class="number">10.10</span>.<span class="number">20.1</span>    <span class="number">266</span></div><div class="line">   <span class="number">10.255</span>.<span class="number">255.255</span>  <span class="number">255.255</span>.<span class="number">255.255</span>            在链路上        <span class="number">10.10</span>.<span class="number">10.4</span>    <span class="number">266</span></div><div class="line">        <span class="number">127.0</span>.<span class="number">0.0</span>        <span class="number">255.0</span>.<span class="number">0.0</span>            在链路上         <span class="number">127.0</span>.<span class="number">0.1</span>    <span class="number">306</span></div><div class="line">        <span class="number">127.0</span>.<span class="number">0.1</span>  <span class="number">255.255</span>.<span class="number">255.255</span>            在链路上         <span class="number">127.0</span>.<span class="number">0.1</span>    <span class="number">306</span></div><div class="line">  <span class="number">127.255</span>.<span class="number">255.255</span>  <span class="number">255.255</span>.<span class="number">255.255</span>            在链路上         <span class="number">127.0</span>.<span class="number">0.1</span>    <span class="number">306</span></div><div class="line">        <span class="number">224.0</span>.<span class="number">0.0</span>        <span class="number">240.0</span>.<span class="number">0.0</span>            在链路上         <span class="number">127.0</span>.<span class="number">0.1</span>    <span class="number">306</span></div><div class="line">        <span class="number">224.0</span>.<span class="number">0.0</span>        <span class="number">240.0</span>.<span class="number">0.0</span>            在链路上        <span class="number">10.10</span>.<span class="number">20.1</span>    <span class="number">266</span></div><div class="line">        <span class="number">224.0</span>.<span class="number">0.0</span>        <span class="number">240.0</span>.<span class="number">0.0</span>            在链路上        <span class="number">10.10</span>.<span class="number">10.4</span>    <span class="number">266</span></div><div class="line">  <span class="number">255.255</span>.<span class="number">255.255</span>  <span class="number">255.255</span>.<span class="number">255.255</span>            在链路上         <span class="number">127.0</span>.<span class="number">0.1</span>    <span class="number">306</span></div><div class="line">  <span class="number">255.255</span>.<span class="number">255.255</span>  <span class="number">255.255</span>.<span class="number">255.255</span>            在链路上        <span class="number">10.10</span>.<span class="number">20.1</span>    <span class="number">266</span></div><div class="line">  <span class="number">255.255</span>.<span class="number">255.255</span>  <span class="number">255.255</span>.<span class="number">255.255</span>            在链路上        <span class="number">10.10</span>.<span class="number">10.4</span>    <span class="number">266</span></div><div class="line">=========================================================================</div></pre></td></tr></table></figure>
<hr>
<h3 id="8-客户端设置-MacOSX"><a href="#8-客户端设置-MacOSX" class="headerlink" title="8. 客户端设置-MacOSX"></a>8. 客户端设置-MacOSX</h3><h4 id="8-1-系统版本要求"><a href="#8-1-系统版本要求" class="headerlink" title="8.1 系统版本要求"></a>8.1 系统版本要求</h4><p>OS X 10.11 (“El Capitan”)或者更高版本</p>
<h4 id="8-2-证书导入"><a href="#8-2-证书导入" class="headerlink" title="8.2 证书导入"></a>8.2 证书导入</h4><ul>
<li>下载<strong>ca.cert.pem</strong>(自签名CA证书)到本地</li>
</ul>
<ul>
<li>配置位置: <strong>钥匙串访问 -&gt; 钥匙串 -&gt; 系统</strong></li>
<li>选择要添加的证书文件</li>
<li>导入证书</li>
</ul>
<h4 id="8-3-DNS设置"><a href="#8-3-DNS设置" class="headerlink" title="8.3 DNS设置"></a>8.3 DNS设置</h4><p>在<code>/etc/hosts</code>中添加如下解析条目</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">10.10.20.3 test.icean.cc</div></pre></td></tr></table></figure>
<p>在正式生产环境中，需要在DNS服务器具体设置</p>
<h4 id="8-4-VPN设置"><a href="#8-4-VPN设置" class="headerlink" title="8.4 VPN设置"></a>8.4 VPN设置</h4><ul>
<li>配置位置: <strong>系统偏好设置 -&gt; 网络 -&gt;添加网络连接</strong></li>
<li>接口: VPN</li>
<li>VPN类型: IKEv2</li>
<li>服务名称: 任意</li>
<li>服务器: test.icean.cc</li>
<li>远程ID: test.icean.cc</li>
<li>本地ID: 留空</li>
<li>鉴定设置 -&gt; 用户名: test</li>
<li>鉴定设置 -&gt; 密码: test</li>
</ul>
<h4 id="8-5-连接测试"><a href="#8-5-连接测试" class="headerlink" title="8.5 连接测试"></a>8.5 连接测试</h4><p>VPN连接成功后，路由表如下</p>
<hr>
<h3 id="9-实验脚本"><a href="#9-实验脚本" class="headerlink" title="9. 实验脚本"></a>9. 实验脚本</h3><h4 id="9-1-证书相关脚本"><a href="#9-1-证书相关脚本" class="headerlink" title="9.1 证书相关脚本"></a>9.1 证书相关脚本</h4><p>删除所有证书</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#!/bin/bash</span></div><div class="line">rm -rf /usr/<span class="built_in">local</span>/etc/ipsec.d/cacert/*</div><div class="line">rm -rf /usr/<span class="built_in">local</span>/etc/ipsec.d/private/*</div><div class="line">rm -rf /usr/<span class="built_in">local</span>/etc/ipsec.d/cert/*</div></pre></td></tr></table></figure>
<p>生成并安装证书</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#!/bin/bash</span></div><div class="line">C=<span class="string">"CN"</span></div><div class="line">O=<span class="string">"ACS"</span></div><div class="line">CN=<span class="string">"ACS CA"</span></div><div class="line"></div><div class="line"><span class="comment">#自签名CA生成</span></div><div class="line">ipsec pki --gen --outform pem &gt; ca.key.pem</div><div class="line">ipsec pki --self --in ca.key.pem --dn <span class="string">"C=<span class="variable">$C</span>, O=<span class="variable">$O</span>, CN=<span class="variable">$CN</span>"</span> --ca --lifetime 3650 --outform pem &gt; ca.cert.pem</div><div class="line">cp ca.key.pem /usr/<span class="built_in">local</span>/etc/ipsec.d/private/</div><div class="line">cp ca.cert.pem /usr/<span class="built_in">local</span>/etc/ipsec.d/cacerts/</div><div class="line"></div><div class="line">C=<span class="string">"CN"</span></div><div class="line">O=<span class="string">"ACS"</span></div><div class="line">URL=<span class="string">"test2.icean.cc"</span></div><div class="line">san=<span class="string">"test2.icean.cc"</span></div><div class="line"></div><div class="line"><span class="comment">#服务器证书生成</span></div><div class="line">ipsec pki --gen --outform pem &gt; server.key.pem</div><div class="line">ipsec pki --pub --in server.key.pem --outform pem &gt; server.pub.pem</div><div class="line">ipsec pki --issue --lifetime 1200 --cacert ca.cert.pem --cakey ca.key.pem --in server.pub.pem --dn <span class="string">"C=<span class="variable">$C</span>, O=<span class="variable">$O</span>, CN=<span class="variable">$URL</span>"</span> --san=<span class="string">"<span class="variable">$san</span>"</span> --flag serverAuth --flag ikeIntermediate --outform pem &gt; server.cert.pem</div><div class="line"></div><div class="line">cp server.key.pem /usr/<span class="built_in">local</span>/etc/ipsec.d/private/</div><div class="line">cp server.cert.pem /usr/<span class="built_in">local</span>/etc/ipsec.d/certs/</div></pre></td></tr></table></figure>
<h4 id="9-2-配置文件"><a href="#9-2-配置文件" class="headerlink" title="9.2 配置文件"></a>9.2 配置文件</h4><p>ipsec.conf配置文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/etc</div><div class="line">mv ipsec.conf ipsec.conf.bak</div><div class="line">cat &lt;&lt;EOF &gt;&gt; ipsec.conf</div><div class="line">config setup</div><div class="line">    uniqueids=yes</div><div class="line"></div><div class="line">conn %default</div><div class="line">    compress = yes</div><div class="line">    keyingtries = 1</div><div class="line">    keyexchange = ike</div><div class="line"></div><div class="line">conn IKE-BASE</div><div class="line">    leftca = ca.cert.pem</div><div class="line">    leftcert = server.cert.pem</div><div class="line">    left = %any</div><div class="line">    leftsubnet = 10.10.10.0/24</div><div class="line">    right = %any</div><div class="line">    <span class="comment">#rightsourceip = 192.168.80.0/24</span></div><div class="line">    rightsourceip = %dhcp</div><div class="line"> </div><div class="line">conn IKEv2-LAW</div><div class="line">    also = IKE-BASE</div><div class="line">    keyexchange = ikev2</div><div class="line">    keyingtries = 1 </div><div class="line">    ike = aes256-sha1-modp1024</div><div class="line">    esp = aes256-sha1</div><div class="line">    leftauth = pubkey</div><div class="line">    leftsendcert = always</div><div class="line">    rightauth = eap-radius</div><div class="line">    rekey = no</div><div class="line">    eap_identity = %identity</div><div class="line">    auto = add </div><div class="line"></div><div class="line">conn IKEv2-Apple</div><div class="line">    also = IKE-BASE</div><div class="line">    keyexchange = ikev2</div><div class="line">    keyingtries = 1 </div><div class="line">    ike = aes256-sha256-modp1024</div><div class="line">    esp = aes256-sha256</div><div class="line">    leftid =  test.icean.cc</div><div class="line">    leftauth = pubkey</div><div class="line">    leftsendcert = always</div><div class="line">    rightauth = eap-radius</div><div class="line">    rightsendcert = never</div><div class="line">    fragmentation = yes </div><div class="line">    rekey = yes</div><div class="line">    eap_identity = %identity</div><div class="line">    auto = add </div><div class="line">EOF</div></pre></td></tr></table></figure>
<p>ipsec.secrets配置文件，因为保密需要，该文件属组和其他没有读和执行权限</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/etc</div><div class="line">cat &lt;&lt;EOF &gt; ipsec.secrets</div><div class="line">: RSA server.key.pem</div><div class="line">EOF</div></pre></td></tr></table></figure>
<p>strongswan.conf配置文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/etc</div><div class="line">mv strongswan.conf strongswan.conf.bak</div><div class="line">cat &lt;&lt;EOF &gt;&gt; strongswan.conf</div><div class="line">charon &#123;</div><div class="line">       dns1 = 8.8.8.8    </div><div class="line"> </div><div class="line">       filelog &#123;</div><div class="line">               /var/<span class="built_in">log</span>/strongswan.charon.log &#123;</div><div class="line">                   time_format = %b %e %T</div><div class="line">                   default = 0</div><div class="line">                   append = no</div><div class="line">                   flush_line = yes</div><div class="line">                                              &#125;</div><div class="line">              &#125;</div><div class="line">       plugins &#123;</div><div class="line">         eap-radius &#123;</div><div class="line">               accounting = yes</div><div class="line">               servers &#123;</div><div class="line">                  radiusServer &#123;</div><div class="line">                       secret = testing1234</div><div class="line">                       address = radius</div><div class="line">                       auth_port = 1812</div><div class="line">                       acct_port = 1813</div><div class="line">                               &#125;</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">include strongswan.d/*.conf</div><div class="line">EOF</div></pre></td></tr></table></figure>
<h4 id="9-3-系统设置"><a href="#9-3-系统设置" class="headerlink" title="9.3 系统设置"></a>9.3 系统设置</h4><p>iptables设置</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">iptables -I INPUT 1 -p udp -m udp --dport 4500 -j ACCEPT</div><div class="line">iptables -I INPUT 1 -p udp -m udp --dport 500 -j ACCEPT</div><div class="line">iptables -I  FORWARD 1 -j ACCEPT</div><div class="line">iptables -t nat -I POSTROUTING 1 <span class="_">-s</span> 192.168.80.0/24 -o enp0s8 -j MASQUERADE</div><div class="line">iptables-save &gt;/etc/sysconfig/iptables</div><div class="line">service iptables restart</div></pre></td></tr></table></figure>
<p>sysctl设置</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">cat &lt;&lt;EOF&gt;&gt;/etc/sysctl.conf  </div><div class="line">net.ipv4.ip_forward = 1</div><div class="line">net.ipv6.conf.all.forwarding=1 </div><div class="line">EOF</div><div class="line">sysctl -p</div></pre></td></tr></table></figure>

        
      
    </div>

    
  </article>

    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2017/01/26/CentOS 6.x7.x Strongswan 5.5.1编译安装+Freeradius验证/">CentOS 6.x/7.x Strongswan 5.5.0编译安装 + Freeradius验证</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2017年1月26日
        </span>
      </div>
    </header>

    

    <div class="post-content">
      
        

        
          <h3 id="1-编译安装Strongswan"><a href="#1-编译安装Strongswan" class="headerlink" title="1. 编译安装Strongswan"></a>1. 编译安装Strongswan</h3><h4 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h4><p>需要安装如下依赖<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">yum -y install pam-devel</div></pre></td></tr></table></figure></p>
<p>可能还需要安装如下依赖</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">yum install -y openssl-devel make gcc curl wget</div></pre></td></tr></table></figure>
<h4 id="下载源码"><a href="#下载源码" class="headerlink" title="下载源码"></a>下载源码</h4><p>从<a href="https://www.strongswan.org/" target="_blank" rel="external">Strongswan</a>官网下载最新Strongswan 5.5.1源码到并解压</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">wget https://download.strongswan.org/strongswan-5.5.1.tar.gz</div><div class="line">tar xvf strongswan-5.5.1.tar.gz</div></pre></td></tr></table></figure>
<h4 id="编译安装"><a href="#编译安装" class="headerlink" title="编译安装"></a>编译安装</h4><p>切换到Strongswan源码解压的目录，执行配置与编译安装<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">cd</span> strongswan-5.5.1</div><div class="line">./configure  --enable-eap-identity --enable-eap-md5 --enable-eap-mschapv2 --enable-eap-tls \</div><div class="line">--enable-eap-ttls --enable-eap-peap --enable-eap-tnc --enable-eap-dynamic --enable-eap-radius \</div><div class="line">--enable-xauth-eap --enable-xauth-pam  --enable-dhcp  --enable-openssl  --enable-addrblock --enable-unity  \</div><div class="line">--enable-certexpire --enable-radattr --enable-swanctl --enable-openssl --disable-gmp --enable-farp \</div><div class="line">--enable-kernel-libipsec  <span class="comment">#如果主机为OpenVZ则需要添加这个模块</span></div><div class="line">make &amp;&amp; make install</div></pre></td></tr></table></figure></p>
<p>根据主机性能，完成上述编译安装需要的时间不同。安装完成后，可执行文件的路径为/usr/local/sbin, 配置文件路径为/usr/local/etc，配置文件以及文件夹主要如下</p>
<ul>
<li>ipsec.conf              </li>
<li>ipsec.secrets</li>
<li><strong>ipsec.d</strong></li>
<li>strongswan.conf</li>
<li><strong>strongswan.d</strong></li>
<li><strong>swanctl</strong></li>
</ul>
<hr>
<h3 id="2-证书配置"><a href="#2-证书配置" class="headerlink" title="2. 证书配置"></a>2. 证书配置</h3><h4 id="Let’s-Encrypt免费服务器证书"><a href="#Let’s-Encrypt免费服务器证书" class="headerlink" title="Let’s Encrypt免费服务器证书"></a>Let’s Encrypt免费服务器证书</h4><p>Let’s Encrypt是免费、自动化、开放的证书签发服务。它由 ISRG（Internet Security Research Group，互联网安全研究小组）提供服务，而 ISRG 是来自于美国加利福尼亚州的一个公益组织。Let’s Encrypt 得到了 Mozilla、Cisco、Akamai、Electronic Frontier Foundation 和 Chrome 等众多公司和机构的支持。申请 Let’s Encrypt 证书免费，每次只有 90 天的有效期，但可以通过脚本定期更新。</p>
<h5 id="生成证书"><a href="#生成证书" class="headerlink" title="生成证书"></a>生成证书</h5><p>下载Let’s Encrypt并执行生成证书。在执行过程中，会下载一些依赖，同时在提示输入域名的时候，要和主机的域名一致。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">git <span class="built_in">clone</span> https://github.com/letsencrypt/letsencrypt</div><div class="line"><span class="built_in">cd</span> letsencrypt</div><div class="line">./letsencrypt-auto certonly --standalone</div></pre></td></tr></table></figure></p>
<h5 id="安装证书"><a href="#安装证书" class="headerlink" title="安装证书"></a>安装证书</h5><p>生成的证书和证书私钥位于 <code>/etc/letsencrypt/live/your.domain/</code> 目录下，如下所示，所有文件均是软链接，其原始文件后的数字为证书生成的次数，首次生成为1，每续期一次，数字加一，下面的为续期了两次的证书。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">lrwxrwxrwx 1 root root 36 Dec  3 09:30 cert.pem -&gt; ../../archive/[域名]/cert3.pem</div><div class="line">lrwxrwxrwx 1 root root 37 Dec  3 09:30 chain.pem -&gt; ../../archive/[域名]/chain3.pem</div><div class="line">lrwxrwxrwx 1 root root 41 Dec  3 09:30 fullchain.pem -&gt; ../../archive/[域名]/fullchain3.pem</div><div class="line">lrwxrwxrwx 1 root root 39 Dec  3 09:30 privkey.pem -&gt; ../../archive/[域名]/privkey3.pem</div></pre></td></tr></table></figure>
<p>建立软链到 strongSwan 配置目录下，这样是为了方便证书续期也不用修改配置文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">ln <span class="_">-s</span> /etc/letsencrypt/live/your.domain/fullchain.pem /etc/ipsec.d/certs/server.cert.pem</div><div class="line">ln <span class="_">-s</span> /etc/letsencrypt/live/your.domain/privkey.pem /etc/ipsec.d/private/server.key.pem</div></pre></td></tr></table></figure>
<h5 id="证书自动续期"><a href="#证书自动续期" class="headerlink" title="证书自动续期"></a>证书自动续期</h5><p>letsencrypt证书需要每三个月进行续期一次证书，续期命令如下，每隔两个月的4号进行一次证书续期</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">crontab <span class="_">-e</span></div><div class="line"> * * 4 */2 * /root/letsencrypt/letsencrypt-auto  --renew-by-default  certonly --standalone <span class="_">-d</span> [域名] --email [邮箱]  --agree-tos</div></pre></td></tr></table></figure>
<h4 id="自签名CA颁发服务器证书"><a href="#自签名CA颁发服务器证书" class="headerlink" title="自签名CA颁发服务器证书"></a>自签名CA颁发服务器证书</h4><h5 id="CA证书"><a href="#CA证书" class="headerlink" title="CA证书"></a>CA证书</h5><p>生成一个CA私钥</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ipsec pki --gen --outform pem &gt; ca.key.pem</div></pre></td></tr></table></figure>
<p>基于私钥生成一个CA证书<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ipsec pki --self --in ca.key.pem --dn <span class="string">"C=CN, O=Strongswan, CN=Strongswan CA"</span> --ca --lifetime 3650 --outform pem &gt; ca.cert.pem</div></pre></td></tr></table></figure></p>
<ul>
<li>–self 表示自签证书</li>
<li>–in 是输入的私钥</li>
<li>–dn 是判别名</li>
<li>C 表示国家名，同样还有 ST 州/省名，L 地区名，STREET（全大写） 街道名</li>
<li>O 组织名称</li>
<li>CN 友好显示的通用名</li>
<li>–ca 表示生成 CA 根证书</li>
<li>–lifetime 为有效期, 单位是天</li>
</ul>
<h5 id="服务器证书"><a href="#服务器证书" class="headerlink" title="服务器证书"></a>服务器证书</h5><p>生成服务器证书的私钥<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ipsec pki --gen --outform pem &gt; server.key.pem</div></pre></td></tr></table></figure></p>
<p>用自签的 CA 证书签发一个服务器证书<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">ipsec pki --pub --in server.key.pem --outform pem &gt; server.pub.pem</div><div class="line">ipsec pki --issue --lifetime 1200 --cacert ca.cert.pem --cakey ca.key.pem --in server.pub.pem \</div><div class="line">--dn <span class="string">"C=CN, O=Strongswan, CN=vpn.strongswan.org"</span> --san=<span class="string">"vpn.strongswan.org"</span> --flag serverAuth \</div><div class="line">--flag ikeIntermediate --outform pem &gt; server.cert.pem</div></pre></td></tr></table></figure></p>
<p>–issue, –cacert 和–cakey 就是表明要用刚才自签的 CA 证书来签这个服务器证书，–dn, –san，–flag 是一些客户端方面的特殊要求：</p>
<ul>
<li>iOS 客户端要求 CN 也就是通用名必须是服务器的 URL 或 IP 地址;</li>
<li>Windows 7 或者更高版本不但要求了上面，还要求必须显式说明这个服务器证书的用途（用于与服务器进行认证），–flag serverAuth;</li>
<li>非 iOS 的 Mac OS X 要求了“IP 安全网络密钥互换居间（IP Security IKE Intermediate）”这种增强型密钥用法（EKU），–flag ikdeIntermediate;</li>
<li>Android 和 iOS 都要求服务器别名（serverAltName）就是服务器的 URL 或 IP 地址，即是–san，同时Windows 7不能添加额外的服务器别名，Windows 10可以添加</li>
</ul>
<p><span style="color:red"><strong>*</strong></span>为了兼容Windows 7，只添加一个服务器别名（serverAltName）</p>
<h5 id="客户端证书（可选）"><a href="#客户端证书（可选）" class="headerlink" title="客户端证书（可选）"></a>客户端证书（可选）</h5><p>生成客户端私钥<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ipsec pki --gen --outform pem &gt; client.key.pem</div></pre></td></tr></table></figure></p>
<p>用自签的CA证书来签发客户端证书<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">ipsec pki --pub --in client.key.pem --outform pem &gt; client.pub.pem</div><div class="line">ipsec pki --issue --lifetime 1200 --cacert ca.cert.pem --cakey ca.key.pem --in client.pub.pem \</div><div class="line">--dn <span class="string">"C=CN, O=Strongswan, CN=vpn.strongswan.org"</span> --outform pem &gt; client.cert.pem</div></pre></td></tr></table></figure></p>
<p>打包证书为 p12，生成 p12 证书可以设置密码，<span style="color:red"><strong>*</strong></span>OS X 无法导入密码为空的 p12 证书<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">openssl pkcs12 -export -inkey client.key.pem -in client.cert.pem -name <span class="string">"Strongswan Client Cert"</span> \</div><div class="line">-certfile ca.cert.pem -caname <span class="string">"Strongswan CA"</span> -out client.cert.p12</div></pre></td></tr></table></figure></p>
<h5 id="安装证书-1"><a href="#安装证书-1" class="headerlink" title="安装证书"></a>安装证书</h5><p>复制证书到指定的路径<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">cp ca.key.pem /usr/<span class="built_in">local</span>/etc/ipsec.d/private/</div><div class="line">cp client.key.pem /usr/<span class="built_in">local</span>/etc/ipsec.d/private/</div><div class="line">cp server.key.pem /usr/<span class="built_in">local</span>/etc/ipsec.d/private/</div><div class="line">cp server.cert.pem /usr/<span class="built_in">local</span>/etc/ipsec.d/certs/</div><div class="line">cp client.cert.pem /usr/<span class="built_in">local</span>/etc/ipsec.d/certs/</div><div class="line">cp ca.cert.pem /usr/<span class="built_in">local</span>/etc/ipsec.d/cacerts/</div></pre></td></tr></table></figure></p>
<hr>
<h3 id="3-Strongswan配置"><a href="#3-Strongswan配置" class="headerlink" title="3. Strongswan配置"></a>3. Strongswan配置</h3><h4 id="ipsec-conf配置"><a href="#ipsec-conf配置" class="headerlink" title="ipsec.conf配置"></a>ipsec.conf配置</h4><p>支持IPsec和ikev2的配置如下所示， 常用设置如下<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">cachecrls = yes					<span class="comment">#是否缓存证书吊销列表</span></div><div class="line">strictcrlpolicy=yes				    <span class="comment">#是否严格执行证书吊销规则</span></div><div class="line">uniqueids=no				    <span class="comment">#如果同一个用户在不同的设备上重复登录,yes 断开旧连接,创建新连接;no 保持旧</span></div><div class="line">  							   <span class="comment">#连接,并发送通知; never 同 no, 但不发送通知.</span></div><div class="line">ca %default					     <span class="comment">#配置根证书, 如果不使用证书吊销列表, 可以不用这段. 命名为 %default 所有配置</span></div><div class="line">  							   <span class="comment">#节都会继承它</span></div><div class="line">crl =						    <span class="comment">#证书吊销列表URL,可以是 LDAP, http, 或文件路径</span></div><div class="line">conn %default				     <span class="comment">#定义连接项, 命名为 %default 所有连接都会继承它</span></div><div class="line">compress = yes				     <span class="comment">#是否启用压缩, yes 表示如果支持压缩会启用.</span></div><div class="line">dpdaction = hold			       <span class="comment">#当意外断开后尝试的操作, hold, 保持并重连直到超时.</span></div><div class="line">dpddelay = 30s				      <span class="comment">#意外断开后尝试重连时长</span></div><div class="line">dpdtimeout = 60s			      <span class="comment">#意外断开后超时时长, 只对 IKEv1 起作用</span></div><div class="line">inactivity = 300s				   <span class="comment">#闲置时长,超过后断开连接.</span></div><div class="line">esp = aes256-sha256,aes256-sha1,3des-sha1!	</div><div class="line">  							   <span class="comment">#数据传输协议加密算法列表</span></div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">ike = aes256-sha1-modp1024,aes128-sha1-modp1024,3des-sha1-modp1024!</div><div class="line">  							   <span class="comment">#密钥交换协议加密算法列表</span></div><div class="line">							 <span class="comment">#iOS支持的IKE加密方式为aes256-sha256-modp1024</span></div><div class="line">  							   <span class="comment">#OS X为3des-sha1-modp1024</span></div><div class="line">  							   <span class="comment">#Win7为aes256-sha1-modp1024，</span></div><div class="line">keyexchange = ike			       <span class="comment">#默认的密钥交换算法, ike 为自动, 优先使用 IKEv2</span></div><div class="line">left = %any					      <span class="comment">#服务端公网IP, 可以是魔术字 %any，表示从本地IP地址表中取.</span></div><div class="line">right = %any				      <span class="comment">#客户端IP, 同上</span></div><div class="line">leftdns = 8.8.8.8,8.8.4.4			<span class="comment">#指定服务端与客户端的dns, 多个用","分隔</span></div><div class="line">rightdns = 8.8.8.8,8.8.4.4			<span class="comment">#指定服务端与客户端的dns, 多个用","分隔</span></div><div class="line">leftikeport = &lt;port&gt;			  <span class="comment">#服务端用于ike认证时使用的端口, 默认为500,如果使用了nat 转发, 则使用4500</span></div><div class="line">leftsourceip = %config			   <span class="comment">#服务器端虚拟IP地址</span></div><div class="line">rightsourceip = 10.0.0.0/24		       <span class="comment">#客户端虚拟IP段</span></div><div class="line">leftsubnet = 0.0.0.0/0		              <span class="comment">#服务器端子网, 魔术字 0.0.0.0/0. 如果为客户端分配虚拟 IP 地址的话，那表示之</span></div><div class="line">  							    <span class="comment">#后要做 iptables 转发，那么服务器端就必须是用魔术字</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">leftca = ca.cert.pem 			    <span class="comment">#服务器端根证书</span></div><div class="line">leftcert = server.cert.pem		       <span class="comment">#服务器证书, 可以是 PEM 或 DER 格式</span></div><div class="line">rightcert = &lt;path&gt;				<span class="comment">#不指定客户端证书路径</span></div><div class="line">leftsigkey = server.pub.pem		     <span class="comment">#指定服务器证书的公钥</span></div><div class="line">leftsendcert = always			   <span class="comment">#是否发送服务器证书到客户端</span></div><div class="line">rightsendcert = never			  <span class="comment">#客户端不发送证书</span></div><div class="line">leftauth = pubkey	                         <span class="comment">#服务端认证方法,使用证书</span></div><div class="line">rightauth = eap-mschapv2	         <span class="comment">#客户端认证使用 EAP 扩展认证 , 貌似 eap-mschapv2 比较通用</span></div><div class="line">leftid = vpn.strongswan.com	            <span class="comment">#服务端id, 可以任意指定, 默认为服务器证书的 subject, 还可以是魔术字 %any，</span></div><div class="line">  							  <span class="comment">#表示什么都行.</span></div><div class="line">rightid = %any				      <span class="comment">#客户端id, 任意</span></div><div class="line">eap_identity = %any		                <span class="comment">#指定客户端eap id</span></div><div class="line">rekey = no					    <span class="comment">#不自动重置密钥</span></div><div class="line">fragmentation = yes		        	<span class="comment">#开启IKE 消息分片</span></div><div class="line">auto = add					   <span class="comment">#当服务启动时, 应该如何处理这个连接项. add 添加到连接表中.</span></div></pre></td></tr></table></figure>
<p>本文使用的配置<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">config setup</div><div class="line">    uniqueids = no</div><div class="line">    </div><div class="line">conn %default</div><div class="line">    compress = yes</div><div class="line">    keyingtries = 1</div><div class="line">    keyexchange = ike</div></pre></td></tr></table></figure></p>
<p>IKE基础配置</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">conn IKE-BASE</div><div class="line">    <span class="comment">#leftca = ca.cert.pem                      #使用Let's Encript免费证书的时候注释这句</span></div><div class="line">    leftcert = server.cert.pem                   </div><div class="line">    left = %defaultroute                        <span class="comment">#可以将所有流量都发送到VPN网关</span></div><div class="line">    leftsubnet = 0.0.0.0/0</div><div class="line">    right = %any</div><div class="line">    rightsourceip = 192.168.90.0/24   <span class="comment">#客户端接入分配的私有IP地址空间</span></div></pre></td></tr></table></figure>
<p>IKEv1配置<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">conn IPSec-IKEv1-PSK</div><div class="line">    also = IKE-BASE</div><div class="line">    keyexchange = ikev1</div><div class="line">    fragmentation = yes</div><div class="line">    leftauth = psk</div><div class="line">    rightauth = psk</div><div class="line">    rightauth2 = xauth-radius</div><div class="line">    auto = add</div><div class="line">    </div><div class="line">conn IPSec-IKEv1</div><div class="line">    also = IKE-BASE</div><div class="line">    keyexchange = ikev1</div><div class="line">    fragmentation = yes</div><div class="line">    leftauth = pubkey</div><div class="line">    rightauth = pubkey</div><div class="line">    rightcert = client.cert.pem</div><div class="line">    auto = add</div></pre></td></tr></table></figure></p>
<p>IKEv2面向Linux、Android、Windows配置<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">conn IKEv2-LAW</div><div class="line">    also = IKE-BASE</div><div class="line">    keyexchange = ikev2</div><div class="line">    keyingtries = 1 </div><div class="line">    ike = aes256-sha1-modp1024</div><div class="line">    esp = aes256-sha1</div><div class="line">    leftauth = pubkey</div><div class="line">    leftsendcert = always</div><div class="line">    rightauth = eap-radius</div><div class="line">    rekey = no</div><div class="line">    eap_identity = %identity</div><div class="line">    auto = add</div></pre></td></tr></table></figure></p>
<p>IKEv2面向iOS、MAC OS X配置，<span style="color:red">*</span><code>leftid</code>需要和服务器URL或者IP地址一致，否则无法登录。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">conn IKEv2-Apple</div><div class="line">    also = IKE-BASE</div><div class="line">    keyexchange = ikev2</div><div class="line">    keyingtries = 1 </div><div class="line">    ike = aes256-sha256-modp1024</div><div class="line">    esp = aes256-sha256</div><div class="line">    leftid =  vpn.strongswan.com </div><div class="line">    leftauth = pubkey</div><div class="line">    leftsendcert = always</div><div class="line">    rightauth = eap-radius</div><div class="line">    rightsendcert = never</div><div class="line">    fragmentation = yes </div><div class="line">    rekey = yes</div><div class="line">    eap_identity = %identity</div><div class="line">    auto = add</div></pre></td></tr></table></figure></p>
<h4 id="日志配置"><a href="#日志配置" class="headerlink" title="日志配置"></a>日志配置</h4><p>修改/usr/local/etc/strongswan.conf，修改为如下，其中filelog选项可以调节等级</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">charon &#123;</div><div class="line">    load_modular = yes </div><div class="line">    filelog &#123;</div><div class="line">        /var/<span class="built_in">log</span>/charon.log &#123;</div><div class="line">            time_format = %b %e %T</div><div class="line">            ike_name = yes </div><div class="line">            append = no</div><div class="line">            default = 2 </div><div class="line">            flush_line = yes </div><div class="line">        &#125;   </div><div class="line">        stderr &#123;</div><div class="line">            ike = 2 </div><div class="line">            knl = 3 </div><div class="line">        &#125;                                                                                                                                                            </div><div class="line">    &#125;   </div><div class="line">    syslog &#123;</div><div class="line">        identifier = charon-custom</div><div class="line">        daemon &#123;</div><div class="line">        &#125;   </div><div class="line">        auth &#123;</div><div class="line">            default = -1</div><div class="line">            ike = 0 </div><div class="line">        &#125;   </div><div class="line">    &#125;                                                                                                                                                </div><div class="line">    plugins &#123;</div><div class="line">        include strongswan.d/charon/*.conf</div><div class="line">    &#125;   </div><div class="line">&#125;</div><div class="line">include strongswan.d/*.conf</div></pre></td></tr></table></figure>
<h4 id="ipsec-secrets设置"><a href="#ipsec-secrets设置" class="headerlink" title="ipsec.secrets设置"></a>ipsec.secrets设置</h4><p>配置验证方式的用户名与密码，<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">: RSA server.key.pem 		<span class="comment">#使用证书验证时的服务器端私钥</span></div><div class="line">: PSK <span class="string">"pskkey"</span>                           <span class="comment">#使用预设加密密钥, 越长越好</span></div><div class="line">: XAUTH <span class="string">"pskkey"</span>		     <span class="comment">#使用XAUTH预设加密密钥, 越长越好</span></div><div class="line"><span class="built_in">test</span> : EAP <span class="string">"test"</span>		          <span class="comment">#验证的账户和密码，如果配置了RADIUS ，账户密码无法进行有效验证</span></div><div class="line"><span class="built_in">test</span>2 : XAUTH <span class="string">"test2"</span></div></pre></td></tr></table></figure></p>
<p><span style="color:red"><strong>*</strong></span>PSK和XAUTH可以设置一样，这样可以避免已配置的麻烦，同时共享密钥中不能有符号等，否则登录不成功。</p>
<h4 id="DNS设置"><a href="#DNS设置" class="headerlink" title="DNS设置"></a>DNS设置</h4><p>修改/usr/local/etc/strongswan.d/charon.conf，添加DNS服务器，修改其中的dns1=8.8.8.8。</p>
<h4 id="Freeradius-服务器设置"><a href="#Freeradius-服务器设置" class="headerlink" title="Freeradius 服务器设置"></a>Freeradius 服务器设置</h4><p>修改/usr/local/etc/strongswan.d/charon/eap-radius .conf，设置accounting改为yes，并添加servers中添加Freeradius 服务器。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">accounting = yes</div><div class="line">servers &#123;</div><div class="line">  RadiusServer &#123;</div><div class="line">       secret = testing1234        <span class="comment">#与Freeradius 服务器的暗码</span></div><div class="line">       address = 1.2.3.4              <span class="comment">#Freeradius 服务器IP地址</span></div><div class="line">       auth_port = 1812             <span class="comment">#验证端口</span></div><div class="line">       acct_port = 1813              <span class="comment">#记账端口</span></div><div class="line">               &#125;</div><div class="line">       &#125;</div></pre></td></tr></table></figure></p>
<h4 id="iptables设置"><a href="#iptables设置" class="headerlink" title="iptables设置"></a>iptables设置</h4><p>转发/usr/local/etc/ipsec.conf中设置的虚拟IP地址段，其中x.x.x.x为主机的公网IP地址<br>OpenVZ如下<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">iptables -t nat -A POSTROUTING <span class="_">-s</span> 192.168.90.0/24 -o venet0 -j SNAT --to-source x.x.x.x</div><div class="line">iptables -I FORWARD 4 <span class="_">-s</span> 192.168.90.0/24 -j ACCEPT</div></pre></td></tr></table></figure></p>
<p>KVM如下，eth0为公网IP所在的网卡。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">iptables -t nat -A POSTROUTING <span class="_">-s</span> 192.168.90.0/24 -o eth0 -j MASQUERADE</div></pre></td></tr></table></figure></p>
<p>开放UDP的500和4500端口，删除转发表所有拒绝的条目，保存并重启iptables服务<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">iptables -A INPUT -p udp -m udp --dport 4500 -j ACCEPT</div><div class="line">iptables -A INPUT -p udp -m udp --dport 500 -j ACCEPT  </div><div class="line">iptables -D FORWARD 1</div><div class="line">service iptables save</div><div class="line">service iptables restart</div></pre></td></tr></table></figure></p>
<hr>
<h3 id="4-服务启动"><a href="#4-服务启动" class="headerlink" title="4. 服务启动"></a>4. 服务启动</h3><p>启动Strongswan服务<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/usr/<span class="built_in">local</span>/ipsec start</div></pre></td></tr></table></figure></p>
<hr>
<h3 id="5-IKEv2-VPN配置"><a href="#5-IKEv2-VPN配置" class="headerlink" title="5. IKEv2 VPN配置"></a>5. IKEv2 VPN配置</h3><h4 id="iOS"><a href="#iOS" class="headerlink" title="iOS"></a>iOS</h4><h5 id="系统版本要求"><a href="#系统版本要求" class="headerlink" title="系统版本要求"></a>系统版本要求</h5><p><span style="color:red">iOS 9</span>或者更高版本</p>
<h5 id="证书导入"><a href="#证书导入" class="headerlink" title="证书导入"></a>证书导入</h5><ul>
<li>通过<strong>邮件</strong>发送或者<strong>Safari浏览器</strong><a href="https://letsencrypt.org/certs/lets-encrypt-x3-cross-signed.pem" target="_blank" rel="external">下载</a>CA证书到iOS设备</li>
<li>安装证书到设备</li>
<li>输入iOS密码</li>
</ul>
<h5 id="VPN设置"><a href="#VPN设置" class="headerlink" title="VPN设置"></a>VPN设置</h5><ul>
<li>配置位置: <strong>设置 -&gt; VPN -&gt; 添加配置</strong></li>
<li>类型: IKEv2</li>
<li>描述: 任意</li>
<li>用户鉴定: 用户名</li>
<li>服务器: VPN服务器URL或者IP地址</li>
<li>用户名: Freeradius服务器配置</li>
<li>密码: Freeradius服务器配置</li>
<li>远程ID: VPN远程ID</li>
<li>本地ID: 留空</li>
</ul>
<h4 id="OS-X"><a href="#OS-X" class="headerlink" title="OS X"></a>OS X</h4><h5 id="系统版本要求-1"><a href="#系统版本要求-1" class="headerlink" title="系统版本要求"></a>系统版本要求</h5><p><span style="color:red">OS X 10.11 (“El Capitan”)</span>或者更高版本</p>
<h5 id="证书导入-1"><a href="#证书导入-1" class="headerlink" title="证书导入"></a>证书导入</h5><ul>
<li>下载CA证书到本地</li>
<li>配置位置: <strong>钥匙串访问 -&gt; 钥匙串 -&gt; 系统</strong></li>
<li>选择要添加的证书文件</li>
<li>导入证书</li>
</ul>
<h5 id="VPN设置-1"><a href="#VPN设置-1" class="headerlink" title="VPN设置"></a>VPN设置</h5><ul>
<li>配置位置: <strong>系统偏好设置 -&gt; 网络 -&gt;添加网络连接</strong></li>
<li>接口: VPN</li>
<li>VPN类型: IKEv2</li>
<li>服务名称: 任意</li>
<li>服务器: VPN服务器URL或者IP地址</li>
<li>远程ID: VPN远程ID</li>
<li>本地ID: 留空</li>
<li>鉴定设置 -&gt; 用户名: Freeradius服务器配置</li>
<li>鉴定设置 -&gt; 密码: Freeradius服务器配置</li>
</ul>
<h4 id="Android"><a href="#Android" class="headerlink" title="Android"></a>Android</h4><h5 id="系统版本要求-2"><a href="#系统版本要求-2" class="headerlink" title="系统版本要求"></a>系统版本要求</h5><p><span style="color:red">Android 4</span>或者更高版本，需要安装<a href="http://pan.baidu.com/s/1gfkEXKB" target="_blank" rel="external">Strongswan客户端</a></p>
<h5 id="证书导入-2"><a href="#证书导入-2" class="headerlink" title="证书导入"></a>证书导入</h5><ul>
<li>下载CA证书到本地</li>
<li>配置位置：<strong>CA certificates -&gt; Import certificates</strong></li>
<li>从文件系统选择证书文件</li>
<li>确认导入证书</li>
</ul>
<h5 id="VPN设置-2"><a href="#VPN设置-2" class="headerlink" title="VPN设置"></a>VPN设置</h5><ul>
<li>配置位置：<strong>ADD VPN PROFILE</strong></li>
<li>服务器: VPN服务器URL或者IP地址</li>
<li>VPN类型: IKEv2 EAP</li>
<li>用户名: Freeradius服务器配置</li>
<li>密码: Freeradius服务器配置</li>
</ul>
<h4 id="Windows"><a href="#Windows" class="headerlink" title="Windows"></a>Windows</h4><h5 id="系统版本要求-3"><a href="#系统版本要求-3" class="headerlink" title="系统版本要求"></a>系统版本要求</h5><p><span style="color:red">Win 7</span>或者更高版本</p>
<h5 id="证书导入-3"><a href="#证书导入-3" class="headerlink" title="证书导入"></a>证书导入</h5><p>windows使用IKEv2 VPN需要导入服务器证书到<strong>信任根证书颁发机构。如果服务器使用的是</strong>自签名CA<strong>颁发的证书，需要导入的CA证书为之前创建的ca.cert.pem。若使用</strong>Let’s Encript**证书，需要导入需要在客户端中导入<a href="https://letsencrypt.org/certs/lets-encrypt-x3-cross-signed.pem" target="_blank" rel="external">Let’s Encrypt Authority X3</a>证书。</p>
<ul>
<li>下载CA证书到本地</li>
</ul>
<ul>
<li>开始菜单搜索<strong>cmd</strong>，打开后输入 <strong>mmc（Microsoft 管理控制台）</strong></li>
<li><strong>文件</strong> -&gt; <strong>添加/删除管理单元</strong>，添加<strong>证书</strong>单元</li>
<li>证书单元的弹出窗口中选<strong>计算机账户</strong>，之后选<strong>本地计算机</strong>，确定</li>
<li>在左边的<strong>控制台根节点</strong>下选择<strong>证书</strong> -&gt; <strong>受信任的根证书颁发机构</strong> -&gt; <strong>证书</strong>，右键 -&gt; <strong>所有任务</strong> -&gt; <strong>导入</strong>打开证书导入窗口。</li>
<li>选择证书文件导入即可</li>
</ul>
<h5 id="VPN设置-3"><a href="#VPN设置-3" class="headerlink" title="VPN设置"></a>VPN设置</h5><h6 id="Win10-Win8"><a href="#Win10-Win8" class="headerlink" title="Win10/Win8"></a>Win10/Win8</h6><ul>
<li>配置位置: <strong>设置 -&gt; 网络和Internet -&gt; VPN -&gt; 添加VPN</strong></li>
<li>VPN提供商: Windows（内置）</li>
<li>连接名称: 任意</li>
<li>服务器名称或地址: VPN服务器URL或者IP地址</li>
<li>VPN类型: IKEv2</li>
<li>登录信息类型: 用户名和密码</li>
<li>用户名: Freeradius服务器配置</li>
<li>密码: Freeradius服务器配置</li>
</ul>
<h6 id="Win7"><a href="#Win7" class="headerlink" title="Win7"></a>Win7</h6><ul>
<li>配置位置: <strong>控制面板 -&gt; 网络和 Internet -&gt; 网络和共享中心 -&gt; 连接新的网络或连接 -&gt; 连接到工作区 -&gt; 创建新连接 -&gt; 使用我的Internet连接(VPN)</strong></li>
<li>Internet 地址: VPN服务器URL或者IP地址</li>
<li>目标名称: 任意</li>
<li>用户名: Freeradius服务器配置</li>
<li>密码: Freeradius服务器配置</li>
</ul>
<p>设置完毕后，先不连接</p>
<ul>
<li>配置位置: <strong>控制面板 -&gt; 网络和 Internet -&gt; 网络和共享中心 -&gt; 更改适配器设置</strong></li>
<li>在新建的 VPN 连接上右键<strong>属性</strong></li>
<li>切换到<strong>安全</strong>选项卡<ul>
<li>VPN 类型: IKEv2</li>
<li>数据加密选: 需要加密</li>
<li>身份验证: EAP-MSCHAP v2</li>
</ul>
</li>
</ul>
<p>然后选择连接VPN，win7/8/10连接界面可能不同，但是大同小异。</p>
<h4 id="Linux"><a href="#Linux" class="headerlink" title="Linux"></a>Linux</h4><p>Linux 的版本众多，认证方法与协议支持也非常丰富，详细方法请根据 Linux 版本查询连接方法。一般而言，Linux 通过 NetworkManager-strongswan。</p>
<hr>
<h3 id="6-IPsec-VPN配置"><a href="#6-IPsec-VPN配置" class="headerlink" title="6. IPsec VPN配置"></a>6. IPsec VPN配置</h3><h4 id="iOS-1"><a href="#iOS-1" class="headerlink" title="iOS"></a>iOS</h4><ul>
<li>配置位置: <strong>设置 -&gt; VPN -&gt; 添加配置 -&gt; IPSec</strong></li>
<li>描述: 任意</li>
<li>用户鉴定: 用户名</li>
<li>服务器: VPN服务器URL或者IP地址</li>
<li>用户名: Freeradius服务器配置</li>
<li>密码: Freeradius服务器配置</li>
<li>密钥: ipsec.secrets 中设置的 XAUTH 预共享密码</li>
</ul>
<h4 id="OS-X-1"><a href="#OS-X-1" class="headerlink" title="OS X"></a>OS X</h4><ul>
<li>配置位置: <strong>系统偏好设置 -&gt; 网络 -&gt;添加网络连接</strong></li>
<li>接口: VPN</li>
<li>VPN类型: IPsec/Cisco</li>
<li>服务器地址: 服务器URL或者IP地址</li>
<li>账户名称: Freeradius服务器配置</li>
<li>密码: Freeradius服务器配置</li>
<li>鉴定设置 -&gt; 共享的密钥: ipsec.secrets 中设置的 EAP 预共享密码</li>
</ul>
<h4 id="Android-1"><a href="#Android-1" class="headerlink" title="Android"></a>Android</h4><ul>
<li>配置位置: <strong>设置 -&gt; 其它连接方式 -&gt; VPN -&gt; 添加 VPN</strong></li>
<li>名称: 任意</li>
<li>服务器地址: 服务器URL或者IP地址</li>
<li>类型: IPSec Xauth PSK</li>
<li>IPsec 标识符: 不更改</li>
<li>预共享密钥: ipsec.secrets 中设置的 EAP 预共享密码</li>
<li>连接时账户名密码: Freeradius服务器配置</li>
</ul>
<h4 id="Linux-1"><a href="#Linux-1" class="headerlink" title="Linux"></a>Linux</h4><p>Linux 的版本众多，认证方法与协议支持也非常丰富，详细方法请根据 Linux 版本查询连接方法。一般而言，Linux 通过 NetworkManager-strongswan。</p>
<hr>
<h3 id="7-参考-amp-问题"><a href="#7-参考-amp-问题" class="headerlink" title="7. 参考 &amp; 问题"></a>7. 参考 &amp; 问题</h3><p><a href="https://wiki.strongswan.org/projects/strongswan/wiki/ConnSection" target="_blank" rel="external">https://wiki.strongswan.org/projects/strongswan/wiki/ConnSection</a></p>
<p><a href="https://blog.itnmg.net/centos7-ipsec-vpn/" target="_blank" rel="external">https://blog.itnmg.net/centos7-ipsec-vpn/</a></p>

        
      
    </div>

    
  </article>

    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2017/01/18/CentOS 6.x Freeradius 3.0.12编译安装/">CentOS 6.x Freeradius 3.0.12编译安装</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2017年1月18日
        </span>
      </div>
    </header>

    

    <div class="post-content">
      
        

        
          <h3 id="1-编译安装-Freeradius-3-0-12"><a href="#1-编译安装-Freeradius-3-0-12" class="headerlink" title="1.编译安装 Freeradius 3.0.12"></a>1.编译安装 Freeradius 3.0.12</h3><p>CentOS 6.x 通过yum只能安装Freeradius2，因此需要通过编译来安装Freeradius3</p>
<h4 id="1-1-环境准备"><a href="#1-1-环境准备" class="headerlink" title="1.1 环境准备"></a>1.1 环境准备</h4><p>需要安装一些包以及gcc、make工具<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">yum install -y gcc make mysql-devel libtalloc-devel</div></pre></td></tr></table></figure></p>
<h4 id="1-2-下载源码"><a href="#1-2-下载源码" class="headerlink" title="1.2 下载源码"></a>1.2 下载源码</h4><p>从<a href="http://freeradius.org/" target="_blank" rel="external">Freeradius官网</a>下载最新的源码到主机，然后解压并切换到解压后的目录</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">wget ftp://ftp.freeradius.org/pub/freeradius/freeradius-server-3.0.12.tar.bz2</div><div class="line">tar xvf freeradius-server-3.0.12.tar.bz2 </div><div class="line"><span class="built_in">cd</span> freeradius-server-3.0.12</div></pre></td></tr></table></figure>
<h4 id="1-3-配置安装"><a href="#1-3-配置安装" class="headerlink" title="1.3 配置安装"></a>1.3 配置安装</h4><p>进行配置，然安装，根据主机的性能而定，花费的时间不定<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">./configure</div><div class="line">make &amp;&amp; make install</div></pre></td></tr></table></figure></p>
<p>安装完成后，radius可执行文件的路径为<code>/usr/local/sbin</code>, 配置文件路径为<code>/usr/local/etc/raddb</code></p>
<h4 id="1-4-运行测试"><a href="#1-4-运行测试" class="headerlink" title="1.4 运行测试"></a>1.4 运行测试</h4><p>修改配置文件的安全选项，配置文件为<code>/usr/local/etc/raddb/radiusd.conf</code>，将<strong>allow_vulnerable_openssl</strong>选项改为<strong>yes</strong>，否则无法启动radius服务，会提示因为OpenSSL心脏滴血问题而无法启动。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">security &#123;</div><div class="line">   allow_vulnerable_openssl = yes</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>若不修改安全选项，则会报如下错误</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">Debugger not attached</div><div class="line">Refusing to start with libssl version OpenSSL 1.0.1e-fips 11 Feb 2013 0x1000105f (1.0.1e release) (<span class="keyword">in</span> range 1.0.1 release - 1.0.1t rele)</div><div class="line">Security advisory CVE-2016-6304 (OCSP status request extension)</div><div class="line">For more information see https://www.openssl.org/news/secadv/20160922.txt</div><div class="line">Once you have verified libssl has been correctly patched, <span class="built_in">set</span> security.allow_vulnerable_openssl = <span class="string">'CVE-2016-6304'</span></div><div class="line">Refusing to start with libssl version OpenSSL 1.0.1e-fips 11 Feb 2013 0x1000105f (1.0.1e release) (<span class="keyword">in</span> range 1.0.1 dev - 1.0.1f release)</div><div class="line">Security advisory CVE-2014-0160 (Heartbleed)</div><div class="line">For more information see http://heartbleed.com</div></pre></td></tr></table></figure>
<p>以debug模式运行radius，命令为<code>radius -X</code>，如果出现如下提示信息，说明radius服务在debug模式下运行成功，正在监听radius请求</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">Listening on auth address 127.0.0.1 port 18120 bound to server inner-tunnel</div><div class="line">Listening on auth address * port 1812 bound to server default</div><div class="line">Listening on acct address * port 1813 bound to server default</div><div class="line">Listening on auth address :: port 1812 bound to server default</div><div class="line">Listening on acct address :: port 1813 bound to server default</div><div class="line">Listening on proxy address * port 57298</div><div class="line">Listening on proxy address :: port 47250</div><div class="line">Ready to process requests</div></pre></td></tr></table></figure>
<p>如果要确认当前系统的OpenSSL是否已经打上心脏滴血的补丁，运行如下命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">rpm -q --changelog openssl | grep -i -E <span class="string">"CVE-2014-0160"</span></div></pre></td></tr></table></figure>
<hr>
<h3 id="2-MySQL设置"><a href="#2-MySQL设置" class="headerlink" title="2. MySQL设置"></a>2. MySQL设置</h3><h4 id="2-1-创建数据库-amp-用户"><a href="#2-1-创建数据库-amp-用户" class="headerlink" title="2.1 创建数据库&amp;用户"></a>2.1 创建数据库&amp;用户</h4><p>为Freeradius创建一个数据库，并创建一个用户将。以root登录mysql，创建<code>数据库radius</code>，创建<code>用户radius</code>，并将<code>数据库radius</code>所有权限赋予给<code>用户radiu</code>s，登录密码为<code>radpass</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">CREATE DATABASE radius;</div><div class="line">GRANT ALL PRIVILEGES ON radius.* TO radius@&quot;localhost&quot; IDENTIFIED BY &quot;radpass&quot;;</div><div class="line">flush privileges;</div></pre></td></tr></table></figure>
<h4 id="2-2-Navicat管理MySQL"><a href="#2-2-Navicat管理MySQL" class="headerlink" title="2.2 Navicat管理MySQL"></a>2.2 Navicat管理MySQL</h4><p>为方便管理MySQL，可以使用Navicat进行管理，则需要添加一个可以远程访问<code>数据库radius</code>的用户，如下添加一个<code>用户radcat</code>，密码为<code>radpass</code>，<code>radcat@&#39;%&#39;</code>代表可以从任何地点访问<code>数据库radius</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">GRANT ALL PRIVILEGES ON radius.* TO radcat@&apos;%&apos; IDENTIFIED BY &quot;radpass&quot;;</div><div class="line">flush privileges;</div></pre></td></tr></table></figure>
<p>可以控制navicat的权限粒度，例如只赋予某些表的查看权限</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">GRANT SELECT ON radius.radacct TO radcat@&apos;%&apos; IDENTIFIED BY &apos;radpass&apos;;</div><div class="line">flush privileges;</div></pre></td></tr></table></figure>
<h4 id="2-2-导入Freeradius数据库表格"><a href="#2-2-导入Freeradius数据库表格" class="headerlink" title="2.2 导入Freeradius数据库表格"></a>2.2 导入Freeradius数据库表格</h4><p>以用户root，或者以用户radius登录，选择数据库adius，导入Freeradius数据表格</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">use radius;</div><div class="line">SOURCE /usr/local/etc/raddb/mods-config/sql/main/mysql/schema.sql;</div><div class="line">exit；</div></pre></td></tr></table></figure>
<h4 id="2-3-增加表格列"><a href="#2-3-增加表格列" class="headerlink" title="2.3 增加表格列"></a>2.3 增加表格列</h4><p>因为个人需求，可以增加导入表的列，例如增加radcheck中条目的创建时间，自动记录每个用户的添加时间。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">alter table radcheck add column create_time timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP;</div></pre></td></tr></table></figure></p>
<h4 id="2-4-插入验证条目"><a href="#2-4-插入验证条目" class="headerlink" title="2.4 插入验证条目"></a>2.4 插入验证条目</h4><p>以命令行的方式添加测试用户</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">#账户账号密码</div><div class="line">insert into radcheck (username,attribute,op,value) values (&apos;test&apos;,&apos;Cleartext-Password&apos;,&apos;:=&apos;,&apos;test&apos;);</div><div class="line"></div><div class="line">#将test用户加入到test组中</div><div class="line">insert into radusergroup (username,groupname) values (&apos;test&apos;,&apos;test&apos;);</div></pre></td></tr></table></figure>
<p>或者使用Navicat以图形界面的方式添加测试用户</p>
<hr>
<h3 id="3-Freeradius配置"><a href="#3-Freeradius配置" class="headerlink" title="3. Freeradius配置"></a>3. Freeradius配置</h3><h4 id="3-1-启用mysql模块"><a href="#3-1-启用mysql模块" class="headerlink" title="3.1 启用mysql模块"></a>3.1 启用mysql模块</h4><p>执行如下命令，启用mysql模块<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/etc/raddb/mods-enabled</div><div class="line">ln <span class="_">-s</span> ../mods-available/sql</div></pre></td></tr></table></figure></p>
<p>编辑/etc/raddb/mods-available/sql，找到</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">dialect = <span class="string">"sqlite"</span></div><div class="line">driver = <span class="string">"rlm_sql_null"</span></div><div class="line">radius_db = <span class="string">"radius"</span></div><div class="line"><span class="comment">#server = "localhost"</span></div><div class="line"><span class="comment">#port = 3306</span></div><div class="line"><span class="comment">#login = "radius"</span></div><div class="line"><span class="comment">#password = "radiuspwd"</span></div><div class="line"><span class="comment">#read_clients =yes</span></div></pre></td></tr></table></figure>
<p>修改为如下，其中mysql账户为之被授权radius数据库的用户</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">dialect = <span class="string">"mysql"</span>                   <span class="comment">#选择mysql</span></div><div class="line">driver = <span class="string">"rlm_sql_mysql"</span>       <span class="comment">#选择mysql驱动</span></div><div class="line">server = <span class="string">"localhost"</span>               <span class="comment">#服务器地址</span></div><div class="line">port = 3306                           <span class="comment">#mysql端口号</span></div><div class="line">radius_db = <span class="string">"radius"</span>             <span class="comment">#所使用的数据库</span></div><div class="line">login = <span class="string">"radius"</span>                    <span class="comment">#mysql账户</span></div><div class="line">password = <span class="string">"radpass"</span>          <span class="comment">#mysql账户密码</span></div><div class="line">read_clients =yes</div></pre></td></tr></table></figure>
<h4 id="3-2-NAS客户端添加"><a href="#3-2-NAS客户端添加" class="headerlink" title="3.2 NAS客户端添加"></a>3.2 NAS客户端添加</h4><p>默认已经添加了本地机器为NAS客户端。若添加其他NAS客户端设置如下，修改<code>/usr/local/etc/raddb/clients.conf</code>，添加如下<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">client ovzinp &#123;     </div><div class="line">    ipaddr = 1.2.2.2                            <span class="comment">#客户端地址</span></div><div class="line">    secret= testing1234                     <span class="comment">#与客户端之间使用的暗码</span></div><div class="line">    require_message_authenticator = no</div><div class="line">    nastype = other </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>NAS客户端的设置可能有些不同，但是大同小异，都要填写Freeradius服务器的URL或者IP地址，以及上文的暗码。</p>
<h4 id="3-3-iptables配置"><a href="#3-3-iptables配置" class="headerlink" title="3.3 iptables配置"></a>3.3 iptables配置</h4><p>需要在iptables上开放1812、1813 UDP端口<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">iptables -I INPUT 2 -p udp --dport 1812:1813 -j ACCEPT</div></pre></td></tr></table></figure></p>
<hr>
<h3 id="4-Freeradius服务器测试-amp-运行"><a href="#4-Freeradius服务器测试-amp-运行" class="headerlink" title="4. Freeradius服务器测试&amp;运行"></a>4. Freeradius服务器测试&amp;运行</h3><h4 id="4-1-Freeradius调试"><a href="#4-1-Freeradius调试" class="headerlink" title="4.1 Freeradius调试"></a>4.1 Freeradius调试</h4><p>命令行下使用<code>radiusd -X</code>开启debug模式，然后打开另一个终端，使用测试账户测试，命令如下<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">radtest <span class="built_in">test</span> <span class="built_in">test</span> localhost 0 testing123</div></pre></td></tr></table></figure></p>
<ul>
<li>test：账户名</li>
<li>test：密码</li>
<li>localhost：Freeradius服务器地址，代表本地</li>
<li>testing123：与Freeradius之间的共享密钥，在Freeradius服务器的配置目录下的raddb/clients.conf中定义，实际生产环境暗码需要设置很长而且复杂</li>
</ul>
<h4 id="4-2-Freeradius运行"><a href="#4-2-Freeradius运行" class="headerlink" title="4.2 Freeradius运行"></a>4.2 Freeradius运行</h4><p>若debug模式测试完毕，则可以正常启动radius，使用如下命令启动radius服务，如果要终止服务，通过kill命令来杀掉radius的服务进程</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">radiusd</div></pre></td></tr></table></figure>
<hr>
<h3 id="5-流量限制模块添加"><a href="#5-流量限制模块添加" class="headerlink" title="5. 流量限制模块添加"></a>5. 流量限制模块添加</h3><h4 id="5-1-启用sqlcounter模块"><a href="#5-1-启用sqlcounter模块" class="headerlink" title="5.1 启用sqlcounter模块"></a>5.1 启用sqlcounter模块</h4><p>切换到<code>/usr/local/etc/raddb/mods-enabled</code>下，启用sqlcounter模块</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/etc/raddb/mods-enabled</div><div class="line">ln <span class="_">-s</span> ../mods-available/sqlcounter</div></pre></td></tr></table></figure>
<h4 id="5-2-添加自定义模块"><a href="#5-2-添加自定义模块" class="headerlink" title="5.2 添加自定义模块"></a>5.2 添加自定义模块</h4><p>编辑sqlcounter，添加如下每月流量限制模块<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">sqlcounter monthlytrafficcounter &#123;          <span class="comment">#counter名字</span></div><div class="line">    sql_module_instance = sql            </div><div class="line">    dialect = <span class="variable">$&#123;modules.sql.dialect&#125;</span></div><div class="line">    counter_name = Monthly-Traffic          <span class="comment">#任意名字</span></div><div class="line">    check_name = Max-Monthly-Traffic     <span class="comment">#检查字段，这个字段的临界值要在radcheck或者radcheckgroup表中设置</span></div><div class="line">    reply_name = Monthly-Traffic-Limit   </div><div class="line">    key = User-Name                                 <span class="comment">#控制粒度，一般是用户</span></div><div class="line">    reset = monthly				       <span class="comment">#时间周期，这里设置为每月</span></div><div class="line">    <span class="variable">$INCLUDE</span> <span class="variable">$&#123;modconfdir&#125;</span>/sql/counter/<span class="variable">$&#123;dialect&#125;</span>/<span class="variable">$&#123;.:instance&#125;</span>.conf       <span class="comment">#配置文件目录</span></div><div class="line"> &#125;</div></pre></td></tr></table></figure></p>
<p>设置SQL语句，在<code>/etc/raddb/mods-config/sql/counter/mysql</code>目录下，创建monthlytrafficcounter.conf文件，注意，这个文件名是与之前的counter名字对应的。其中</p>
<ul>
<li>%{${key}}为上面设置的key</li>
<li>%b为每个周期的第一天</li>
<li>%e为每个周期的最后一天，这里只用到了第一天</li>
<li>Freeradius流量按照字节（byte）统计，所以统计结果除以1048576（1024*1024），正好是1MB，则在数据库里可以直接按照MB统计，而不是字节。<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">query = "\</div><div class="line">    <span class="keyword">SELECT</span> <span class="keyword">SUM</span>(acctinputoctets + acctoutputoctets) <span class="keyword">DIV</span> <span class="number">1048576</span> \</div><div class="line">	<span class="keyword">FROM</span> radacct \</div><div class="line">    <span class="keyword">WHERE</span> UserName=<span class="string">'%&#123;$&#123;key&#125;&#125;'</span> \ </div><div class="line">    <span class="keyword">AND</span> <span class="keyword">UNIX_TIMESTAMP</span>(AcctStartTime) &gt; <span class="string">'%b'</span><span class="string">"</span></div></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="5-3-授权启用自定义模块"><a href="#5-3-授权启用自定义模块" class="headerlink" title="5.3 授权启用自定义模块"></a>5.3 授权启用自定义模块</h4><p>修改<code>/usrlocal/etc/raddb/sites-available/default</code>，找到authorize字段，启用自定义模块。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">authorize &#123;</div><div class="line">	monthlytrafficcounter</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="5-4-字典修改"><a href="#5-4-字典修改" class="headerlink" title="5.4 字典修改"></a>5.4 字典修改</h4><p>修改<code>/usr/local/etc/dictionary</code>,添加如下两行，这两个变量在sqlcounter中提到过。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">ATTRIBUTE Max-Monthly-Traffic 3003 <span class="built_in">integer</span></div><div class="line">ATTRIBUTE Monthly-Traffic-Limit 3004 <span class="built_in">integer</span></div></pre></td></tr></table></figure></p>
<h4 id="5-5-SQL语句插入"><a href="#5-5-SQL语句插入" class="headerlink" title="5.5 SQL语句插入"></a>5.5 SQL语句插入</h4><p>插入如下语句，则test用户组下的所用用户流量上限是1MB。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">insert into radgroupcheck (groupname,attribute,op,value) VALUES (&apos;test&apos;,&apos;Max-Monthly-Traffic&apos;,&apos;:=&apos;,&apos;1&apos;);</div></pre></td></tr></table></figure></p>
<p>统计数据是在每次登陆时检查,因此使用过程中超流量不会强制下线，而是在下一次登陆时被拒绝。</p>
<h4 id="5-6-服务重启"><a href="#5-6-服务重启" class="headerlink" title="5.6 服务重启"></a>5.6 服务重启</h4><p>因为添加了新的模块，所以要手动杀掉radius进程然后重新启动radius</p>

        
      
    </div>

    
  </article>

    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2017/01/18/CentOS 6.x ocserv安装/">CentOS 6.x ocserv 安装</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2017年1月18日
        </span>
      </div>
    </header>

    

    <div class="post-content">
      
        

        
          <h3 id="1-ocserv"><a href="#1-ocserv" class="headerlink" title="1. ocserv"></a>1. ocserv</h3><h4 id="1-1-介绍"><a href="#1-1-介绍" class="headerlink" title="1.1 介绍"></a>1.1 介绍</h4><p>OpenConnect server (ocserv)以一款SSL VPN服务。它的目的是构建安全、小巧、快速以及容易配置的VPN服务器。它实现了OpenConnect SSL VPN协议，并且也兼容AnyConnect SSL VPN协议客户端。OpenConnect协议提供了基于TCP/UDP的双重VPN隧道，使用标准的IETF加密协议。该服务主要面向GNU/Linux平台。</p>
<h4 id="1-2-yum安装ocserv"><a href="#1-2-yum安装ocserv" class="headerlink" title="1.2 yum安装ocserv"></a>1.2 yum安装ocserv</h4><p>现在可以使用yum安装ocserv</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">yum install -y epel-release</div><div class="line">yum install -y ocserv</div></pre></td></tr></table></figure>
<hr>
<h3 id="2-证书安装"><a href="#2-证书安装" class="headerlink" title="2. 证书安装"></a>2. 证书安装</h3><h4 id="2-1-配置文件夹创建"><a href="#2-1-配置文件夹创建" class="headerlink" title="2.1 配置文件夹创建"></a>2.1 配置文件夹创建</h4><p>ocserv服务的启动需要相关证书，为了方便管理，首先在配置文件夹中创建一些文件夹</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">mkdir -p /etc/ocserv/ssl/private          <span class="comment">#保存服务器私钥</span></div><div class="line">mkdir -p /etc/ocserv/ssl/ca                 <span class="comment">#保存CA</span></div><div class="line">mkdir -p /etc/ocserv/ssl/server           <span class="comment">#保存服务器证书</span></div><div class="line">mkdir -p /etc/ocserv/ssl/user              <span class="comment">#保存用户证书</span></div><div class="line">mkdir -p /etc/ocserv/ssl/crl                 <span class="comment">#保存用户吊销证书链</span></div></pre></td></tr></table></figure>
<h4 id="2-2-使用自签证书"><a href="#2-2-使用自签证书" class="headerlink" title="2.2 使用自签证书"></a>2.2 使用自签证书</h4><h5 id="2-2-1-CA证书生成"><a href="#2-2-1-CA证书生成" class="headerlink" title="2.2.1 CA证书生成"></a>2.2.1 CA证书生成</h5><p>生成CA私钥</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">cd</span> /etc/ocserv/ssl/private</div><div class="line">certtool --generate-privkey --outfile ca-key.pem</div></pre></td></tr></table></figure>
<p>生成CA模板，cn和o选项填入任意域名，本文以test.com代替。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">cd</span> /etc/ocserv/ssl/ca</div><div class="line">cat &lt;&lt; EOF &gt; ca.tmpl</div><div class="line">cn = <span class="string">"test.com"</span></div><div class="line">organization = <span class="string">"test.com"</span></div><div class="line">serial = 1</div><div class="line">expiration_days = 3650</div><div class="line">ca</div><div class="line">signing_key</div><div class="line">cert_signing_key</div><div class="line">crl_signing_key</div><div class="line">EOF</div></pre></td></tr></table></figure>
<p>CA证书生成</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">certtool --generate-self-signed --load-privkey ../private/ca-key.pem --template \</div><div class="line">ca.tmpl --outfile ca-cert.pem</div></pre></td></tr></table></figure>
<h5 id="2-2-2-Server证书生成"><a href="#2-2-2-Server证书生成" class="headerlink" title="2.2.2 Server证书生成"></a>2.2.2 Server证书生成</h5><p>生成Server私钥</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">cd</span> /etc/ocserv/ssl/private</div><div class="line">certtool --generate-privkey --outfile server-key.pem</div></pre></td></tr></table></figure>
<p>生成Server证书模板，cn和o选项填入ocserv服务器的域名，本文以test.com代替。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">cd</span> /etc/ocserv/ssl/server</div><div class="line">cat &lt;&lt; EOF &gt; server.tmpl</div><div class="line">cn = <span class="string">"test.com"</span></div><div class="line">organization = <span class="string">"test.com"</span></div><div class="line">expiration_days = 3650</div><div class="line">signing_key</div><div class="line">encryption_key </div><div class="line">tls_www_server</div><div class="line">EOF</div></pre></td></tr></table></figure>
<p>生成Server证书：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">certtool --generate-certificate --load-privkey ../private/server-key.pem  \</div><div class="line">--load-ca-certificate ../ca/ca-cert.pem --load-ca-privkey ../private/ca-key.pem \</div><div class="line">--template server.tmpl --outfile server-cert.pem</div></pre></td></tr></table></figure>
<h4 id="2-3-使用授权证书"><a href="#2-3-使用授权证书" class="headerlink" title="2.3 使用授权证书"></a>2.3 使用授权证书</h4><h5 id="2-3-1-申请证书"><a href="#2-3-1-申请证书" class="headerlink" title="2.3.1 申请证书"></a>2.3.1 申请证书</h5><p>授权证书可以从<a href="https://buy.wosign.com/" target="_blank" rel="external">沃通</a>或者<a href="https://startssl.com" target="_blank" rel="external">startssl</a>、<a href="https://letsencrypt.org/" target="_blank" rel="external">Let’s Encrypt</a>等申请免费的ssl证书。申请证书的大概流程为：</p>
<ul>
<li>CSR文件为请求证书的文件，会产生一对公私钥，公钥（pub-key）需要上传给证书颁发结构，私钥（private-key）则要自己保留不能泄露。</li>
<li>证书颁发结构需要要验证申请人的域名拥有权，证明域名拥有权之后，使用其私钥（signature private-key）申请人上传的pub-lkey进行签名，并把域名等证书信息追加到其中，产生一个证书，例如<code>2_dovzinp3.icean.me.crt</code></li>
<li>终端用户并不信任这个证书，鉴于这个证书不是权威机构颁发，所以需要证书链，来证明颁发该证书的结构是权威机构认证的。</li>
<li>证书链为颁发<code>2_dovzinp3.icean.me.crt</code>证书的结构，其上级机构对其公钥进行签名，逐级进行签名，直到顶级CA。</li>
</ul>
<h5 id="2-3-2-安装证书"><a href="#2-3-2-安装证书" class="headerlink" title="2.3.2 安装证书"></a>2.3.2 安装证书</h5><p>下载证书的压缩文件包中，解压OtherServer，以startssl为例子，解压出如下图所示。</p>
<center><img src="http://i.imgur.com/aUSEeOG.png" alt=""></center>

<center style="color:purple"><strong>图2-1 授权证书</strong></center>

<p>服务器私钥为生成CSR文件所用的私钥</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">mv xxx.key server-key.pem</div><div class="line">mv server-key.pem /etc/ocserv/ssl/private</div></pre></td></tr></table></figure>
<p>创建服务器证书，根据证书链的顺序，首先追加服务器证书，然后追加中间证书，最后追加CA证书。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">cat 2_dovzinp3.icean.me.crt &gt;&gt; server-cert.pem</div><div class="line">cat 1_Intermediate.crt &gt;&gt; server-cert.pem</div><div class="line">cat root.crt &gt;&gt; server-cert.pem</div><div class="line">mv server-cert.pem /etc/ocserv/ssl/server</div></pre></td></tr></table></figure>
<hr>
<h3 id="3-主要配置"><a href="#3-主要配置" class="headerlink" title="3. 主要配置"></a>3. 主要配置</h3><h4 id="3-1-配置文件备份-amp-修改"><a href="#3-1-配置文件备份-amp-修改" class="headerlink" title="3.1 配置文件备份&amp;修改"></a>3.1 配置文件备份&amp;修改</h4><p>备份原配置文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">cd</span> /etc/ocserv</div><div class="line">mv ocserv.conf ocserv.conf.bak</div></pre></td></tr></table></figure>
<p>创建新的配置文件<code>ocserv.conf</code>，内容如下，缺省验证方式为账户密码验证</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">auth = <span class="string">"plain[/etc/ocserv/passwd]"</span>                                            <span class="comment">#本地账户密码验证      </span></div><div class="line"><span class="comment">#auth = "certificate"                                                                    #证书验证</span></div><div class="line"><span class="comment">#auth = "radius[config=/etc/radcli/radiusclient.conf,groupconfig=true]"  </span></div><div class="line">                                                                                                     <span class="comment">#radius验证</span></div><div class="line"><span class="comment">#acct = "radius[config=/etc/radcli/radiusclient.conf]"                #radius审计</span></div><div class="line"></div><div class="line">stats-report-time = 360                                                               <span class="comment">#发送审计报告时间间隔</span></div><div class="line">max-clients = 16</div><div class="line">max-same-clients = 1</div><div class="line">tcp-port = 443                                                                            <span class="comment">#连接端口号，可以修改为其他端口</span></div><div class="line">udp-port = 443                                                                           <span class="comment">#连接端口号，可以修改为其他端口</span></div><div class="line">keepalive = 32400</div><div class="line">dpd = 90</div><div class="line">mobile-dpd = 1800</div><div class="line">try-mtu-discovery = <span class="literal">true</span></div><div class="line">cisco-client-compat = <span class="literal">true</span></div><div class="line"><span class="comment">#ca-cert /etc/ocserv/ssl/ca/ca-cert.pem                                      #CA证书路径</span></div><div class="line">server-cert = /etc/ocserv/ssl/server/server-cert.pem                  <span class="comment">#服务器证书存储路径</span></div><div class="line">server-key = /etc/ocserv/ssl/private/server-key.pem                  <span class="comment">#服务器私钥存储路径</span></div><div class="line"><span class="comment">#crl = /etc/ocserv/ssl/crl/crl.pem                                                 #吊销证书链</span></div><div class="line">auth-timeout = 40</div><div class="line">pid-file = /var/run/ocserv.pid</div><div class="line">socket-file = /var/run/ocserv-socket</div><div class="line">run-as-user = nobody</div><div class="line">run-as-group = daemon</div><div class="line">device = vpns</div><div class="line">ipv4-network = 192.168.80.0                                                       <span class="comment">#虚拟IP地址段，分配给VPN客户端</span></div><div class="line">ipv4-netmask = 255.255.255.0                                                    <span class="comment">#虚拟IP掩码</span></div><div class="line">dns = 8.8.8.8                                                                                <span class="comment">#DNS地址</span></div><div class="line">dns = 8.8.4.4</div><div class="line"></div><div class="line"><span class="comment">#no-route = 1.0.0.0/255.192.0.0                                                   #不路由某些地址</span></div><div class="line"><span class="comment">#route = 1.64.0.0/255.224.0.0                                                      #只路由某些地址，no-route和route不可同时用</span></div></pre></td></tr></table></figure>
<h4 id="3-2-route-amp-no-route"><a href="#3-2-route-amp-no-route" class="headerlink" title="3.2 route &amp; no-route"></a>3.2 route &amp; no-route</h4><p>如果需要指定客户端只能路由到某些地址，则需要在配置文件<code>ocserv.conf</code>中添加如下样例</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">route = 192.168.1.0/255.255.255.0</div></pre></td></tr></table></figure>
<p>如果需要指定客户端不需要路由到某些地址，则需要在配置文件<code>ocserv.conf</code>中添加如下样例</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">no-route = 192.168.1.0/255.255.255.0</div></pre></td></tr></table></figure>
<p>两者不可同时使用</p>
<h4 id="3-3-账户密码验证"><a href="#3-3-账户密码验证" class="headerlink" title="3.3 账户密码验证"></a>3.3 账户密码验证</h4><p>在配置文件<code>ocserv.conf</code>中修改，如下所示</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">auth = <span class="string">"plain[/etc/ocserv/passwd]"</span>  </div><div class="line"><span class="comment">#auth = "certificate" </span></div><div class="line"><span class="comment">#auth = "radius[config=/etc/radcli/radiusclient.conf,groupconfig=true]"  </span></div><div class="line"><span class="comment">#acct = "radius[config=/etc/radcli/radiusclient.conf]"   </span></div><div class="line">.......</div></pre></td></tr></table></figure>
<p>创建登录用户以及密码，每次创建用户，都需要参数c</p>
<pre><code>ocpasswd -c /etc/ocserv/passwd username
</code></pre><h4 id="3-4-radius验证"><a href="#3-4-radius验证" class="headerlink" title="3.4 radius验证"></a>3.4 radius验证</h4><p>在配置文件中<code>ocserv.conf</code>修改如下, 其中radius客户端配置路径为<code>/etc/radcli</code>，在安装ocserv时候，radcli作为依赖被安装</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#auth = "plain[/etc/ocserv/passwd]"  </span></div><div class="line"><span class="comment">#auth = "certificate" </span></div><div class="line">auth = <span class="string">"radius[config=/etc/radcli/radiusclient.conf,groupconfig=true]"</span>  </div><div class="line">acct = <span class="string">"radius[config=/etc/radcli/radiusclient.conf]"</span>   </div><div class="line">.......</div></pre></td></tr></table></figure>
<p>添加radius服务器，修改<code>/etc/radcli/servers</code>，例如添加本机作为radius服务器，如下所示。也可以按照格式添加其他的radius服务器</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">localhost/localhost  testing123   <span class="comment">#验证服务器/审计服务器  服务器暗码</span></div></pre></td></tr></table></figure>
<p>修改配置文件<code>/etc/radcli/radiusclient.conf</code>，选择要使用的验证服务器以及审计服务器，如下为使用localhost作为验证和审计服务器，其他选项不需要修改。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">authserver  localhost</div><div class="line">acctserver  localhost</div></pre></td></tr></table></figure>
<h4 id="3-5-证书验证"><a href="#3-5-证书验证" class="headerlink" title="3.5 证书验证"></a>3.5 证书验证</h4><h5 id="3-5-1-用户证书生成"><a href="#3-5-1-用户证书生成" class="headerlink" title="3.5.1 用户证书生成"></a>3.5.1 用户证书生成</h5><p>使用账户密码以及radius验证，接入的客户端需要每次输入账户名和密码，而证书验证则不需要每次输入账户名和密码。第一次在客户端导入证书即可。</p>
<p>使用certtool生成用户私钥</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">cd</span> /etc/ocserv/ssl/private</div><div class="line">certtool --generate-privkey --outfile user-key.pem</div></pre></td></tr></table></figure>
<p>创建用户模板</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">cat &lt;&lt; EOF &gt; user.tmpl</div><div class="line">cn = <span class="string">"example-cn"</span></div><div class="line">unit = <span class="string">"example-unit"</span></div><div class="line">expiration_days = 365</div><div class="line">signing_key</div><div class="line">tls_www_client</div><div class="line">EOF</div></pre></td></tr></table></figure>
<p>生成用户证书</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#生成用户证书</span></div><div class="line"><span class="built_in">cd</span>  /etc/ocserv/ssl/user</div><div class="line">certtool --generate-certificate --load-privkey ../private/user-key.pem \</div><div class="line">--load-ca-certificate ca-cert.pem --load-ca-privkey ../private/ca-key.pem \</div><div class="line">--template user.tmpl --outfile user-cert.pem</div><div class="line"></div><div class="line"><span class="comment">#将用户证书和密钥打包为p12格式，在此过程中，需要输入名称和密码，在安装证书时，需要输入该密码进行验证。</span></div><div class="line">certtool --to-p12 --load-privkey ../private/user-key.pem --pkcs-cipher \ </div><div class="line">3des-pkcs12 --load-certificate user-cert.pem --outfile user-cert.p12 --outder</div></pre></td></tr></table></figure>
<p>自动生成证书脚本，运行下面脚本之前，请确认当前目录下有<code>user.tmpl</code>，<code>ca-key.pem</code>，<code>ca-cert.pem</code>三个文件，或者自己命令中的路径参数。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#!/bin/bash</span></div><div class="line"></div><div class="line"><span class="comment">#定义变量</span></div><div class="line">id=<span class="built_in">test</span></div><div class="line">day=365</div><div class="line"></div><div class="line"><span class="built_in">cd</span>  /etc/ocserv/ssl/user</div><div class="line">cp user.tmpl <span class="variable">$id</span>.tmpl</div><div class="line">sed -i <span class="string">"s/example-cn/<span class="variable">$id</span>/g"</span> <span class="variable">$id</span>.tmpl</div><div class="line">sed -i <span class="string">"s/example-unit/<span class="variable">$id</span>/g"</span> <span class="variable">$id</span>.tmpl</div><div class="line">sed -i <span class="string">"s/365/<span class="variable">$day</span>/g"</span> <span class="variable">$id</span>.tmpl</div><div class="line">certtool --generate-privkey --outfile <span class="variable">$id</span>-key.pem</div><div class="line">certtool --generate-certificate --load-privkey <span class="variable">$id</span>-key.pem \</div><div class="line">--load-ca-certificate ca-cert.pem --load-ca-privkey ca-key.pem \</div><div class="line">--template <span class="variable">$id</span>.tmpl --outfile <span class="variable">$id</span>-cert.pem</div><div class="line">certtool --to-p12 --load-privkey <span class="variable">$id</span>-key.pem --pkcs-cipher 3des-pkcs12 \</div><div class="line">--load-certificate <span class="variable">$id</span>-cert.pem --outfile <span class="variable">$id</span>-cert.p12 --outder</div><div class="line"></div><div class="line"><span class="comment">#最后所有相关的文件放入名字为$id的文件夹中</span></div><div class="line">mkdir <span class="variable">$id</span></div><div class="line">mv <span class="variable">$id</span>* <span class="variable">$id</span></div></pre></td></tr></table></figure>
<h5 id="3-5-2-用户证书吊销"><a href="#3-5-2-用户证书吊销" class="headerlink" title="3.5.2 用户证书吊销"></a>3.5.2 用户证书吊销</h5><p>创建空吊销列表文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">cd</span> /etc/ocserv/ssl/crl</div><div class="line">touch revoked.pem</div></pre></td></tr></table></figure>
<p>创建吊销证书模板</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">cat &lt;&lt; EOF &gt; crl.tmpl</div><div class="line">crl_next_update = 9999</div><div class="line">crl_number = 1</div><div class="line">EOF</div></pre></td></tr></table></figure>
<p>创建空的吊销列表，当<code>revoked.pem</code>为空时，执行如下命令生成吊销证书链文件<code>crl.pem</code>。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">certtool --generate-crl --load-ca-privkey ../private/ca-key.pem \</div><div class="line">--load-ca-certificate ../ca/ca-cert.pem --template crl.tmpl --outfile crl.pem</div></pre></td></tr></table></figure>
<p>吊销一个用户，假设要吊销用户证书为user1，首先将其用户证书追加到<code>revoked.pem</code>，然后生成新的吊销证书链文件<code>crl.pem</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">cd</span> /etc/ocserv/ssl/crl</div><div class="line">cat ../user/user1/user1-cert.pem &gt;&gt; revoked.pem</div><div class="line">certtool --generate-crl --load-ca-privkey ../private/ca-key.pem \</div><div class="line">--load-ca-certificate ../ca/ca-cert.pem --load-certificate revoked.pem \</div><div class="line">--template crl.tmpl --outfile crl.pem</div></pre></td></tr></table></figure>
<p>若想重新启用一个被吊销的用户，则需要删除<code>revoked.pem</code>其中对应用户证书的密钥，然后重新生成吊销证书链文件<code>crl.pem</code>，若revoke.pem被清空，则生成的时候不添加<code>--load-certificate</code>参数</p>
<p>完整CA添加/吊销/重新启用脚本请点击<a href="http://pan.baidu.com/s/1o7Z55Om" target="_blank" rel="external">这里</a></p>
<hr>
<h3 id="4-ocserv服务启动"><a href="#4-ocserv服务启动" class="headerlink" title="4. ocserv服务启动"></a>4. ocserv服务启动</h3><h4 id="4-1-开启系统转发"><a href="#4-1-开启系统转发" class="headerlink" title="4.1 开启系统转发"></a>4.1 开启系统转发</h4><p>编译/etc/sysctl.conf，开启IPv4转发，启用此项</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">net.ipv4.ip_forward=1</div></pre></td></tr></table></figure>
<p>并刷新配置</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sysctl -p /etc/sysctl.conf</div></pre></td></tr></table></figure>
<h4 id="4-2-iptables配置"><a href="#4-2-iptables配置" class="headerlink" title="4.2 iptables配置"></a>4.2 iptables配置</h4><p>添加条目到iptables，端口号为配置文件定义的，下面以443为例，同时添加转发表条目</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">iptables -I INPUT 1 -p tcp --dport 443 -j ACCEPT</div><div class="line">iptables -I INPUT 1 -p udp --dport 443 -j ACCEPT</div><div class="line">iptables -I FORWARD 1  -j ACCEPT</div></pre></td></tr></table></figure>
<p>根据需要，设定要访问的网络，例如如果要VPN终端用户要访问服务器eth0网段的网卡，则添加如下条目，访问eth1的添加规则类似</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">iptables -t nat -A POSTROUTING <span class="_">-s</span>  192.168.80.0/24 -o eth0 -j MASQUERADE</div></pre></td></tr></table></figure>
<p>保存并重启iptables</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">service iptables save</div><div class="line">service iptables restart</div></pre></td></tr></table></figure>
<h4 id="4-3-ocserv服务启动"><a href="#4-3-ocserv服务启动" class="headerlink" title="4.3 ocserv服务启动"></a>4.3 ocserv服务启动</h4><p>启动ocserv服务，然后终端用户可以通过思科Anyconnect客户端进行连接。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">service ocserv start</div></pre></td></tr></table></figure>

        
      
    </div>

    
  </article>

    
  </section>

  
  <nav class="pagination">
    
    
      <a class="next" href="/page/2/">
        <span class="next-text">下一页</span>
        <i class="iconfont icon-right"></i>
      </a>
    
  </nav>


          </div>
          
        </div>  
      </main>

      <footer id="footer" class="footer">
  <div class="social-links">
    
      
        
          <a href="mailto:mailto:iceanness@gmail.com" class="iconfont icon-email" title="email"></a>
        
      
    
      
    
      
        
          <a href="https://twitter.com/Iceanian" class="iconfont icon-twitter" title="twitter"></a>
        
      
    
      
    
      
        
          <a href="https://github.com/icean" class="iconfont icon-github" title="github"></a>
        
      
    
      
        
          <a href="http://weibo.com/1509230644" class="iconfont icon-weibo" title="weibo"></a>
        
      
    
      
    
    
    
  </div>


<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://hexo.io/">Hexo</a> 强力驱动
  </span>
  
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/ahonn/hexo-theme-even">Even</a>
  </span>

  <span class="copyright-year">
    
    &copy; 
     
      2015 - 
    
    2017

    <span class="heart">
      <! --<i class="iconfont icon-heart"></i>
    </span>
    <span class="author">Icean L</span>
  </span>
</div>
      </footer>

      <div class="back-to-top" id="back-to-top">
        <i class="iconfont icon-up"></i>
      </div>
    </div>

    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"kompass"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>


    
  





  
    <script type="text/javascript" src="/lib/jquery/jquery-3.1.1.min.js"></script>
  

  
    <script type="text/javascript" src="/lib/fancybox/jquery.fancybox.pack.js"></script>
  

    <script type="text/javascript" src="/js/src/even.js?v=2.1.x"></script>
<script type="text/javascript" src="/js/src/bootstrap.js?v=2.1.x"></script>

    <!-- <script src="http://code.jquery.com/jquery-1.9.1.js"></script>
    <script src="/plugins/prettify/prettify.js" type="text/javascript"></script>
    <script type="text/javascript">
      $(window).load(function(){
      $('pre').addClass('prettyprint linenums').attr('style', 'overflow:auto;');
      prettyPrint();
    }) 
    </script> -->
  </body>

</html>